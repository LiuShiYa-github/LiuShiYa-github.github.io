<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>最帅男子天团运维面板</title>
      <link href="/2020/06/10/%E6%9C%80%E5%B8%85%E7%94%B7%E5%AD%90%E5%A4%A9%E5%9B%A2%E8%BF%90%E7%BB%B4%E9%9D%A2%E6%9D%BF/"/>
      <url>/2020/06/10/%E6%9C%80%E5%B8%85%E7%94%B7%E5%AD%90%E5%A4%A9%E5%9B%A2%E8%BF%90%E7%BB%B4%E9%9D%A2%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<h1>最帅男子天团运维面板</h1><h2 id="主持人-张鹤伦">主持人 张鹤伦</h2><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTcxNTcyOC8yMDIwMDYvMTcxNTcyOC0yMDIwMDYxMDEzNTIzNTc5NC01NTQyNDEyMDUuanBn?x-oss-process=image/format,png" alt=""></p><p><img src="https://img2020.cnblogs.com/blog/1715728/202006/1715728-20200613124355307-984607189.jpg" alt=""></p><p><img src="https://img2020.cnblogs.com/blog/1715728/202006/1715728-20200613124402144-1581931895.jpg" alt=""><br><img src="https://img2020.cnblogs.com/blog/1715728/202006/1715728-20200613163513105-811444286.jpg" alt=""><br><img src="https://img2020.cnblogs.com/blog/1715728/202006/1715728-20200615101512910-1308363657.jpg" alt=""><br><img src="https://img2020.cnblogs.com/blog/1715728/202006/1715728-20200615135131071-628114888.jpg" alt=""></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kubectl常用命令</title>
      <link href="/2020/06/09/kubectl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2020/06/09/kubectl%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看所有 pod 列表,  -n 后跟 namespace, 查看指定的命名空间</span><br>kubectl get pod<br>kubectl get pod -n kube  <br>kubectl get pod -o wide<br><br><br><span class="hljs-comment"># 查看 RC 和 service 列表， -o wide 查看详细信息</span><br>kubectl get rc,svc<br>kubectl get pod,svc -o wide  <br>kubectl get pod &lt;pod-name&gt; -o yaml<br><br><br><span class="hljs-comment"># 显示 Node 的详细信息</span><br>kubectl describe node 192.168.0.212<br><br><br><span class="hljs-comment"># 显示 Pod 的详细信息, 特别是查看 pod 无法创建的时候的日志</span><br>kubectl describe pod &lt;pod-name&gt;<br>eg:<br>kubectl describe pod redis-master-tqds9<br><br><br><span class="hljs-comment"># 根据 yaml 创建资源, apply 可以重复执行，create 不行</span><br>kubectl create -f pod.yaml<br>kubectl apply -f pod.yaml<br><br><br><span class="hljs-comment"># 基于 pod.yaml 定义的名称删除 pod </span><br>kubectl delete -f pod.yaml <br><br><br><span class="hljs-comment"># 删除所有包含某个 label 的pod 和 service</span><br>kubectl delete pod,svc -l name=&lt;label-name&gt;<br><br><br><span class="hljs-comment"># 删除所有 Pod</span><br>kubectl delete pod --all<br><br><br><span class="hljs-comment"># 查看 endpoint 列表</span><br>kubectl get endpoints<br><br><br><span class="hljs-comment"># 执行 pod 的 date 命令</span><br>kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- date<br>kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- bash<br>kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- ping 10.24.51.9<br><br><br><span class="hljs-comment"># 通过bash获得 pod 中某个容器的TTY，相当于登录容器</span><br>kubectl <span class="hljs-built_in">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- bash<br>eg:<br>kubectl <span class="hljs-built_in">exec</span> -it redis-master-cln81 -- bash<br><br><br><span class="hljs-comment"># 查看容器的日志</span><br>kubectl logs &lt;pod-name&gt;<br>kubectl logs -f &lt;pod-name&gt; <span class="hljs-comment"># 实时查看日志</span><br>kubectl <span class="hljs-built_in">log</span>  &lt;pod-name&gt;  -c &lt;container_name&gt; <span class="hljs-comment"># 若 pod 只有一个容器，可以不加 -c </span><br><br><br><span class="hljs-comment"># 查看注释</span><br>kubectl explain pod<br>kubectl explain pod.apiVersion<br><br><span class="hljs-comment"># 查看节点 labels</span><br>kubectl get node --show-labels<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>pod控制器类型以及网络通讯方式</title>
      <link href="/2020/06/09/pod%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F/"/>
      <url>/2020/06/09/pod%E6%8E%A7%E5%88%B6%E5%99%A8%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E7%BD%91%E7%BB%9C%E9%80%9A%E8%AE%AF%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p>原理图查看我的csdn博客：<a href="https://blog.csdn.net/weixin_42506599/article/details/106598627" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42506599/article/details/106598627</a></p><p><strong>pod概念：</strong><br>自主式pod：一旦死亡 不会进行拉起<br>控制器管理的pod：死亡后  控制器进行拉起<br>pod：一个pod里面可能有多个容器<br>运行pause（跑死），容器共用pause的网络站，共用pause的存储卷，进程不会进行隔离；<br>在同一个pod里  不能端口冲突；</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607104324199.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p><strong>控制器：</strong><br><strong>1、replicationcontroller</strong>  ：用来保证容器应用的副本数始终保持在用户定义的副本数，如果有容器异常退出，会创建新的pod来代替；如果异常多出来的容器也会被自动回收<br>在新版版的kubernetes中建议使用replicaset来代替replicationcontroller<br>**2、replicaset  ：**和replicationcontroller 没有本质不同 只是名字不同并且relicaset支持集合式的selector；可以使用打标签的方式进行指定集合<br>**3、deployment：**虽然一般replicaset 可以独立使用，但是一般还是建议使用1deployment来自动管理replocaset 这样无需担心和其他机制不兼容的问题（比如replicaset不支持rolling-update，但是deployment支持）</p><p>deployment流程图</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607104401578.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br>deployment ----&gt;创建rs------&gt;创建pod<br>deployment不直接管理pod</p><p><strong>4、horizon pod  autoscaling</strong>  仅适用于deployment和RS  在v1版中仅支持根据pod的CPU利用率扩容，在vlapha版本中 支持根据内存和用户自定义的metric扩容缩容</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607104436562.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>**5、statufulset：**是为了解决有状态服务的问题（对应deployment和replicaset是为无状态服务而设计），其应用场景包括：<br>1、稳定的持久化存储，pod重新调度后还能访问到相同的持久化数据，基于PVC实现<br>2、稳定的网络标志，pod重新调度后其podname和hostname不变，基于headless service实现（没有cluster  ip和service）<br>3、有序部署，有序扩展，pod是有顺序的，在部署或者扩展时要依据定义的顺序依次进行，基于init  container来实现<br>4、有序收缩，有序删除</p><p><strong>6、daemonset</strong>：确保全部node节点上运行一个pod的副本。当有node加入集群时，也会为他们新增一个pod。当有node从集群移除时，这些pod也会被回收，删除daemonset将会1删除1他们创建的所有的pod</p><p>使用daemonset的一些典型用户：<br>1、运行集群存储daemon，例如在每个node上运行glusterd、ceph<br>2、在每个node上运行日志收集daemon，例如fluentd、logstash<br>3、在每个node上运行监控daemon，例如Prometheus node  exporter</p><p><strong>7、job</strong> 负责批处理任务，仅执行一次的任务，他保证批处理任务的一个或者多个pod成功结束<br>cron job  管理基于时间的job  ：<br>1、在给定时间点只运行一次<br>2、周期性在给定时</p><p><strong>服务发现 service：</strong><br>service服务发现是通过标签进行选择的</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607104530928.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p><strong>网络通讯模式</strong><br>kubernetes的网络模型假定了所有pod都在一个直接连通的扁平的网络中，这在GCE里面是现成的网络模型，kubernetes假设这个网络已经存在。<br>而在私有云里搭建kubernetes集群，就不能假定这个网络已经存在了。我们需要自己实现这个网络假设，将不同节点上的docker 容器之间的互相访问先打通，然后运行kubernetes。</p><p>同一个pod的多个容器之间：lo<br>各个pod之间的通讯：overlay network<br>pod和service之间的通讯：各个节点的iptables规则</p><p><strong>flannel网络：</strong></p><p>简单来说，他的功能是让集群中的不同节点主机创建的docker容器都具有全集群唯一的虚拟IP地址，而且他还能在这些IP地址之间建立一个覆盖网络（overlay  network）通过这个覆盖网络，将数据包原封不动地传递到目标容器内</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607104601743.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>etcd的flannel提供说明：<br>1、存储管理flannel可分配的IP地址段资源<br>2、监控etcd中每个pod的实际地址，并在内存中建立维护pod节点路由表</p><p><strong>不同情况下网络通讯方式</strong><br><strong>同一个pod内部通讯：</strong><br>同一个pod共享同一个网络命名空间 共享同一个linux协议栈<br><strong>pod1至pod2：</strong><br>1、pod1和pod2不在同一台，pod的地址与docker0在同一个网段的，但是docker0网段与宿主机网卡是两个完全不同的ip网段，并且不同node之间的通讯只能通过宿主机物理网卡进行。将pod的ip所在node的IP地址关联起来，通过这个关联让pod可以相互访问<br>2、pod1与pod2在同一台机器，由docker0网桥直接转发请求到pod2 不需要经过flannel</p><p><strong>pod至service的网络：</strong><br>目前基于性能考虑，全部为iptables维护和转发</p><p><strong>pod到外网：</strong><br>pod向外网发送请求，查找路由表，转发数据包到宿主机的网卡，宿主机网卡完成路由选择后，iptables执行masquerade，把源ip更改为宿主机网卡的ip，然后向外网服务器发送请求</p><p>外网访问pod service</p><p><strong>kubernetes中的网络类型：</strong><br>service网络：虚拟网络<br>pod网络：虚拟网络<br>节点网络：只有节点网络是真实的网络</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes资源清单</title>
      <link href="/2020/06/09/kubernetes%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95/"/>
      <url>/2020/06/09/kubernetes%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95/</url>
      
        <content type="html"><![CDATA[<p>通过定义资源清单的方式来启动资源</p><p><strong>k8s中资源</strong><br>1、名称空间级别：仅在此名称空间生效 （默认空间是default）<br>2、集群级别：role  在全集群中都可以看到  跨名称空间<br>3、元数据级别：</p><p>k8s中所有的内容都被抽象为资源，资源实例化之后叫做对象</p><p><strong>空间级别</strong></p><p><code>工作负载型资源</code>：pod replicaset  deployment  statefulset  daemonset  job  cronjob<br>pod：和pause共用存储卷；共用网络站<br>replicaset：通过标签来控制pod副本数量<br>deployment：通过控制rs的创建去控制pod的数量<br>statefulset：为有状态服务建立的管理器<br>daemonset ：在每个节点都运行一个pod<br>job： 为了批处理任务诞生的<br>cronjob：为了批处理任务诞生的</p><p><code>服务发现及负载均衡资源</code>：  service  ingress<br>service ：将服务给暴露给外网用户访问<br>ingress：将服务给暴露给外网用户访问</p><p><code>配置和存储型资源</code>：volume 、  CSI<br>volume ：存储卷<br>CSI：（容器存储接口，可以扩展各种各样的第三方存储卷）</p><p><code>特殊类型的存储卷</code>：configMap（当配置中心来使用的资源类型）、secret（保存敏感数据）、downwardapi （把外部环境中的信息输出给容器）</p><p>configMap（当配置中心来使用的资源类型）：存储配置文件 达到热更新的状态<br>secret（保存敏感数据）：保存密钥等信息<br>downwardAPI（把外部环境中的信息输出给容器） 通过文件接口来调用</p><p>集群级别资源：namespace（名称空间）、node（工作节点）、role（角色）、clusterrole、rolebinding、clusterrolebinding</p><p>元数据资源：hpa（监控rs实现自动伸缩）、 podtemplate （资源模板）、limirange（资源限制）</p><p><strong>yaml文件格式说明：</strong><br>yaml是一个可读性高，用来表达数据序列的格式。yaml的意思其实是：仍是一种标记语言，但是为了强调这种语言以数据为中心，而不是以标记语言为重点</p><p><strong>基本语法：</strong><br>1、缩进时不允许使用tab键 只允许使用空格<br>2、缩进的空格数据不重要，只要相同层级的元素左对齐即可<br>3、标识注释，从这个字符一直到行尾，都会被解释器忽略1</p><p><strong>yaml支持的数据结构</strong><br>对象：键值对的集合，又称为映射、哈希、字典<br>数组：一组依次顺序排列的值，又称为序列<br>纯量：单个的、不可再分的值</p><p><strong>对象类型：对象的一组键值对，使用冒号结构表示</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">name: steve<br>age: 18<br></code></pre></td></tr></tbody></table></figure><p>yaml也允许另外一种写法，将所有键值对写成一个行内对象</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">hash</span>: { name: steve,age: 18}<br></code></pre></td></tr></tbody></table></figure><p><strong>数组类型： 一组连词线开头的行，构成一个数组</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">animal<br>- Cat<br>- Dog<br></code></pre></td></tr></tbody></table></figure><p>数组也可以采用行内写法</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">animal: [Cat, Dog]<br></code></pre></td></tr></tbody></table></figure><p>复合结构：对象和数组可以结合使用，形成复合结构</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 languages: <br>2 - Ruby <br>3 - Perl <br>4 - Python <br>5 websites: <br>6 YAML: yaml.org <br>7 Ruby: ruby-lang.org <br>8 Python: python.org <br>9 Perl: use.perl.org<br></code></pre></td></tr></tbody></table></figure><p>纯量：纯量是最基本的、不可再分的值。以下数据类型都属于纯量</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 字符串 布尔值 整数 浮点数 Null <br>  2 时间 日期<br>   <br>  数值直接以字面量的形式表示<br>  number: 12.30<br>   <br>  布尔值用<span class="hljs-literal">true</span>和<span class="hljs-literal">false</span>表示<br>  isSet: <span class="hljs-literal">true</span><br>   <br>  null用 ~ 表示<br>  parent: ~<br>   <br>  时间采用 ISO8601 格式<br>  iso8601: 2001-12-14t21:59:43.10-05:00<br>   <br>  日期采用复合 iso8601 格式的年、月、日表示<br>  date: 1976-07-31<br>   <br>  YAML 允许使用两个感叹号，强制转换数据类型<br>  e: !!str 123<br>  f: !!str <span class="hljs-literal">true</span><br></code></pre></td></tr></tbody></table></figure><p>字符串</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">字符串默认不使用引号表示<br><br>   str: 这是一行字符串<br><br>如果字符串之中包含空格或特殊字符，需要放在引号之中 <br><br>   str: <span class="hljs-string">'内容： 字符串'</span><br><br>单引号和双引号都可以使用，双引号不会对特殊字符转义 <br>   s1: <span class="hljs-string">'内容\n字符串'</span><br>   s2: <span class="hljs-string">"内容\n字符串"</span><br><br>单引号之中如果还有单引号，必须连续使用两个单引号转义 <br><br>   str: <span class="hljs-string">'labor'</span><span class="hljs-string">'s day'</span><br><br>字符串可以写成多行，从第二行开始，必须有一个单空格缩进。换行符会被转为 空格 <br><br>   str: 这是一段<br>     多行<br>     字符串<br><br>多行字符串可以使用|保留换行符，也可以使用&gt;折叠换行 <br><br>   this: |<br>   Foo<br>   Bar<br>   that: &gt;<br>   Foo<br>   Bar<br><br>+ 表示保留文字块末尾的换行，- 表示删除字符串末尾的换行 <br><br>   s1: |<br>     Foo<br>    <br>   s2: |+<br>     Foo<br>    <br>   s3: |-<br>     Foo<br></code></pre></td></tr></tbody></table></figure><p><strong>常用字段解释</strong><br>必须存在的属性：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">version  string  这里指的是k8s api的版本，目前基本上是v1，可以使用kubectl  api-versions查看<br>kind    string   这里指的是yaml文件定义的资源类型和角色 比如：pod<br>metadata  object   元数据对象  固定值就写metadata<br>metadata.name string    元数据对象的名字，这里我们编写，比如命名pod的名字<br>metadata.namespace  string 元数据对象的命名空间 由我们自身定义<br>spec  object   详细定义对象，固定值就写spec<br>spec.containers[]   list   这里是spec对象的容器列表定义，是个列表<br>spec.container[].name  string  这里定义容器的名字<br>spec.containers[].image  string  这里是定义要用到的镜像名称<br></code></pre></td></tr></tbody></table></figure><p><strong>主要对象</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">spec.containers[].name  string  定义容器的名字<br>spec.containers[].image     string    定义要用到的镜像名称<br>spec.containers[].imagePullPolicy   定义镜像拉取策略，有always、never、ifnotpresent 三个值可以选（1）always 意思是每次尝试重新拉取镜像；（2）never表示仅使用本地镜像（3）ifnotpresent 如果本地有镜像就使用本地镜像，没有就拉取在线镜像。上面三个值都没有设置的话，默认是always1<br>spec.containers[].<span class="hljs-built_in">command</span>[] list  指定容器启动命令，因为是数组可以指定多个，不指定则使用镜像打包时使用的启动命令<br>spec.container[].args[]   list  指定容器启动命令参数，因为是数组可以指定多个<br>spec.container[].workingDir   string  指定容器的工作目录<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">spec.containers[].vloumeMounts[]   list  指定容器内部的存储卷配置<br>spec.containers[].vloumeMounts[].name   string  指定可以被容器挂载的存储卷的名称<br>spec.containers[].vloumeMounts[].mountPath   指定可以被容器挂载的存储的路径<br>spec.container[].vloumeMounts[].readOnly   设置存储卷路径的的读写模式，ture或者<span class="hljs-literal">false</span>，默认为读写模式<br>spec.containers[].ports[]   list    指定容器需要用到的端口列表<br>spec.containers[].ports[].name  string   指定端口名称<br>spec.containers[].ports[].containerPort   string  指定容器需要监听的端口号<br>spec.containers[].port[].hostPort  string   指定容器所在主机需要监听的端口号，默认跟上面containerport相同，注意设置了hostport同一台主机无法启动该容器的相同的副本（因为主机的端口不能相同，这样会冲突）<br>spec.containers[].ports[].protocol  string  指定端口协议，支持tcp/udp 默认为tcp<br>spec.containers[].env[]   list   指定容器运行前需要设置的环境变量列表<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">spec.containers[].env[].name   string  指定环境变量名称<br>spec.containers[].env[].value   string    指定环境变量值<br>spec.containers[].resources   object  指定资源限制和资源请求的值（这里就是设置容器的资源上限）<br>spec.containers[].resources.limits  object  指定设置容器运行时资源的运行上限<br>spec.containers[].resources.limits.cpu      string 指定CPU的限制，单位为core数，将用于docker run  --cpu-shares参数 <br>spec.containers[].resources.memory  string   指定mem内存的限制，单位为mib、GIB<br>spec.containers[].resources.requests   object   指定容器启动和调度时的限制设置<br>spec.containers[].resources.requests.cpu   string  CPU请求，单位core数，容器启动时初始化可用数量<br>spec.containers[].resources.requests.memory  string  内存请求，单位为mib、gib  容器启动的初始化可用数量<br></code></pre></td></tr></tbody></table></figure><p>额外的参数选项</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">spec.restartPolicy  string  定义1pod的重启策略 ，可选值为always、onfailure，默认值为always。1、always：pod一旦终止运行，则无论容器是如何终止，kubectl服务都将重启2、onfailure：只有pod以非零退出码终止时，kubectl才会重启该容器。如果容器正常结束（退出为0），则kubectl将不会重启它。3、never：pod终止后，kubectl将退出码报告给master，不会重启该pod<br>spec.nodeSelector  object  定义node的label过滤标签，以key:value格式指定<br>spec.imagePullSecrets  object  定义pull镜像时使用secret名称，以name:secretkey格式指定<br>spec.hostNetwork  boolean  定义是否使用主机网络模式1，默认值为<span class="hljs-literal">false</span>。设置<span class="hljs-literal">true</span>表示使用宿主机网络，不使用docker网桥，同时设置了<span class="hljs-literal">true</span>将无法在同一台宿主机上启动第二个副本<br></code></pre></td></tr></tbody></table></figure><p>查看日志-c参数指定容器名字 （容器名字通过kubectl  describe   pod mypapp-pod查看  ）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   <span class="hljs-built_in">log</span>  mypapp-pod -c <span class="hljs-built_in">test</span><br></code></pre></td></tr></tbody></table></figure><p><strong>容器生命周期</strong><br>pod创建流程</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200609001954756.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>pod状态显示为runing不代表容器内部的程序已经完成，如果此时用户访问时，可能会出现错误<br><strong>readiness</strong> 就绪检测根据TCP状态 测试容器内的服务是否已经可用  如果可用再将pod的状态改为runing<br><strong>liveness</strong>   容器出现僵尸进程 已经无法访问 但是进程存在 所以主容器显示状态还是runing，liveness生存检测机制会检测容器是否出现僵尸进程，有则重启或者新生成一个容器</p><p>这样就解决了这些问题</p><p><strong>init容器</strong><br>pod能够具有多个容器，应用运行在容器里面，但是他也可能有一个或者多个先于应用容器启动1的init容器</p><p>init容器 与普通容器非常像，除了一下两点：<br>1、init容器总是运行到成功为止<br>2、每个init容器都必须在下一个init容器启动之前成功完成</p><p>如果pod的init容器失败，kubernetes会不断的重启该pod，直到init容器成功为止。然而，如果pod对应的restartpolicy为never，他不会重新启动</p><p><strong>init容器的作用</strong></p><p>因为init容器具有与应用程序容器分离的单独镜像，所以他们的启动相关代码具有如下优势：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、他们可以包含并运行使用工具，但是出于安全考虑，是不建议在应用程序容器镜像中包含这些使用工具的<br>2、他们可以包含使用工具和定制化代码来安装，但是不能出现应用程序镜像中，例如：创建镜像没有必要FROM另外一个镜像，只需要在安装过程中使用类似sed  awk  python或者dig这样的工具<br>3、应用程序镜像可以分离出创建和部署的角色，没有必要联合他们构建一个单独的镜像。<br>4、init容器使用linux  namespace 所以相对应程序容器来说具有不同的文件系统视图，因此，他们能够具有访问secret的权限，而应用程序容器则不能。<br>5、他们必须在应用程序容器启动之前运行完成，而应用程序容器是并行运行的，所以init容器能够提供一种简单的阻塞或者延迟应用容器的启动方法，直到满足了一组先决条件<br></code></pre></td></tr></tbody></table></figure><p>实例测试init容器与应用程序容器的关系<br><strong>init.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: myapp-pod<br>  labels:<br>    app: myapp<br>spec:<br>  containers:<br>  - name: myapp-container<br>    image: busybox<br>    <span class="hljs-built_in">command</span>: [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'echo The app is running! &amp;&amp; sleep 3600'</span>]<br>  initContainers:<br>  - name: init-myservice<br>    image: busybox<br>    <span class="hljs-built_in">command</span>: [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'until nslookup myservice; do echo waiting for myservice; sleep 2; </span><br><span class="hljs-string">done;'</span>]<br>  - name: init-mydb<br>    image: busybox<br>    <span class="hljs-built_in">command</span>: [<span class="hljs-string">'sh'</span>, <span class="hljs-string">'-c'</span>, <span class="hljs-string">'until nslookup mydb; do echo waiting for mydb; sleep 2; done;'</span>]<br></code></pre></td></tr></tbody></table></figure><p><strong>init-svcv1.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind: Service<br>apiVersion: v1<br>metadata:<br>  name: myservice<br>spec:<br>  ports:<br>    - protocol: TCP<br>      port: 80<br>      targetPort: 9376<br></code></pre></td></tr></tbody></table></figure><p><strong>init-svcv2.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind: Service<br>apiVersion: v1<br>metadata:<br>  name: mydb<br>spec:<br>  ports:<br>    - protocol: TCP<br>      port: 80<br>      targetPort: 9377<br></code></pre></td></tr></tbody></table></figure><p>操作测试查看</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   create -f  init.yaml <br>kubectl  get  pod<br>kubectl   create  -f init-svcv1.yaml<br>kubectl  get  pod<br>kubectl  get  pod -o wide<br>kubectl  create  -f init-svcv2.yaml <br>kubectl  get  pod -o wide<br>kubectl  get  pod -o wide<br>kubectl  get  pod<br>kubectl  get  pod -o wide<br>kubectl  describe   pod  myapp-pod<br></code></pre></td></tr></tbody></table></figure><p><strong>特殊说明：</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、在pod启动过程中，init容器会按照顺序在网络和数据卷初始化（pause中启动网络和数据卷）之后启动。每个容器必须在下一个容器启动之前成功退出<br>2、如果由于运行时或失败推出，将导致容器启动失败，他会根据pod的restartpolicy指定的策略进行重试。然而，如果pod的startpolicy设置为always，init容器失败时会使用restartpolicy策略<br>3、在所有的init容器没有成功之前，pod将不会变成ready状态，init容器的端口将不会在service中进行聚集。正在初始化中的pod处于pending状态，但是应该会将initalizing状态设置为<span class="hljs-literal">true</span><br>4、如果pod重启，所有init容器必须重新执行<br>5、对init容器spec的修改被限制在容器image字段，修改其他字段都不会生效。更改init容器的image字段，等价于重启该pod<br>kubectl  edit   pod myapp-pod<br>6、init容器具有容器的所有字段。除了readinessProde，因为init容器无法定义不同于完成（completion）的就绪（readiness）之外的其他状态。这会在验证过程中强制执行<br>7、在pod中的每个App和init容器的名称必须唯一；与其他任何容器共用同一个名称，会在验证时抛出错误，端口是可以相同的，因为init容器是串行执行的并且每个init容器执行退出码为0才会执行下一<br></code></pre></td></tr></tbody></table></figure><p><strong>容器探针</strong></p><p>探针是由kubectl对容器执行的定期诊断。要执行诊断，kubectl调用由容器实现的handler，有三种类型的处理程序：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、execaction：在容器内执行指定命令，如果命令退出时返回码为0，则认为诊断成功<br>2、tcpsocketaction：对指定端口上的容器的IP地址进行tcp检查。如果端口打开，则诊断被认为是成功的<br>3、HTTPgetaction：对指定的端口和路径上的容器的IP地址执行HTTPget请求。如果响应的状态码大于等于200且小于400，则诊断被认为是成功的<br></code></pre></td></tr></tbody></table></figure><p>每次探测都将获得以下三种结果之一：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">1、成功：容器通过了诊断<br>2、失败：容器未通过诊断<br>3、未知：诊断失败，因此不会采取任何行动<br></code></pre></td></tr></tbody></table></figure><p><strong>探针的探测方式</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">livenessprobe：指示容器是否在运行。如果存活探测失败，则kubectl会杀死容器，并且容器将受到重启策略的影响，如果容器不提供存活探针，则默认状态为success<br>readinessprobe：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与pod匹配的所有service的端点中删除该pod的IP地址。初始延迟之前的就绪状态默认为failure。如果容器不提供就绪探针，则默认状态为success<br></code></pre></td></tr></tbody></table></figure><p><strong>测试探针readiness  就绪探针的作用</strong><br><strong>readiness.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: readiness-httpget-pod<br>  namespace: default<br>spec:<br>  containers:<br>  - name: readiness-httpget-container<br>    image: hub.atguigu.com/library/myapp:v1<br>    imagePullPolicy: IfNotPresent<br>    readinessProbe:<br>      httpGet:<br>        port: 80<br>        path: /index1.html<br>      initialDelaySeconds: 1<br>      periodSeconds: 3<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master readiness]<span class="hljs-comment"># kubectl  get pod</span><br>NAME                    READY   STATUS    RESTARTS   AGE<br>readiness-httpget-pod   0/1     Running   0          52s<br></code></pre></td></tr></tbody></table></figure><p>查看日志信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"> kubectl  describe  pod  readiness-httpget-pod<br>Warning  Unhealthy  16s (x22 over 79s)  kubelet, k8s-node02  Readiness probe failed: HTTP probe failed with statuscode: 404<br></code></pre></td></tr></tbody></table></figure><p>报错：404  没有就绪<br>进入容器（如果一个pod资源中有多个container 那么-c参数指定要进入的container）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"> kubectl  <span class="hljs-built_in">exec</span> readiness-httpget-pod -c<br> <br> kubectl  <span class="hljs-built_in">exec</span> readiness-httpget-pod  -it  -- /bin/sh<br> <br> <br> [root@k8s-master readiness]<span class="hljs-comment"># kubectl  exec readiness-httpget-pod  -it  -- /bin/sh</span><br>/ <span class="hljs-comment"># cd //usr/share/nginx/html/</span><br><br>/usr/share/nginx/html <span class="hljs-comment"># echo '123'&gt; index1.html</span><br>/usr/share/nginx/html <span class="hljs-comment"># exit</span><br>[root@k8s-master readiness]<span class="hljs-comment"># </span><br>再次查看时<br>[root@k8s-master readiness]<span class="hljs-comment"># kubectl  get pod</span><br>NAME                    READY   STATUS    RESTARTS   AGE<br>myapp-pod               1/1     Running   8          8h<br>readiness-httpget-pod   1/1     Running   0          4m57s<br>[root@k8s-master readiness]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p><strong>测试liveness存活探针的检测</strong></p><p><strong>livenesspod.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: liveness-exec-pod<br>  namespace: default<br>spec:<br>  containers:<br>  - name: liveness-exec-container<br>    image: hub.atguigu.com/library/myapp:v1<br>    imagePullPolicy: IfNotPresent<br>    <span class="hljs-built_in">command</span>: [<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"touch /tmp/live ; sleep 60; rm -rf /tmp/live; sleep 3600"</span>]<br>    livenessProbe:<br>      <span class="hljs-built_in">exec</span>:<br>        <span class="hljs-built_in">command</span>: [<span class="hljs-string">"test"</span>,<span class="hljs-string">"-e"</span>,<span class="hljs-string">"/tmp/live"</span>]<br>      initialDelaySeconds: 1<br>      periodSeconds: 3<br></code></pre></td></tr></tbody></table></figure><p>每过一分钟就重启一次  restart</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master liveness]<span class="hljs-comment"># kubectl  get pod    </span><br>NAME                    READY   STATUS    RESTARTS   AGE<br>liveness-exec-pod       1/1     Running   2          13m<br></code></pre></td></tr></tbody></table></figure><p><strong>存活检测方式liveenssProbe-httpget</strong><br><strong>liveenssProbe-httpget.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: liveness-httpget-pod<br>  namespace: default<br>spec:<br>  containers:<br>  - name: liveness-httpget-container<br>    image: hub.atguigu.com/library/myapp:v1<br>    imagePullPolicy: IfNotPresent<br>    ports:<br>    - name: http<br>      containerPort: 80<br>    livenessProbe:<br>      httpGet:<br>        port: http<br>        path: /index.html<br>      initialDelaySeconds: 1<br>      periodSeconds: 3<br>      timeoutSeconds: 10<br></code></pre></td></tr></tbody></table></figure><p>删除后再查看</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master liveness]<span class="hljs-comment"># kubectl  exec -it liveness-httpget-pod /bin/sh</span><br>/ <span class="hljs-comment"># cd /usr/share/nginx/html/</span><br>/usr/share/nginx/html <span class="hljs-comment"># ls</span><br>50x.html    index.html<br>/usr/share/nginx/html <span class="hljs-comment"># rm -rf index.html </span><br>/usr/share/nginx/html <span class="hljs-comment"># exit</span><br>重启start次数变为了1<br>[root@k8s-master liveness]<span class="hljs-comment"># kubectl  get pod</span><br>NAME                    READY   STATUS             RESTARTS   AGE<br>liveness-httpget-pod    1/1     Running            1          4m25s<br></code></pre></td></tr></tbody></table></figure><p><strong>liveness的tcp检测方式</strong><br><strong>live-tcp.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: probe-tcp<br>spec:<br>  containers:<br>  - name: nginx<br>    image: hub.atguigu.com/library/myapp:v1<br>    livenessProbe:<br>      initialDelaySeconds: 5<br>      timeoutSeconds: 1<br>      tcpSocket:<br>        port: 8080<br>      periodSeconds: 3<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master liveness]<span class="hljs-comment"># kubectl   get pod  -w</span><br>NAME        READY   STATUS    RESTARTS   AGE<br>probe-tcp   1/1     Running   0          10s<br>probe-tcp   1/1     Running   1          15s<br></code></pre></td></tr></tbody></table></figure><p><strong>结合使用liveness和readiness</strong><br><strong>liveness-http.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: liveness-httpget-pod<br>  namespace: default<br>spec:<br>  containers:<br>  - name: liveness-httpget-pod<br>    image: hub.atguigu.com/library/myapp:v1<br>    imagePullPolicy: IfNotPresent<br>    ports:<br>    - name: http<br>      containerPort: 80<br>    readinessProbe:<br>      httpGet:<br>        port: 80<br>        path: /index1.html<br>      initialDelaySeconds: 1<br>      periodSeconds: 3<br>    livenessProbe:<br>      httpGet:<br>        port: 80<br>        path: /index.html<br>      initialDelaySeconds: 1<br>      periodSeconds: 3<br>      timeoutSeconds: 10<br></code></pre></td></tr></tbody></table></figure><p>创建</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl  apply -f liveness-http.yaml<br></code></pre></td></tr></tbody></table></figure><p><strong>启动退出动作</strong></p><p><strong>pod.yaml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: lifecycle-demo<br>spec:<br>  containers:<br>  - name: lifecycle-demon-container<br>    image: hub.atguigu.com/library/myapp:v1<br>    lifecycle:<br>      postStart:<br>        <span class="hljs-built_in">exec</span>:<br>          <span class="hljs-built_in">command</span>: [<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"echo hello from postStart handler &gt; /usr/share/message"</span>]<br>      preStop:<br>        <span class="hljs-built_in">exec</span>:<br>          <span class="hljs-built_in">command</span>: [<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"echo hello from the poststop handler &gt; /usr/share/massage"</span>]<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># kubectl  apply  -f  pod.yaml </span><br>pod/lifecycle-demo created<br><br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get pod</span><br>NAME             READY   STATUS    RESTARTS   AGE<br>lifecycle-demo   1/1     Running   0          5s<br><br><br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  exec lifecycle-demo   -it  /bin/sh</span><br>/ <span class="hljs-comment"># cat /usr/share/message </span><br>hello from postStart handler<br>/ <span class="hljs-comment"># exit</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ES数据库安装6.6</title>
      <link href="/2020/06/08/ES%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85/"/>
      <url>/2020/06/08/ES%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>ES数据库安装</p><p>elastica  search<br>elasticsearch的概念：<br>是一个实时的分布式搜索和分析引擎，它可以用于全文搜索，结构化搜索以及分析。它是一个建立在全文搜索引擎 Apache Lucene 基础上的搜索引擎，使用 Java 语言编写。</p><p>1、elasticsearch和MongoDB/redis/memcache一样，是非关系性数据库<br>是一个接近实时的搜索平台，从所索引这个文档到能够被搜索到只有一个轻微的延迟，企业应用定位：采用restfullapi标准的可扩展和高可用的实时数据分析的全文搜索工具<br>2、可扩展：支持一主多从且扩容容易，只要cluster.nam一致且在同一个网络中就能自动加入当前集群；本身就是开源软件，也支持很多开源的第三方插件<br>3、高可用：在一个集群的多个节点中进行分布式存储，索引支持shards和复制，即使部分节点down掉，也能自动进行数据恢复和主从切换<br>4、采用restfullapi标准：通过http接口和json格式进行操作数据<br>5、数据存储的最小单位是文档，本质上是一个json文本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">node节点 ：单个的装有elasticsearch服务并且提供故障转移和扩展的服务器<br>cluster集群：一个集群就是由一个或者多个node组织在一起，共同工作，共同分享整个数据具有负载均衡功能的集群<br>index索引： 索引就是一个拥有几分相似特征的文档的集合<br><span class="hljs-built_in">type</span>类型：索引可以为拥有相同字段的文档定义一个类型；一个索引中可以创建多个<span class="hljs-built_in">type</span><br>document文档：一个文档是一个可被索引的基础信息单元<br>field 列：field是elasticsearch的最小单位，相当于数据的某一个列<br>shards分片：elastic search将索引分成若干份，每个部分就是一个shard<br>replicas复制：replicas 是索引里每个shard的拷贝（一份或者多份）<br></code></pre></td></tr></tbody></table></figure><p>elasticsearch 应用场景<br>1、搜索：电商、百科、App搜索<br>2、高亮显示：GitHub<br>3、分析和数据挖掘：ELK</p><p>elasticsearch特点：<br>1、高性能，天然分布式<br>2、对运维友好，不需要会java开发语言，开箱即用<br>3、功能丰富</p><p><strong>elasticsearch安装部署6.6版本</strong></p><p>rpm -qc  elasticsearch 查看配置文件有哪些</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost soft]<span class="hljs-comment"># rpm -qc  elasticsearch</span><br>/etc/elasticsearch/elasticsearch.yml      主配置文件<br>/etc/elasticsearch/jvm.options       jvm虚拟机配置<br>/etc/elasticsearch/log4j2.properties  <br>/etc/elasticsearch/role_mapping.yml<br>/etc/elasticsearch/roles.yml<br>/etc/elasticsearch/users<br>/etc/elasticsearch/users_roles<br>/etc/init.d/elasticsearch     init启动脚本<br>/etc/sysconfig/elasticsearch<br>/usr/lib/sysctl.d/elasticsearch.conf  配置参数，不需要改动<br>/usr/lib/systemd/system/elasticsearch.service  systemctl 启动文件<br></code></pre></td></tr></tbody></table></figure><p>1、关闭防火墙</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -nL<br>iptables -F<br>iptables -X<br>iptables -Z<br>iptables -nL<br></code></pre></td></tr></tbody></table></figure><p>2、下载软件<br>链接：<a href="https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw" target="_blank" rel="noopener">https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw</a><br>提取码：lrai</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /data/soft<br>[root@db-01 /data/soft]<span class="hljs-comment"># ll -h</span><br>total 268M<br>-rw-r--r-- 1 root root 109M Feb 25  2019 elasticsearch-6.6.0.rpm<br>-rw-r--r-- 1 root root 159M Sep  2 16:35 jdk-8u102-linux-x64.rpm<br></code></pre></td></tr></tbody></table></figure><p>3、安装jdk</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh jdk-8u102-linux-x64.rpm <br>[root@db-01 /data/soft]<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">"1.8.0_212"</span><br>OpenJDK Runtime Environment (build 1.8.0_212-b04)<br>OpenJDK 64-Bit Server VM (build 25.212-b04, mixed mode)<br></code></pre></td></tr></tbody></table></figure><p>4、安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh elasticsearch-6.6.0.rpm<br></code></pre></td></tr></tbody></table></figure><p>5、启动并检查</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> elasticsearch.service<br>systemctl start elasticsearch.service<br><br>netstat -lntup|grep 9200<br><br>[root@db01 /data/soft]<span class="hljs-comment"># curl 127.0.0.1:9200</span><br>{<br>  <span class="hljs-string">"name"</span> : <span class="hljs-string">"pRG0qLR"</span>,<br>  <span class="hljs-string">"cluster_name"</span> : <span class="hljs-string">"elasticsearch"</span>,<br>  <span class="hljs-string">"cluster_uuid"</span> : <span class="hljs-string">"mNuJSe07QM61IOxecnanZg"</span>,<br>  <span class="hljs-string">"version"</span> : {<br>    <span class="hljs-string">"number"</span> : <span class="hljs-string">"6.6.0"</span>,<br>    <span class="hljs-string">"build_flavor"</span> : <span class="hljs-string">"default"</span>,<br>    <span class="hljs-string">"build_type"</span> : <span class="hljs-string">"rpm"</span>,<br>    <span class="hljs-string">"build_hash"</span> : <span class="hljs-string">"a9861f4"</span>,<br>    <span class="hljs-string">"build_date"</span> : <span class="hljs-string">"2019-01-24T11:27:09.439740Z"</span>,<br>    <span class="hljs-string">"build_snapshot"</span> : <span class="hljs-literal">false</span>,<br>    <span class="hljs-string">"lucene_version"</span> : <span class="hljs-string">"7.6.0"</span>,<br>    <span class="hljs-string">"minimum_wire_compatibility_version"</span> : <span class="hljs-string">"5.6.0"</span>,<br>    <span class="hljs-string">"minimum_index_compatibility_version"</span> : <span class="hljs-string">"5.0.0"</span><br>  },<br>  <span class="hljs-string">"tagline"</span> : <span class="hljs-string">"You Know, for Search"</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>端口说明：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">9200作为Http协议，主要用于外部通讯<br>9300作为Tcp协议，jar之间就是通过tcp协议通讯<br>ES集群之间是通过9300进行通讯<br></code></pre></td></tr></tbody></table></figure><p><strong>ES自定义配置</strong><br>1、查看ES有哪些配置</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@db01 ~]<span class="hljs-comment"># rpm -qc elasticsearch </span><br>/etc/elasticsearch/elasticsearch.yml    <span class="hljs-comment">#ES的主配置文件</span><br>/etc/elasticsearch/jvm.options        <span class="hljs-comment">#jvm虚拟机配置</span><br>/etc/sysconfig/elasticsearch        <span class="hljs-comment">#默认一些系统配置参数</span><br>/usr/lib/sysctl.d/elasticsearch.conf    <span class="hljs-comment">#配置参数,不需要改动</span><br>/usr/lib/systemd/system/elasticsearch.service <span class="hljs-comment">#system启动文件</span><br></code></pre></td></tr></tbody></table></figure><p>2、自定义配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp /etc/elasticsearch/elasticsearch.yml  /opt/<br>cat &gt;/etc/elasticsearch/elasticsearch.yml&lt;&lt;EOF<br>node.name: node-1<br>path.data: /var/lib/elasticsearch<br>path.logs: /var/<span class="hljs-built_in">log</span>/elasticsearch<br>bootstrap.memory_lock: <span class="hljs-literal">true</span><br>network.host: 10.0.0.51,127.0.0.1<br>http.port: 9200<br>EOF<br></code></pre></td></tr></tbody></table></figure><p>3、重启服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart elasticsearch.service<br></code></pre></td></tr></tbody></table></figure><p>4、解决内存锁定失败<br>重启后查看日志发现提示内存锁定失败</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@db01 ~]<span class="hljs-comment"># tail -f /var/log/elasticsearch/elasticsearch.log </span><br>[2019-11-14T09:42:29,513][ERROR][o.e.b.Bootstrap          ] [node-1] node validation exception<br>[1] bootstrap checks failed<br>[1]: memory locking requested <span class="hljs-keyword">for</span> elasticsearch process but memory is not locked<br></code></pre></td></tr></tbody></table></figure><p>解决方案：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl edit elasticsearch<br>[Service]<br>LimitMEMLOCK=infinity<br><br>systemctl daemon-reload<br>systemctl restart elasticsearch.service<br></code></pre></td></tr></tbody></table></figure><p><strong>安装es-head插件安装</strong><br>链接：<a href="https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw" target="_blank" rel="noopener">https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw</a><br>提取码：lrai</p><p>注意:需要修改配置文件添加允许跨域参数</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">http.cors.enabled: <span class="hljs-literal">true</span> <br>http.cors.allow-origin: <span class="hljs-string">"*"</span><br></code></pre></td></tr></tbody></table></figure><p><strong>1.es-head 三种方式</strong><br>1.npm安装方式<br>2.docker安装<br>3.google浏览器插件（推荐）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">从google商店安装es-head插件<br>将安装好的插件导出到本地<br>修改插件文件名为zip后缀<br>解压目录<br>拓展程序-开发者模式-打开已解压的目录<br>连接地址修改为ES的IP地址<br></code></pre></td></tr></tbody></table></figure><p>2.具体操作命令<br>Head插件在5.0以后安装方式发生了改变，需要nodejs环境支持，或者直接使用别人封装好的docker镜像<br>插件官方地址</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/mobz/elasticsearch-head<br></code></pre></td></tr></tbody></table></figure><p>使用docker部署elasticsearch-head</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull alivv/elasticsearch-head<br>docker run --name es-head -p 9100:9100 -dit elivv/elasticsearch-head<br></code></pre></td></tr></tbody></table></figure><p>使用nodejs编译安装elasticsearch-head</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /opt/<br>wget https://nodejs.org/dist/v12.13.0/node-v12.13.0-linux-x64.tar.xz<br>tar xf node-v12.13.0-linux-x64.tar.xz<br>mv node-v12.13.0-linux-x64 node<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH=$PATH:/opt/node/bin'</span> &gt;&gt; /etc/profile<br><span class="hljs-built_in">source</span> /etc/profile <br>npm -v<br>node -v <br>git <span class="hljs-built_in">clone</span> git://github.com/mobz/elasticsearch-head.git<br>unzip elasticsearch-head-master.zip<br><span class="hljs-built_in">cd</span> elasticsearch-head-master<br>npm install -g cnpm --registry=https://registry.npm.taobao.org<br>cnpm install<br>npm run start &amp;<br></code></pre></td></tr></tbody></table></figure><p><strong>kibana与ES交互</strong></p><p>链接：<a href="https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw" target="_blank" rel="noopener">https://pan.baidu.com/s/1PMpkPwAK03F_KYrZM-5hAw</a><br>提取码：lrai</p><p>1、安装kibana</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh kibana-6.6.0-x86_64.rpm<br></code></pre></td></tr></tbody></table></figure><p>2、配置kubana</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost soft]<span class="hljs-comment"># grep  -nEv  '#|^$'  /etc/kibana/kibana.yml</span><br>2:server.port: 5601<br>7:server.host: <span class="hljs-string">"10.0.0.51"</span><br>28:elasticsearch.hosts: [<span class="hljs-string">"http://10.0.0.51:9200"</span>]<br>37:kibana.index: <span class="hljs-string">".kibana"</span><br></code></pre></td></tr></tbody></table></figure><p>3、启动kibana</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start kibana<br></code></pre></td></tr></tbody></table></figure><p>端口：5601</p><p>4、测试命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -XGET <span class="hljs-string">'http://10.0.0.51:9200/_count?pretty'</span> -H <span class="hljs-string">'Content-Type: application/json'</span> -d <span class="hljs-string">'   </span><br><span class="hljs-string"> {</span><br><span class="hljs-string">   "query": { "match_all": {}</span><br><span class="hljs-string">   } </span><br><span class="hljs-string"> }</span><br><span class="hljs-string"> '</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql    es<br>库           index 索引<br>表            <span class="hljs-built_in">type</span> <br>字段         json key <br>行           doc文档<br></code></pre></td></tr></tbody></table></figure><p>使用HTTP的协议<br>GET 查看<br>PUT  提交<br>POST  提交<br>DELETE  删除</p><p>方法                  索引/类型/doc</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">PUT twitter/_doc/1<br>{<br>    <span class="hljs-string">"user"</span> : <span class="hljs-string">"kimchy"</span>,<br>    <span class="hljs-string">"post_date"</span> : <span class="hljs-string">"2009-11-15T14:12:12"</span>,<br>    <span class="hljs-string">"message"</span> : <span class="hljs-string">"trying out Elasticsearch"</span><br>}<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200608205810558.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>所有以下划线开头都是系统默认的</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">{<br><span class="hljs-string">"_index"</span>: <span class="hljs-string">"oldzhang"</span>,<br><span class="hljs-string">"_type"</span>: <span class="hljs-string">"info"</span>,<br><span class="hljs-string">"_id"</span>: <span class="hljs-string">"1"</span>,<br><span class="hljs-string">"_version"</span>: 1,<br><span class="hljs-string">"_score"</span>: 1,<br><span class="hljs-string">"_source"</span>: {<br><span class="hljs-string">"name"</span>: <span class="hljs-string">"zhang"</span>,<br><span class="hljs-string">"age"</span>: <span class="hljs-string">"29"</span><br>}<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>故障案例</strong></p><p>一开始使用ES库关联mysql 一开始使用的指定id 后来发现数据库的查询变的慢，根据调研，采用post随机id</p><p>elasticsearch 和数据库怎么进行关联</p><p>根据id进行关联，但是会进行id比较 不能出现id冲突<br>根据post 的随机id   不会进行id比较 关联mysql时增加一个字段 解决关联问题</p><p><strong>查询命令</strong></p><p>1、创建测试语句</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash">POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"zhang"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"29"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaoqi"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xiao1"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"30"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaoqi"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xiao2"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"26"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaoqi"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xiao4"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"35"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaoqi"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"ya"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"28"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaomin"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xiaomin"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"26"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaowang"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"SM"</span><br><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"hemengfei"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"38"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaohe"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"3P"</span><br>}<br><br>POST oldzhang/info/<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"xiaoyu"</span>,<br>  <span class="hljs-string">"age"</span>: <span class="hljs-string">"28"</span>,<br>  <span class="hljs-string">"pet"</span>: <span class="hljs-string">"bijiben"</span>,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"fly"</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>2、简单查询</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET oldzhang/_search/<br></code></pre></td></tr></tbody></table></figure><p>3、条件查询</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET oldzhang/_search<br>{<br>  <span class="hljs-string">"query"</span>: {<br>    <span class="hljs-string">"term"</span>: {<br>      <span class="hljs-string">"name"</span>: {<br>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"xiaomin"</span><br>      }<br>    }<br>  }<br>}<br><br>GET oldzhang/_search<br>{<br>  <span class="hljs-string">"query"</span>: {<br>    <span class="hljs-string">"term"</span>: {<br>      <span class="hljs-string">"job"</span>: {<br>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"it"</span><br>      }<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>4、多条件查询</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET /oldzhang/_search<br>{<br>    <span class="hljs-string">"query"</span> : {<br>      <span class="hljs-string">"bool"</span>: {<br>        <span class="hljs-string">"must"</span>: [<br>          {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"pet"</span>: <span class="hljs-string">"xiaoqi"</span>}},<br>          {<span class="hljs-string">"match"</span>: {<span class="hljs-string">"name"</span>: <span class="hljs-string">"zhang"</span>}}<br>        ],<br>        <span class="hljs-string">"filter"</span>: {<br>          <span class="hljs-string">"range"</span>: {<br>            <span class="hljs-string">"age"</span>: {<br>              <span class="hljs-string">"gte"</span>: 27,<br>              <span class="hljs-string">"lte"</span>: 30<br>            }<br>          }<br>          }<br>        }<br>      }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>增删改查</strong><br>1、自定义的ID更新</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">PUT oldzhang/info/1<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"zhang"</span>,<br>  <span class="hljs-string">"age"</span>: 30,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span>,<br>  <span class="hljs-string">"id"</span>: 1<br>}<br></code></pre></td></tr></tbody></table></figure><p><strong>2.随机ID更新</strong><br>#先根据自定义的Id字段查出数据的随机ID</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET oldzhang/_search/<br>{<br>  <span class="hljs-string">"query"</span>: {<br>    <span class="hljs-string">"term"</span>: {<br>      <span class="hljs-string">"id"</span>: {<br>        <span class="hljs-string">"value"</span>: <span class="hljs-string">"2"</span><br>      }<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>#取到随机ID后更改数据</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">PUT oldzhang/info/CVDdknIBq3aq7mPQaoWw<br>{<br>  <span class="hljs-string">"name"</span>: <span class="hljs-string">"yayay"</span>,<br>  <span class="hljs-string">"age"</span>: 30,<br>  <span class="hljs-string">"job"</span>: <span class="hljs-string">"it"</span>,<br>  <span class="hljs-string">"id"</span>: 2<br>}<br></code></pre></td></tr></tbody></table></figure><p>MongoDB   ES  etcd 都是使用jso格式<br>而Redis是使用</p><p>日志的两种格式：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">多行匹配格式<br>json格式<br></code></pre></td></tr></tbody></table></figure><p><strong>集群相关名词</strong><br>1、默认分片和副本规则</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">5分片<br>1副本<br></code></pre></td></tr></tbody></table></figure><p>2、集群健康状态</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">绿色: 所有数据都完整，且副本数满足<br>黄色: 所有数据都完整，但是副本数不满足<br>红色: 一个或多个索引数据不完整<br></code></pre></td></tr></tbody></table></figure><p>3、节点类型</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">主节点:   负责调度数据分配到哪个节点<br>数据节点:  实际负责处理数据的节点<br>默认:     主节点也是工作节点<br></code></pre></td></tr></tbody></table></figure><p>4、数据分片</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">主分片:    实际存储的数据,负责读写,粗框的是主分片<br>副本分片:  主分片的副本,提供读,同步主分片,细框的是副本分片<br></code></pre></td></tr></tbody></table></figure><p>5、副本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">主分片的备份,副本数量可以自定义<br></code></pre></td></tr></tbody></table></figure><p><strong>部署ES集群</strong><br>1、安装java</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh jdk-8u102-linux-x64.rpm<br></code></pre></td></tr></tbody></table></figure><p>2、安装ES</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh elasticsearch-6.6.0.rpm<br></code></pre></td></tr></tbody></table></figure><p>3、配置内存锁定</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl edit elasticsearch.service<br>[Service]<br>LimitMEMLOCK=infinity<br></code></pre></td></tr></tbody></table></figure><p>4、集群配置文件</p><p>node-1</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost soft]<span class="hljs-comment"># grep  -nEv '#|^$' /etc/elasticsearch/elasticsearch.yml</span><br>1:cluster.name: elk<br>2:node.name: node-1<br>3:path.data: /var/lib/elasticsearch<br>4:path.logs: /var/<span class="hljs-built_in">log</span>/elasticsearch<br>5:bootstrap.memory_lock: <span class="hljs-literal">true</span><br>6:network.host: 10.0.0.51,127.0.0.1<br>7:http.port: 9200<br>8:discovery.zen.ping.unicast.hosts: [<span class="hljs-string">"10.0.0.51"</span>, <span class="hljs-string">"10.0.0.52"</span>]<br>9:discovery.zen.minimum_master_nodes: 1<br></code></pre></td></tr></tbody></table></figure><p>node-2</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep  -nEv <span class="hljs-string">'#|^$'</span> /etc/elasticsearch/elasticsearch.yml<br>17:cluster.name: elk<br>23:node.name: node-2<br>33:path.data: /var/lib/elasticsearch<br>37:path.logs: /var/<span class="hljs-built_in">log</span>/elasticsearch<br>43:bootstrap.memory_lock: <span class="hljs-literal">true</span><br>55:network.host: 10.0.0.52,127.0.0.1<br>59:http.port: 9200<br>68:discovery.zen.ping.unicast.hosts: [<span class="hljs-string">"10.0.0.51"</span>, <span class="hljs-string">"10.0.0.52"</span>]<br>72:discovery.zen.minimum_master_nodes: 1<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">discovery.zen.minimum_master_nodes: 1  <br>这个参数的作用：如果集群想正常工作，至少需要几台机器正常<br>集群的节点个数的一半以上，也就是大多数<br>这两台机器能互相通讯<br></code></pre></td></tr></tbody></table></figure><p>建议：<br>不要偶数个节点<br>解释修改参数：尽量使得集群节点数为奇数个</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">total number of master-eligible nodes     / 2 + 1<br>所有可能会成为master节点的个数 / 2 + 1<br></code></pre></td></tr></tbody></table></figure><p>5、启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload<br>systemctl restart elasticsearch<br></code></pre></td></tr></tbody></table></figure><p>6、查看日志</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tail  -f /var/<span class="hljs-built_in">log</span>/elasticsearch/elasticsearch.log<br></code></pre></td></tr></tbody></table></figure><p>7、查看集群</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ES-head查看是否有2个节点<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200608210408934.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><strong>集群注意事项</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.插入和读取数据在任意节点都可以执行,效果一样<br>2.es-head可以连接集群内任一台服务<br><br>3.主节点负责读写<br>如果主分片所在的节点坏掉了,副本分片会升为主分片<br><br>4.主节点负责调度<br>如果主节点坏掉了,数据节点会自动升为主节点<br><br>5.通讯端口<br>默认会有2个通讯端口：9200和9300<br>9300并没有在配置文件里配置过<br>如果开启了防火墙并且没有放开9300端口，那么集群通讯就会失败<br></code></pre></td></tr></tbody></table></figure><p>查看集群各种信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET _cat/nodes<br>GET _cat/health<br>GET _cat/master<br>GET _cat/fielddata<br>GET _cat/indices<br>GET _cat/shards<br>GET _cat/shards/oldzhang<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200608210456468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>扩容第三台机器<br>1、安装java</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh jdk-8u102-linux-x64.rpm<br></code></pre></td></tr></tbody></table></figure><p>2、安装ES</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -ivh elasticsearch-6.6.0.rpm<br></code></pre></td></tr></tbody></table></figure><p>3、配置内存锁定</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl edit elasticsearch.service<br>[Service]<br>LimitMEMLOCK=infinity<br></code></pre></td></tr></tbody></table></figure><p>4、db03集群配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt;EOF<br>cluster.name: elk<br>node.name: node-3<br>path.data: /var/lib/elasticsearch<br>path.logs: /var/<span class="hljs-built_in">log</span>/elasticsearch<br>bootstrap.memory_lock: <span class="hljs-literal">true</span><br>network.host: 10.0.0.53,127.0.0.1<br>http.port: 9200<br>discovery.zen.ping.unicast.hosts: [<span class="hljs-string">"10.0.0.51"</span>, <span class="hljs-string">"10.0.0.53"</span>]<br>discovery.zen.minimum_master_nodes: 1<br>EOF<br></code></pre></td></tr></tbody></table></figure><p>解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">discovery.zen.ping.unicast.hosts: [<span class="hljs-string">"10.0.0.51"</span>, <span class="hljs-string">"10.0.0.53"</span>]<br>能和集群内任意一个节点ping通即可 通过51可以和集群内所有的机器进行获取（感觉和病毒感染一样）<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200608210555569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br>5、添加接点注意</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.对于新添加的节点来说:  <br>只需要直到集群内任意一个节点的IP和他自己本身的IP即可<br><br>对于以前的节点来说:<br>什么都不需要更改<br><br>2.最大master节点数设置<br>3个节点,设置为2<br><br>3.默认创建索引为1副本5分片<br><br>4.数据分配的时候会出现2中颜色<br>紫色: 正在迁移<br>黄色: 正在复制<br>绿色: 正常<br><br>5.3节点的时候<br>0副本一台都不能坏 <br>1副本的极限情况下可以坏2台: 1台1台的坏,不能同时坏2台,在数据复制完成的情况下,可以坏2台<br>2副本的情况可以同时坏2台<br></code></pre></td></tr></tbody></table></figure><p>当数据库node2（假设为主库）down掉一个后 这时node1为主库，如果此时有数据写入，等到node2修复好之后，自动同步数据。<br>磁盘不能写的太满，会导致复制数据出现问题，保证足够的空间使用</p><p><strong>动态修改最小发现节点数</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET _cluster/settings<br><br>PUT _cluster/settings<br>{<br>  <span class="hljs-string">"transient"</span>: {<br>    <span class="hljs-string">"discovery.zen.minimum_master_nodes"</span>: 2<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200608210650161.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>出现这种情况是因为：主分片为5，副本为1  所以三个节点的情况下 一个为主分片 一个为副本，另外一个就是没有主分片和副本</p><p>3个节点的ES集群，极限情况下，最多允许坏几台？<br>如果选举参数配置为1的情况下，极限坏2台，不能同时坏，坏一台，等数据同步后，才能坏第二台</p><p>红色: 一个或多个索引数据不完整<br>如果集群编程红色了，只是说明索引数据不完整，</p><p>1、副本数和分片数都是可以调整的<br>2、分片数只有在创建索引的时候才能定义  索引一旦创建完成 分片数不能修改</p><p>ES集群故障转移和恢复注意事项</p><p>elasticsearch 是一款成熟的数据库，不只是elk的数据库</p><p>黄（副本数不满足）----绿（正常）----紫（迁移）</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>k8s使用Harbor仓库</title>
      <link href="/2020/06/07/k8s%E4%BD%BF%E7%94%A8Harbor%E4%BB%93%E5%BA%93/"/>
      <url>/2020/06/07/k8s%E4%BD%BF%E7%94%A8Harbor%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>前提：<br>1、安装 k8s 的节点必须是大于 1 核心的 CPU<br>2、阿里云的repo 和base源</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br></code></pre></td></tr></tbody></table></figure><p>1、设置系统主机名以及host解析</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl  <span class="hljs-built_in">set</span>-hostname  k8s-master<br>10.0.0.20 k8s-node01<br>10.0.0.21 k8s-node02  <br>10.0.0.10 k8s-master<br></code></pre></td></tr></tbody></table></figure><p>2、安装依赖包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  conntrack ntpdate  ntp  ipvsadmin ipset  jq iptables  curl  sysstat  libseccomp wget  vim   net-tools git<br></code></pre></td></tr></tbody></table></figure><p>3、设置防火墙为 Iptables 并设置空规则</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl  stop firewalld  &amp;&amp;  systemctl  <span class="hljs-built_in">disable</span> firewalld<br> yum -y install iptables-services  &amp;&amp;  systemctl  start iptables  &amp;&amp;  systemctl  <span class="hljs-built_in">enable</span> iptables  &amp;&amp;  iptables -F  &amp;&amp;  service iptables save<br></code></pre></td></tr></tbody></table></figure><p>4、关闭selinux 关闭swap<br>开启虚拟内存时 如果pod在swap中运行  那么kubernetes出现报错</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">swapoff -a &amp;&amp; sed -i <span class="hljs-string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab<br>setenforce 0 &amp;&amp; sed -i <span class="hljs-string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config<br></code></pre></td></tr></tbody></table></figure><p>5、调整内核参数，对于 K8S</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; kubernetes.conf &lt;&lt;EOF<br>net.bridge.bridge-nf-call-iptables=1    <span class="hljs-comment">#开启网桥模式</span><br>net.bridge.bridge-nf-call-ip6tables=1    <span class="hljs-comment">#开启网桥模式</span><br>net.ipv4.ip_forward=1<br>net.ipv4.tcp_tw_recycle=0<br>vm.swappiness=0 <span class="hljs-comment"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br>vm.overcommit_memory=1 <span class="hljs-comment"># 不检查物理内存是否够用</span><br>vm.panic_on_oom=0 <span class="hljs-comment"># 开启 OOM  </span><br>fs.inotify.max_user_instances=8192<br>fs.inotify.max_user_watches=1048576<br>fs.file-max=52706963<br>fs.nr_open=52706963<br>net.ipv6.conf.all.disable_ipv6=1   <span class="hljs-comment">#关闭ipv6</span><br>net.netfilter.nf_conntrack_max=2310720<br>EOF<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf  开机调用<br>sysctl -p /etc/sysctl.d/kubernetes.conf    立刻生效<br></code></pre></td></tr></tbody></table></figure><p>6、调整系统时区</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置系统时区为 中国/上海</span><br>timedatectl <span class="hljs-built_in">set</span>-timezone Asia/Shanghai<br><span class="hljs-comment"># 将当前的 UTC 时间写入硬件时钟</span><br>timedatectl <span class="hljs-built_in">set</span>-local-rtc 0<br><span class="hljs-comment"># 重启依赖于系统时间的服务</span><br>systemctl restart rsyslog <br>systemctl restart crond<br></code></pre></td></tr></tbody></table></figure><p>7、关闭系统不需要服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop postfix &amp;&amp; systemctl <span class="hljs-built_in">disable</span> postfix<br></code></pre></td></tr></tbody></table></figure><p>8、设置 rsyslogd 和 systemd journald<br>使用日志为 journald  方式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /var/<span class="hljs-built_in">log</span>/journal <span class="hljs-comment"># 持久化保存日志的目录</span><br>mkdir /etc/systemd/journald.conf.d  创建配置文件存放目录<br></code></pre></td></tr></tbody></table></figure><p>创建journal 的日志配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF<br> [Journal]<br> <span class="hljs-comment"># 持久化保存到磁盘</span><br> Storage=persistent<br>  <br> <span class="hljs-comment"># 压缩历史日志</span><br> Compress=yes<br>  <br> SyncIntervalSec=5m<br> RateLimitInterval=30s<br> RateLimitBurst=1000<br>  <br> <span class="hljs-comment"># 最大占用空间 10G</span><br> SystemMaxUse=10G<br>  <br> <span class="hljs-comment"># 单日志文件最大 200M</span><br> SystemMaxFileSize=200M<br>  <br> <span class="hljs-comment"># 日志保存时间 2 周</span><br> MaxRetentionSec=2week<br>  <br> <span class="hljs-comment"># 不将日志转发到 syslog</span><br> ForwardToSyslog=no<br> EOF<br></code></pre></td></tr></tbody></table></figure><p>9、重启服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart systemd-journald<br></code></pre></td></tr></tbody></table></figure><p>10、升级系统内核为 4.44</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如： rpm -Uvh<br>http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm<br></code></pre></td></tr></tbody></table></figure><p>升级</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm<br>   <span class="hljs-comment"># 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装</span><br>一次！<br>yum --enablerepo=elrepo-kernel install -y kernel<span class="hljs-_">-lt</span><br><span class="hljs-comment"># 设置开机从新内核启动</span><br>grub2-set-default <span class="hljs-string">'CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)'</span> &amp;&amp; reboot<br><br><br>uname  -r<br></code></pre></td></tr></tbody></table></figure><p>11、kube-proxy开启ipvs的前置条件</p><p>修改调度方式为ipvs,解决pod和service的调度方式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe br_netfilter   加载模块<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF<br><span class="hljs-meta">#!/bin/bash</span><br>modprobe -- ip_vs<br>modprobe -- ip_vs_rr<br>modprobe -- ip_vs_wrr<br>modprobe -- ip_vs_sh<br>modprobe -- nf_conntrack_ipv4<br>EOF<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4<br></code></pre></td></tr></tbody></table></figure><p>12、安装 Docker 软件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">  yum install -y yum-utils device-mapper-persistent-data lvm2<br><br>yum-config-manager \<br>--add-repo \<br>http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br> yum update -y &amp;&amp; yum install -y docker-ce<br> systemctl restart  docker  &amp;&amp; systemctl  <span class="hljs-built_in">enable</span>  docker<br> uname  -r<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 创建 /etc/docker 目录</span><br>mkdir /etc/docker<br> <br><span class="hljs-comment"># 配置 daemon.</span><br>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>{<br>  <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],<br>  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,<br>  <span class="hljs-string">"log-opts"</span>: {<br>    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span><br>  }<br>}<br>EOF<br><br>   mkdir -p /etc/systemd/system/docker.service.d<br></code></pre></td></tr></tbody></table></figure><p>13、  # 重启docker服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl <span class="hljs-built_in">enable</span> docker<br></code></pre></td></tr></tbody></table></figure><p>修改/etc/docker/daemon.json的文件  并且发送到其他节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">{<br>  <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],<br>  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,<br>  <span class="hljs-string">"log-opts"</span>: {<br>    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span><br>  },<br>  <span class="hljs-string">"insecure-registries"</span>:[<span class="hljs-string">"https://hub.atguigu.com"</span>]<br>}<br><br> scp  /etc/docker/daemon.json   10.0.0.10:/etc/docker/daemon.json<br>  scp  /etc/docker/daemon.json   10.0.0.20:/etc/docker/daemon.json<br>  scp  /etc/docker/daemon.json   10.0.0.21:/etc/docker/daemon.json<br></code></pre></td></tr></tbody></table></figure><p>重启docker(所有节点)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart docker systemctl restart docker<br></code></pre></td></tr></tbody></table></figure><p>导入docker-compose文件 并赋予执行权限</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"> mv docker-compose /usr/<span class="hljs-built_in">local</span>/<br> <span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/<br> ll docker-compose <br>mv docker-compose   /usr/<span class="hljs-built_in">local</span>/bin/<br> chmod  a+x   /usr/<span class="hljs-built_in">local</span>/bin/docker-compose<br></code></pre></td></tr></tbody></table></figure><p>链接：<a href="https://pan.baidu.com/s/1H5zIMIoFCzip9T34mEe1mQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1H5zIMIoFCzip9T34mEe1mQ</a><br>提取码：xdfg<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p><p>导入包，解压并修改文件<br>链接：<a href="https://pan.baidu.com/s/12fmXkfSV7Ar-bNAlHyLINQ" target="_blank" rel="noopener">https://pan.baidu.com/s/12fmXkfSV7Ar-bNAlHyLINQ</a><br>提取码：85q0</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxvf  harbor-offline-installer-v1.2.0.tgz <br>  vim harbor.cfg <br>  修改内容<br>  hostname = hub.atguigu.com<br>  ui_url_protocol = https<br><br>创建存放证书的目录  <br>  <br>  mkdir  /data/cert/<br>  mkdir  /data/cert/ -p<br><span class="hljs-built_in">cd</span> /data/cert/<br><br>openssl genrsa -des3  -out server.key 2048<br><br>cat server.key <br>openssl  req -new  -key  server.key  -oout  server.csr<br> openssl  req -new  -key  server.key  -out  server.csr<br>cp  server.key  server.key.org<br>openssl rsa -<span class="hljs-keyword">in</span> server.key.org  -out  server.key<br>openssl  x509 -req -days  365  -<span class="hljs-keyword">in</span> server.csr -signkey server.key -out server.crt<br>chmod a+x *<br>./install.sh  执行脚本<br></code></pre></td></tr></tbody></table></figure><p>等到脚本执行完成 在本地win中添加解析</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.100 hub.atguigu.com<br></code></pre></td></tr></tbody></table></figure><p>docker登录测试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost harbor]<span class="hljs-comment"># docker login  https://hub.atguigu.com</span><br>Username: admin<br>Password: <br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br>密码：<br>Harbor12345<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607172321212.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br>（哔哩哔哩观看尚硅谷视频学习时写的博客）</p><p>docker  pull wangyanglinux/myapp:v1<br>下载一个镜像（汪洋的）<br>push到harbor中</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker tag  wangyanglinux/myapp:v1  hub.atguigu.com/library/myapp:v1 <br>docker push   hub.atguigu.com/library/myapp:v1<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/2020060717235312.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>在kubernetes中启动一个deployment进行测试镜像是否能被调用<br>命令行方式启动一个deployment</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   run nginx-deployment  --image=hub.atguigu.com/library/myapp:v1 --port=80 --replicas=1<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"> kubectl   run <br>nginx-deployment    指定deployment的名字<br>--image=hub.atguigu.com/library/myapp:v1   指定使用的镜像<br>--port=80   指定暴露的端口（其实不指定也没事；因为是在扁平化的网络中）<br>--replicas=1   指定副本数为1个<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">查看deployment<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get deployment</span><br>NAME               READY   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   0/1     1            0           16s<br>查看rs （deployment 通过rs控制pod）<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get rs</span><br>NAME                         DESIRED   CURRENT   READY   AGE<br>nginx-deployment-85756b779   1         1         1       23s<br>[root@k8s-master ~]<span class="hljs-comment"># </span><br>查看pod<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get pod</span><br>NAME                               READY   STATUS    RESTARTS   AGE<br>nginx-deployment-85756b779-bqjqg   1/1     Running   0          29s<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get pod -o wide</span><br>NAME                               READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES<br>nginx-deployment-85756b779-bqjqg   1/1     Running   0          41s   10.244.2.2   k8s-node02   &lt;none&gt;           &lt;none&gt;<br>访问一下 （通过扁平化的网络方式）<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.244.2.2</span><br>Hello MyApp | Version: v1 | &lt;a href=<span class="hljs-string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.244.2.2/hostname.html</span><br>nginx-deployment-85756b779-bqjqg<br>[root@k8s-master ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">命令行方式添加deployment的副本数<br>kubectl  scale --replicas=3 deployment/nginx-deployment<br></code></pre></td></tr></tbody></table></figure><p>如何访问这三个nginx的pod<br>通过svc<br>创建一个svc</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   expose  deployment  nginx-deployment  --port=30000 --target-port=80<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   expose  <br>deployment   指定类型为deployment<br>nginx-deployment    指定deployment的名字<br>--port=30000   指定宿主机的端口<br>--target-port=80   指定pod的端口<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">创建svc<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl   expose  deployment  nginx-deployment  --port=30000 --target-port=80</span><br>service/nginx-deployment exposed<br>查看svc的地址<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get  svc  -o wide</span><br>NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE    SELECTOR<br>kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP     7h6m   &lt;none&gt;<br>nginx-deployment   ClusterIP   10.105.52.122   &lt;none&gt;        30000/TCP   2m4s   run=nginx-deployment<br>访问测试<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.105.52.122:30000</span><br>Hello MyApp | Version: v1 | &lt;a href=<span class="hljs-string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;<br>[root@k8s-master ~]<span class="hljs-comment"># </span><br>默认轮询的方式进行负载<br></code></pre></td></tr></tbody></table></figure><p>查看地址规则</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  ipvsadm-1.27-8.el7.x86_64<br>[root@k8s-master ~]<span class="hljs-comment"># ipvsadm -Ln |grep  10.105.52.122 </span><br>TCP  10.105.52.122:30000 rr<br></code></pre></td></tr></tbody></table></figure><p>调度的机制是使用调度ipvs模块来实现负载均衡</p><p>这是内部地址 不能被外部访问</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># kubectl  get  svc</span><br>NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE<br>kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP     7h14m<br>nginx-deployment   ClusterIP   10.105.52.122   &lt;none&gt;        30000/TCP   9m50s<br></code></pre></td></tr></tbody></table></figure><p>修改svc的方式为</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   edit  svc  nginx-deployment<br>修改  ClusterIP    方式为  NodePort<br>  <span class="hljs-built_in">type</span>: NodePort<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl  get  svc</span><br>NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)           AGE<br>kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP           7h17m<br>nginx-deployment   NodePort    10.105.52.122   &lt;none&gt;        30000:30048/TCP   12m<br></code></pre></td></tr></tbody></table></figure><p>查看端口</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># netstat  -anpt |grep  :30048</span><br>tcp6       0      0 :::30048                :::*                    LISTEN      100907/kube-proxy   <br>[root@k8s-master ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>所有节点都暴露这个端口 30048</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200607172609194.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kubeadm安装k8s 1.15版</title>
      <link href="/2020/06/07/kubeadm%E5%AE%89%E8%A3%85k8s%201.15%E7%89%88/"/>
      <url>/2020/06/07/kubeadm%E5%AE%89%E8%A3%85k8s%201.15%E7%89%88/</url>
      
        <content type="html"><![CDATA[<p>前提：<br>1、安装 k8s 的节点必须是大于 1 核心的 CPU<br>2、阿里云的repo 和base源</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br></code></pre></td></tr></tbody></table></figure><p>1、设置系统主机名以及host解析</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl  <span class="hljs-built_in">set</span>-hostname  k8s-master<br>10.0.0.20 k8s-node01<br>10.0.0.21 k8s-node02  <br>10.0.0.10 k8s-master<br></code></pre></td></tr></tbody></table></figure><p>2、安装依赖包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  conntrack ntpdate  ntp  ipvsadmin ipset  jq iptables  curl  sysstat  libseccomp wget  vim   net-tools git<br></code></pre></td></tr></tbody></table></figure><p>3、设置防火墙为 Iptables 并设置空规则</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl  stop firewalld  &amp;&amp;  systemctl  <span class="hljs-built_in">disable</span> firewalld<br> yum -y install iptables-services  &amp;&amp;  systemctl  start iptables  &amp;&amp;  systemctl  <span class="hljs-built_in">enable</span> iptables  &amp;&amp;  iptables -F  &amp;&amp;  service iptables save<br></code></pre></td></tr></tbody></table></figure><p>4、关闭selinux 关闭swap<br>开启虚拟内存时 如果pod在swap中运行  那么kubernetes出现报错</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">swapoff -a &amp;&amp; sed -i <span class="hljs-string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab<br>setenforce 0 &amp;&amp; sed -i <span class="hljs-string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config<br></code></pre></td></tr></tbody></table></figure><p>5、调整内核参数，对于 K8S</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; kubernetes.conf &lt;&lt;EOF<br>net.bridge.bridge-nf-call-iptables=1    <span class="hljs-comment">#开启网桥模式</span><br>net.bridge.bridge-nf-call-ip6tables=1    <span class="hljs-comment">#开启网桥模式</span><br>net.ipv4.ip_forward=1<br>net.ipv4.tcp_tw_recycle=0<br>vm.swappiness=0 <span class="hljs-comment"># 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br>vm.overcommit_memory=1 <span class="hljs-comment"># 不检查物理内存是否够用</span><br>vm.panic_on_oom=0 <span class="hljs-comment"># 开启 OOM  </span><br>fs.inotify.max_user_instances=8192<br>fs.inotify.max_user_watches=1048576<br>fs.file-max=52706963<br>fs.nr_open=52706963<br>net.ipv6.conf.all.disable_ipv6=1   <span class="hljs-comment">#关闭ipv6</span><br>net.netfilter.nf_conntrack_max=2310720<br>EOF<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf  开机调用<br>sysctl -p /etc/sysctl.d/kubernetes.conf    立刻生效<br></code></pre></td></tr></tbody></table></figure><p>6、调整系统时区</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置系统时区为 中国/上海</span><br>timedatectl <span class="hljs-built_in">set</span>-timezone Asia/Shanghai<br><span class="hljs-comment"># 将当前的 UTC 时间写入硬件时钟</span><br>timedatectl <span class="hljs-built_in">set</span>-local-rtc 0<br><span class="hljs-comment"># 重启依赖于系统时间的服务</span><br>systemctl restart rsyslog <br>systemctl restart crond<br></code></pre></td></tr></tbody></table></figure><p>7、关闭系统不需要服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop postfix &amp;&amp; systemctl <span class="hljs-built_in">disable</span> postfix<br></code></pre></td></tr></tbody></table></figure><p>8、设置 rsyslogd 和 systemd journald<br>使用日志为 journald  方式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /var/<span class="hljs-built_in">log</span>/journal <span class="hljs-comment"># 持久化保存日志的目录</span><br>mkdir /etc/systemd/journald.conf.d  创建配置文件存放目录<br></code></pre></td></tr></tbody></table></figure><p>创建journal 的日志配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF<br> [Journal]<br> <span class="hljs-comment"># 持久化保存到磁盘</span><br> Storage=persistent<br>  <br> <span class="hljs-comment"># 压缩历史日志</span><br> Compress=yes<br>  <br> SyncIntervalSec=5m<br> RateLimitInterval=30s<br> RateLimitBurst=1000<br>  <br> <span class="hljs-comment"># 最大占用空间 10G</span><br> SystemMaxUse=10G<br>  <br> <span class="hljs-comment"># 单日志文件最大 200M</span><br> SystemMaxFileSize=200M<br>  <br> <span class="hljs-comment"># 日志保存时间 2 周</span><br> MaxRetentionSec=2week<br>  <br> <span class="hljs-comment"># 不将日志转发到 syslog</span><br> ForwardToSyslog=no<br> EOF<br></code></pre></td></tr></tbody></table></figure><p>9、重启服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart systemd-journald<br></code></pre></td></tr></tbody></table></figure><p>10、升级系统内核为 4.44</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">CentOS 7.x 系统自带的 3.10.x 内核存在一些 Bugs，导致运行的 Docker、Kubernetes 不稳定，例如： rpm -Uvh<br>http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm<br></code></pre></td></tr></tbody></table></figure><p>升级</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm<br>   <span class="hljs-comment"># 安装完成后检查 /boot/grub2/grub.cfg 中对应内核 menuentry 中是否包含 initrd16 配置，如果没有，再安装</span><br>一次！<br>yum --enablerepo=elrepo-kernel install -y kernel<span class="hljs-_">-lt</span><br><span class="hljs-comment"># 设置开机从新内核启动</span><br>grub2-set-default <span class="hljs-string">'CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)'</span> &amp;&amp; reboot<br><br><br>uname  -r<br></code></pre></td></tr></tbody></table></figure><p>11、kube-proxy开启ipvs的前置条件</p><p>修改调度方式为ipvs,解决pod和service的调度方式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe br_netfilter   加载模块<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF<br><span class="hljs-meta">#!/bin/bash</span><br>modprobe -- ip_vs<br>modprobe -- ip_vs_rr<br>modprobe -- ip_vs_wrr<br>modprobe -- ip_vs_sh<br>modprobe -- nf_conntrack_ipv4<br>EOF<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4<br></code></pre></td></tr></tbody></table></figure><p>12、安装 Docker 软件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">  yum install -y yum-utils device-mapper-persistent-data lvm2<br><br>yum-config-manager \<br>--add-repo \<br>http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br> yum update -y &amp;&amp; yum install -y docker-ce<br> systemctl restart  docker  &amp;&amp; systemctl  <span class="hljs-built_in">enable</span>  docker<br> uname  -r<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 创建 /etc/docker 目录</span><br>mkdir /etc/docker<br> <br><span class="hljs-comment"># 配置 daemon.</span><br>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>{<br>  <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],<br>  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,<br>  <span class="hljs-string">"log-opts"</span>: {<br>    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span><br>  }<br>}<br>EOF<br><br>   mkdir -p /etc/systemd/system/docker.service.d<br></code></pre></td></tr></tbody></table></figure><p>13、  # 重启docker服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl <span class="hljs-built_in">enable</span> docker<br></code></pre></td></tr></tbody></table></figure><p>14、安装 Kubeadm （主从配置）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg <br>http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum -y  install  kubeadm-1.15.1 kubectl-1.15.1 kubelet-1.15.1<br>systemctl <span class="hljs-built_in">enable</span> kubelet.service<br></code></pre></td></tr></tbody></table></figure><p>导入镜像<br>每个节点都需要导入镜像<br>镜像下载<br>链接：<a href="https://pan.baidu.com/s/18UoPtPGM4XGZIpUYMW-zaQ" target="_blank" rel="noopener">https://pan.baidu.com/s/18UoPtPGM4XGZIpUYMW-zaQ</a><br>提取码：lcrb</p><p>15、初始化主节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">   kubeadm config <span class="hljs-built_in">print</span> init-defaults &gt; kubeadm-config.yaml<br><br>修改为一下内容：<br><br><br><br>apiVersion: kubeadm.k8s.io/v1beta2<br>bootstrapTokens:<br>- groups:<br>  - system:bootstrappers:kubeadm:default-node-token<br>  token: abcdef.0123456789abcdef<br>  ttl: 24h0m0s<br>  usages:<br>  - signing<br>  - authentication<br>kind: InitConfiguration<br>localAPIEndpoint:<br>  advertiseAddress: 10.0.0.10<br>  bindPort: 6443<br>nodeRegistration:<br>  criSocket: /var/run/dockershim.sock<br>  name: k8s-master<br>  taints:<br>  - effect: NoSchedule<br>    key: node-role.kubernetes.io/master<br>---<br>apiServer:<br>  timeoutForControlPlane: 4m0s<br>apiVersion: kubeadm.k8s.io/v1beta2<br>certificatesDir: /etc/kubernetes/pki<br>clusterName: kubernetes<br>controllerManager: {}<br>dns:<br>  <span class="hljs-built_in">type</span>: CoreDNS<br>etcd:<br>  <span class="hljs-built_in">local</span>:<br>    dataDir: /var/lib/etcd<br>imageRepository: k8s.gcr.io<br>kind: ClusterConfiguration<br>kubernetesVersion: v1.15.1<br>networking:<br>  dnsDomain: cluster.local<br>  podSubnet: <span class="hljs-string">"10.244.0.0/16"</span><br>  serviceSubnet: 10.96.0.0/12<br>scheduler: {}<br>---<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>kind: KubeProxyConfiguration<br>featureGates:<br>  SupportIPVSProxyMode: <span class="hljs-literal">true</span><br>mode: ipvs<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm init --config=kubeadm-config.yaml --experimental-upload-certs | tee kubeadm-init.log<br></code></pre></td></tr></tbody></table></figure><p>安装kubernetes日志文件解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[init] Using Kubernetes version: v1.15.1  版本信息<br>[preflight] Running pre-flight checks 检测当前运行环境<br>[preflight] Pulling images required <span class="hljs-keyword">for</span> setting up a Kubernetes cluster 下载镜像<br>[kubelet-start] Writing kubelet environment file with flags to file <span class="hljs-string">"/var/lib/kubelet/kubeadm-flags.env"</span> 存放kubernetes的环境变量<br>[kubelet-start] Writing kubelet configuration to file <span class="hljs-string">"/var/lib/kubelet/config.yaml"</span> kubernetes的配置文件<br>[certs] Using certificateDir folder <span class="hljs-string">"/etc/kubernetes/pki"</span> 存放kubernetes的证书<br>[certs] apiserver serving cert is signed <span class="hljs-keyword">for</span> DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.0.0.10]<br>设置默认的dns<br> [certs] Generating <span class="hljs-string">"front-proxy-ca"</span> certificate and key  密钥的生成<br>[certs] etcd/server serving cert is signed <span class="hljs-keyword">for</span> DNS names [k8s-master localhost] and IPs [10.0.0.10 127.0.0.1 ::1]  DNS的名称和地址<br>[kubeconfig] Using kubeconfig folder <span class="hljs-string">"/etc/kubernetes"</span>配置文件存放位置<br></code></pre></td></tr></tbody></table></figure><p>初始化后的操作</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir -p <span class="hljs-variable">$HOME</span>/.kube   当前家目录下创建.kube的目录<br>sudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config    拷贝管理员的配置文件到.kube<br>sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config  赋予属主属组的权限<br></code></pre></td></tr></tbody></table></figure><p>此时查看节点信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># kubectl  get node</span><br>NAME         STATUS     ROLES    AGE    VERSION<br>k8s-master   NotReady   master   9m4s   v1.15.1<br></code></pre></td></tr></tbody></table></figure><p>出现 NotReady 状态的原因是 kubernetes需要扁平化的网络，构建flannel网络</p><p>加入主节点以及其余工作节点<br>执行安装日志中的加入命令即可<br>16、部署网络</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">/root/install-k8s/plugin/flannel<br><span class="hljs-built_in">cd</span>  /root/install-k8s/plugin/flannel<br>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br></code></pre></td></tr></tbody></table></figure><p>下载下来之后（什么都不需要改）进行创建flannel网络</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"> kubectl  create -f  kube-flannel.yml <br><br><br>kubectl   get  pod  -n kube-system   查看是否执行成功<br><br><br> kubectl   get  node  再次查看 发现状态变为了Ready<br><br>kubectl   get  pod -n kube-system -o wide  查看<br><br>在node节点执行日志提示的加入信息<br><br><br>kubectl   get  node  全部都变为了Ready <br><br>kubectl   get  pod -n kube-system  -w  持续查看<br><br><br>搭建完成<br>[root@k8s-master ~]<span class="hljs-comment"># kubectl   get node</span><br>NAME         STATUS   ROLES    AGE     VERSION<br>k8s-master   Ready    master   26m     v1.15.1<br>k8s-node01   Ready    &lt;none&gt;   7m10s   v1.15.1<br>k8s-node02   Ready    &lt;none&gt;   7m7s    v1.15.1<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>zabbix ReplicationController模板</title>
      <link href="/2020/06/03/zabbix%20ReplicationController%E6%A8%A1%E6%9D%BF/"/>
      <url>/2020/06/03/zabbix%20ReplicationController%E6%A8%A1%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<p>在11节点执行如下的yaml文件  分别是zabbix的rc文件和zabbix的svc文件</p><p>在13节点 上传rc中所需要的镜像  因为使用分配策略时指定了是在13节点本地获取镜像  如果有 就不从私有仓库拉去镜像</p><p>always ：总是从镜像仓库上拉取最新镜像<br>never：从不从私有仓库拉取镜像<br>ifnotpresent：如果本地有镜像，就不从私有仓库拉取镜像</p><p>多个服务写在一个资源yaml中<br>三个短横杆隔开</p><p><strong>zabbix-rc.yml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: mysql-server<br>spec:<br>  replicas: 1<br>  selector:<br>    app: mysql-server<br>  template:<br>    metadata:<br>      labels:<br>        app: mysql-server<br>    spec:<br>      nodeName: 10.0.0.13<br>      containers:<br>        - name: mysql<br>          image: 10.0.0.11:5000/mysql:5.7<br>          imagePullPolicy: IfNotPresent<br>          ports:<br>          - containerPort: 3306<br>          args: [<span class="hljs-string">"--character-set-server=utf8"</span>,<span class="hljs-string">"--collation-server=utf8_bin"</span>]<br>          env:<br>          - name: MYSQL_ROOT_PASSWORD<br>            value: <span class="hljs-string">'root_pwd'</span><br>          - name: MYSQL_DATABASE<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_USER<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_PASSWORD<br>            value: <span class="hljs-string">'zabbix_pwd'</span><br>---<br>apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: zabbix-java-gateway<br>spec:<br>  replicas: 1<br>  selector:<br>    app: zabbix-java-gateway<br>  template:<br>    metadata:<br>      labels:<br>        app: zabbix-java-gateway<br>    spec:<br>      nodeName: 10.0.0.13<br>      containers:<br>        - name: zabbix-java-gateway<br>          imagePullPolicy: IfNotPresent<br>          image: 10.0.0.11:5000/zabbix-java-gateway:latest<br>---<br>apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: zabbix-server<br>spec:<br>  replicas: 1<br>  selector:<br>    app: zabbix-server<br>  template:<br>    metadata:<br>      labels:<br>        app: zabbix-server<br>    spec:<br>      nodeName: 10.0.0.13<br>      containers:<br>        - name: zabbix-server<br>          imagePullPolicy: IfNotPresent<br>          image: 10.0.0.11:5000/zabbix-server-mysql:latest<br>          ports:<br>          - containerPort: 10051<br>          env:<br>          - name: DB_SERVER_HOST<br>            value: <span class="hljs-string">'mysql-server'</span><br>          - name: MYSQL_DATABASE<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_USER<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_PASSWORD<br>            value: <span class="hljs-string">'zabbix_pwd'</span><br>          - name: MYSQL_ROOT_PASSWORD<br>            value: <span class="hljs-string">'root_pwd'</span><br>          - name: ZBX_JAVAGATEWAY<br>            value: <span class="hljs-string">'zabbix-java-gateway'</span><br>---<br>apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: zabbix-web-nginx-mysql<br>spec:<br>  replicas: 1<br>  selector:<br>    app: zabbix-web-nginx-mysql<br>  template:<br>    metadata:<br>      labels:<br>        app: zabbix-web-nginx-mysql<br>    spec:<br>      nodeName: 10.0.0.13<br>      containers:<br>        - name: zabbix-web-nginx-mysql<br>          imagePullPolicy: IfNotPresent<br>          image: 10.0.0.11:5000/zabbix-web-nginx-mysql:latest<br>          ports:<br>          - containerPort: 80<br>          env:<br>          - name: DB_SERVER_HOST<br>            value: <span class="hljs-string">'mysql-server'</span><br>          - name: MYSQL_DATABASE<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_USER<br>            value: <span class="hljs-string">'zabbix'</span><br>          - name: MYSQL_PASSWORD<br>            value: <span class="hljs-string">'zabbix_pwd'</span><br>          - name: MYSQL_ROOT_PASSWORD<br>            value: <span class="hljs-string">'root_pwd'</span><br></code></pre></td></tr></tbody></table></figure><p><strong>zabbix-svc.yml</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: mysql-server<br>spec:<br>  ports:<br>    - port: 3306<br>      targetPort: 3306<br>  selector:<br>    app: mysql-server<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: zabbix-java-gateway<br>spec:<br>  ports:<br>    - port: 10052<br>      targetPort: 10052<br>  selector:<br>    app: zabbix-java-gateway<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: zabbix-server<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>    - port: 10051<br>      nodePort: 10051<br>      targetPort: 10051<br>  selector:<br>    app: zabbix-server<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: zabbix-web-nginx-mysql<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>    - port: 80<br>      nodePort: 30007<br>      targetPort: 80<br>  selector:<br>    app: zabbix-web-nginx-mysql<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Deployment 模板</title>
      <link href="/2020/06/03/Kubernetes%20Deployment%20%E6%A8%A1%E6%9D%BF/"/>
      <url>/2020/06/03/Kubernetes%20Deployment%20%E6%A8%A1%E6%9D%BF/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1  <span class="hljs-comment">#版本号</span><br>kind: Pod    <span class="hljs-comment"># kind定义这个一个pod资源</span><br>metadata:<br>  name: myweb   <span class="hljs-comment">#定义pod名字</span><br>  namespace: string <span class="hljs-comment">#命名空间</span><br>  labels:       <span class="hljs-comment">#定义标签</span><br>    name:myweb<br>spec:     <span class="hljs-comment">#定义pod里容器属性</span><br>  containers:<br>  - name: myweb   <span class="hljs-comment">#定义容器名</span><br>    image: kuberguide/tomcat-app:v1   <span class="hljs-comment">#定义容器使用镜像</span><br>    imagePullPolicy:[Always|Never|IfNotPresent]每次都重新下载镜像|仅使用本地镜像|先使用本地镜像，不存在再下载镜像。默认每次重新下载镜像Always<br>    <span class="hljs-built_in">command</span>:[string] <span class="hljs-comment">#容器启动命令列表</span><br>    args:[string]<span class="hljs-comment">#容器启动命令参数列表</span><br>    workingDir:string <span class="hljs-comment">#容器工作目录</span><br>    volumeMounts: <span class="hljs-comment">#挂载到容器的存储卷</span><br>      - name: string  <span class="hljs-comment">#使用pod定义的共享存储卷名称</span><br>        mountPath:string 存储卷在容器内挂载的绝对路径，应少于512字符<br>  ports:      <span class="hljs-comment">#定义容器开放暴露的端口号列表</span><br>  - containerPort: 8080   <span class="hljs-comment">#定义pod对外开放的服务端口号，容器要监听的端口</span><br>  env:    <span class="hljs-comment">#定义容器变量列表</span><br>  - name: MYSQL_SERVICE_HOST<br>    value: <span class="hljs-string">'mysql'</span><br>  resources: <span class="hljs-comment">#资源限制设置</span><br>    limits:  <br>      cpu: string   <span class="hljs-comment">#容器启动后最多可用CPU核数。</span><br>      memory:string  <span class="hljs-comment">#容器启动最多可用内存数 单位MiB、GiB</span><br>    requests:<span class="hljs-comment">#最低启动限制设置</span><br>      cpu: string  <span class="hljs-comment">#最低容器启动可用CPU核数。</span><br>      memory:string  <span class="hljs-comment">#最低容器启动可用内存数 单位MiB、GiB</span><br>  restartPolicy:[Always|Never|OnFailure]<span class="hljs-comment">#pod重启策略，一旦终止立即重启|终止后报告错误后不再重启|只有非0错误码终止才重启其他不重启。默认Always</span><br>  nodeSelector: <span class="hljs-comment">#设置调度pod到指定这里配置的labe的Node上</span><br>    标签key:标签value<br>  imagePullSecrets: <span class="hljs-comment">#拉取镜像时使用的秘钥信息</span><br>    - key:string <br>  volumes: <span class="hljs-comment">#pod的共享存储卷列表</span><br>    - name: string <span class="hljs-comment">#存储卷名，唯一</span><br>      emptyDir:{}  <span class="hljs-comment">#存储卷类型，生命周期和pod相同，临时目录</span><br>      hostPath:    <span class="hljs-comment">#存储卷类型，表示从宿主机目录上挂载</span><br>        path: string  <span class="hljs-comment">#使用的宿主机目录</span><br>      secret:  <span class="hljs-comment">#存储卷类型。</span><br>        secretName: string<br>        items:<br>          - key: string<br>            path: stirng<br>      configMap:  <span class="hljs-comment">#存储卷类型</span><br>        name: string<br>        items:<br>          - key: string<br>            path: sting<br>  livenessProbe: <span class="hljs-comment">#Pod内容器健康检查设置，无响应之后自动重启该容器</span><br>    <span class="hljs-built_in">exec</span>: <span class="hljs-comment">#检查类型，仅需使用其中一种。</span><br>      <span class="hljs-built_in">command</span>:[string]  <span class="hljs-comment">#命令或脚本</span><br>    httpGet: <span class="hljs-comment">#检查类型，仅需使用其中一种。</span><br>      path: string<br>      port: number<br>      host: string<br>      scheme: string<br>      httpHeaders:<br>      - name: string<br>        value: string<br>    tcpSocket:  <span class="hljs-comment">#检查类型，仅需使用其中一种</span><br>      port: number<br>    initialDelaySeconds:0 <span class="hljs-comment">#容器重启完成后，首次探测的间隔时间单位秒</span><br>    timeoutSeconds:0 <span class="hljs-comment">#容器探测等待响应超时时间，单位秒。默认1秒，超时认为不健康重启</span><br>    periodSeconds:0 <span class="hljs-comment">#容器探测间隔时间，单位秒，默认10秒。</span><br>    successThreshold:0<br>    failureThreshold:0<br>    securityContext:<br>      privileged: <span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes安装部署</title>
      <link href="/2020/06/02/kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2020/06/02/kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p><a href="https://images.cnblogs.com/cnblogs_com/liushiya/1778423/o_20060116390401.jpg" target="_blank" rel="noopener">https://images.cnblogs.com/cnblogs_com/liushiya/1778423/o_20060116390401.jpg</a></p><p>kubernetes 分为两个节点  master 和node节点<br>可以有多个node节点；master 可以有两个 做高可用<br>master 节点只是管理功能  真正运行容器的是在node节点</p><p>1、如何控制kubernetes   都是由master的节点的api-server 服务接受请求  进行分配<br>2、如果是在kubernetes 中创建资源  首先会在api-server接受请求后  会在etcd数据库（nosql）中加入此资源<br>3、scheduler调度器   启动容器  会调度分配  查看各个节点的信息  在那个节点上启用容器比较合适<br>4、在node节点的kubelet 本身没有容器技术  调用docker创建容器，如果docker启动失败  那么kubelet 也会创建失败<br>5、容器都被封装在pod资源里面  通过pod资源进行管理容器<br>6、cadvisor 被集成在kubelet中  是一个监控组件  进行监控容器<br>7、plugin  network  网络查看  容器的跨宿主机间的通讯<br>8、controller  manager  保证指定数量的容器始终运行 某个节点的容器挡掉了  但是会有其他的节点容器顶上来  进行自动修复<br>9、容器如何被外界访问   用户访问kube-proxy  然后kube-proxy做负载均衡  将请求分发到不同的node的容器上面  主要是实现服务的自动发现 以及 负载均衡</p><p>master节点有四个服务：<br>1、api-server<br>2、controller manager  保证有指定数量的容器始终运行<br>3、scheduler 调度 选择合适的node创建资源<br>4、etcd数据库  存储数据</p><p>node节点：<br>1、kubelet 组件  docker作为kubelet的依赖被装上<br>2、kube-proxy  可以装也可以不装   做负载均衡高可用作用</p><p>kubernetes的其他组件：都是可以使用容器再运行的</p><h2 id="kubernetes的安装部署（yum方式）">kubernetes的安装部署（yum方式）</h2><p><strong>1、修改IP地址、主机名和hosts解析</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">10.0.0.11  k8s-master<br>10.0.0.12  k8s-node-1<br>10.0.0.13  k8s-node-2<br></code></pre></td></tr></tbody></table></figure><p>所有节点需要做hosts解析</p><p><strong>2、master节点安装etcd</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install etcd -y<br><br>vim /etc/etcd/etcd.conf<br>6行：ETCD_LISTEN_CLIENT_URLS=<span class="hljs-string">"http://0.0.0.0:2379"</span>  <br>21行：ETCD_ADVERTISE_CLIENT_URLS=<span class="hljs-string">"http://10.0.0.11:2379"</span>  <br><br>systemctl start etcd.service<br>systemctl <span class="hljs-built_in">enable</span> etcd.service<br><br>测试etcd数据库是否可用<br>etcdctl <span class="hljs-built_in">set</span> testdir/testkey0 0<br>etcdctl get testdir/testkey0<br><br>etcdctl -C http://10.0.0.11:2379 cluster-health<br></code></pre></td></tr></tbody></table></figure><p>etcd 原生态支持做集群，监听2379端口 2380端口做数据同步使用的 如果只是一个etcd节点的话 不做数据同步；key vue 方式存储数据</p><p>监测集群是否健康的命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># etcdctl  -C  http://10.0.0.11:2379 cluster-health</span><br>member 8e9e05c52164694d is healthy: got healthy result from http://10.0.0.11:2379<br>cluster is healthy<br></code></pre></td></tr></tbody></table></figure><p>etcd配置文件解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ETCD_DATA_DIR=<span class="hljs-string">"/var/lib/etcd/default.etcd"</span>  数据存放位置<br>ETCD_LISTEN_CLIENT_URLS=<span class="hljs-string">"http://0.0.0.0:2379"</span>  数据库的监听地址  允许所有节点连接<br>ETCD_ADVERTISE_CLIENT_URLS=<span class="hljs-string">"http://10.0.0.11:2379"</span>etcd数据库的名字  每个节点都不相同<br></code></pre></td></tr></tbody></table></figure><p><strong>3、master节点安装kubernetes 服务</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install kubernetes-master.x86_64 -y<br><br>vim /etc/kubernetes/apiserver <br>8行:  KUBE_API_ADDRESS=<span class="hljs-string">"--insecure-bind-address=0.0.0.0"</span><br>11行：KUBE_API_PORT=<span class="hljs-string">"--port=8080"</span><br>14行: KUBELET_PORT=<span class="hljs-string">"--kubelet-port=10250"</span><br>17行：KUBE_ETCD_SERVERS=<span class="hljs-string">"--etcd-servers=http://10.0.0.11:2379"</span><br>23行：KUBE_ADMISSION_CONT：ROL=<span class="hljs-string">"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota"</span><br><br>vim /etc/kubernetes/config<br>22行：KUBE_MASTER=<span class="hljs-string">"--master=http://10.0.0.11:8080"</span>   <br><br>systemctl <span class="hljs-built_in">enable</span> kube-apiserver.service<br>systemctl restart kube-apiserver.service<br>systemctl <span class="hljs-built_in">enable</span> kube-controller-manager.service<br>systemctl restart kube-controller-manager.service<br>systemctl <span class="hljs-built_in">enable</span> kube-scheduler.service<br>systemctl restart kube-scheduler.service<br></code></pre></td></tr></tbody></table></figure><p>检查服务是否正常</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># kubectl get componentstatus</span><br>NAME                 STATUS    MESSAGE             ERROR<br>controller-manager   Healthy   ok<br>scheduler            Healthy   ok<br>etcd-0               Healthy   {<span class="hljs-string">"health"</span>:<span class="hljs-string">"true"</span>}<br>[root@k8s-master ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>为什么服务列表里面没有apiserver ？<br>因为apiserver是接受命令的 如果apiserver宕掉  那么执行任何命令都会报错</p><p>api-server的配置文件解释：/etc/kubernetes/apiserver</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">KUBE_API_ADDRESS=<span class="hljs-string">"--insecure-bind-address=0.0.0.0"</span> 监听地址<br>KUBE_API_PORT=<span class="hljs-string">"--port=8080"</span> 监听端口  8080<br>KUBELET_PORT=<span class="hljs-string">"--kubelet-port=10250"</span> kubelet的监听端口<br>KUBE_ETCD_SERVERS=<span class="hljs-string">"--etcd-servers=http://10.0.0.11:2379"</span> 指定etcd集群的节点<br>KUBE_SERVICE_ADDRESSES=<span class="hljs-string">"--service-cluster-ip-range=10.254.0.0/16"</span>kubernetes的server资源vip地址范围<br>KUBE_ADMISSION_CONTROL=<span class="hljs-string">"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota"</span>kubernetes的管<br></code></pre></td></tr></tbody></table></figure><p>扩展：<br>1、etcd可以单独安装在一个节点<br>2、scheduler和controller-manager共用一个配置文件：/etc/kubernetes/config<br>解释：<br>–master地址 一般就是apiserver服务的节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">KUBE_LOGTOSTDERR=<span class="hljs-string">"--logtostderr=true"</span>日志存放在manager中<br>KUBE_LOG_LEVEL=<span class="hljs-string">"--v=0"</span>默认开启debug模式<br>KUBE_ALLOW_PRIV=<span class="hljs-string">"--allow-privileged=false"</span> 是否允许运行特权容器<br>KUBE_MASTER=<span class="hljs-string">"--master=http://10.0.0.11:8080"</span>帮助 controller-manager找到apiserv<br></code></pre></td></tr></tbody></table></figure><p><strong>node节点安装</strong><br>kube-proxy 使用的配置文件也是 /etc/kubernetes/config<br>默认会把docker作为依赖安装上</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install kubernetes-node.x86_64 -y<br><br>vim /etc/kubernetes/config <br>22行：KUBE_MASTER=<span class="hljs-string">"--master=http://10.0.0.11:8080"</span><br><br>vim /etc/kubernetes/kubelet<br>5行：KUBELET_ADDRESS=<span class="hljs-string">"--address=0.0.0.0"</span><br>8行：KUBELET_PORT=<span class="hljs-string">"--port=10250"</span><br>11行：KUBELET_HOSTNAME=<span class="hljs-string">"--hostname-override=10.0.0.12"</span><br>14行：KUBELET_API_SERVER=<span class="hljs-string">"--api-servers=http://10.0.0.11:8080"</span><br><br>systemctl <span class="hljs-built_in">enable</span> kubelet.service<br>systemctl restart kubelet.service<br>systemctl <span class="hljs-built_in">enable</span> kube-proxy.service<br>systemctl restart kube-proxy.service<br></code></pre></td></tr></tbody></table></figure><p>在master节点检查是否已经将node节点加入进来</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master ~]<span class="hljs-comment"># kubectl get nodes</span><br>NAME        STATUS    AGE<br>10.0.0.12   Ready     12h<br>10.0.0.13   Ready     12h<br></code></pre></td></tr></tbody></table></figure><p>配置文件作用解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/etc/kubernetes/config：<br>KUBE_MASTER=<span class="hljs-string">"--master=http://10.0.0.11:8080"</span>告诉node节点找到apiserver的地址<br></code></pre></td></tr></tbody></table></figure><p>etc/kubernetes/kubelet：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">KUBELET_ADDRESS=<span class="hljs-string">"--address=0.0.0.0"</span>node监听IP地址<br>KUBELET_PORT=<span class="hljs-string">"--port=10250"</span> 监听端口  和master保持一致<br>KUBELET_HOSTNAME=<span class="hljs-string">"--hostname-override=10.0.0.12"</span> 每个节点的名字<br>KUBELET_API_SERVER=<span class="hljs-string">"--api-servers=http://10.0.0.11:8080"</span> kubelet找apiserver的地址<br>基础容器的地址信息<br>KUBELET_POD_INFRA_CONTAINER=<span class="hljs-string">"--pod-infra-container-image=10.0.0.11:5000/docker.io/tianyebj/pod-infrastructure:latest"</span><br></code></pre></td></tr></tbody></table></figure><p><strong>所有节点安装flannel网络</strong><br>flannel插件的目的：实现容器跨宿主机进行通讯</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install flannel -y<br>sed -i <span class="hljs-string">'s#http://127.0.0.1:2379#http://10.0.0.11:2379#g'</span> /etc/sysconfig/flanneld<br><br><span class="hljs-comment">##master节点：</span><br>etcdctl mk /atomic.io/network/config   <span class="hljs-string">'{ "Network": "172.18.0.0/16" }'</span><br><br>yum install docker -y<br>systemctl <span class="hljs-built_in">enable</span> flanneld.service <br>systemctl restart flanneld.service <br>systemctl  restart  docker<br>systemctl  <span class="hljs-built_in">enable</span>  docker<br>systemctl restart kube-apiserver.service<br>systemctl restart kube-controller-manager.service<br>systemctl restart kube-scheduler.service<br><br><span class="hljs-comment">##node节点：</span><br>systemctl <span class="hljs-built_in">enable</span> flanneld.service <br>systemctl restart flanneld.service <br>systemctl  restart  docker<br>systemctl restart kubelet.service<br>systemctl restart kube-proxy.service<br><br>vim /usr/lib/systemd/system/docker.service<br><span class="hljs-comment">#在[Service]区域下增加一行（修改掉小bug）</span><br>ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT<br>systemctl daemon-reload <br>systemctl restart docker<br></code></pre></td></tr></tbody></table></figure><p>flannel网络是需要数据库（etcd）的  不会出现分配的IP地址出现冲突的问题<br>flannel网络的原理：会在docker下生成一个配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /usr/lib/systemd/system/docker.service.d/flannel.conf<br>[Service]<br>EnvironmentFile=-/run/flannel/docker<br></code></pre></td></tr></tbody></table></figure><p>docker的网段范围</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master systemd]<span class="hljs-comment"># cat /run/flannel/docker</span><br>DOCKER_OPT_BIP=<span class="hljs-string">"--bip=172.18.66.1/24"</span><br>DOCKER_OPT_IPMASQ=<span class="hljs-string">"--ip-masq=true"</span><br>DOCKER_OPT_MTU=<span class="hljs-string">"--mtu=1472"</span><br>DOCKER_NETWORK_OPTIONS=<span class="hljs-string">" --bip=172.18.66.1/24 --ip-masq=true --mtu=1472"</span><br></code></pre></td></tr></tbody></table></figure><p>flannel配置文件/etc/sysconfig/flanneld</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">FLANNEL_ETCD_ENDPOINTS=<span class="hljs-string">"http://10.0.0.11:2379"</span>etcd数据库的地址<br>FLANNEL_ETCD_PREFIX=<span class="hljs-string">"/atomic.io/network"</span> 配置flannel的key<br></code></pre></td></tr></tbody></table></figure><p><strong>配置master为镜像仓库</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#所有节点</span><br><br>vi /etc/docker/daemon.json<br>{<br><span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.docker-cn.com"</span>],<br><span class="hljs-string">"insecure-registries"</span>: [<span class="hljs-string">"10.0.0.11:5000"</span>]<br>}<br><br>systemctl restart docker<br><br><span class="hljs-comment">#master节点</span><br>docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry<br></code></pre></td></tr></tbody></table></figure><p>为什么要用镜像仓库  因为kubernetes启动容器时 使用的镜像就是使用的私有仓库</p><p><strong>kubernetes的功能：</strong><br>docker的集群管理工具  类似于kvm多了 使用OpenStack集群平台管理工具一样<br>kubernetes还是一个容器的编排工具<br>docker-compose也是容器的编排工具  区别在于 docker-compose是单机编排工具 （只能管理自己的容器）<br>kubernetes是集群编排管理工具</p><p>1、自愈:  重新启动失败的容器，在节点不可用时，替换和重新调度节点上的容器，对用户定义的健康检查不响应的容器会被中止，并且在容器准备好服务之前不会把其向客户端广播。<br>2、弹性伸缩:  通过监控容器的cpu的负载值,如果这个平均高于80%,增加容器的数量,如果这个平均低于10%,减少容器的数量<br>3、服务的自动发现和负载均衡: 不需要修改您的应用程序来使用不熟悉的服务发现机制，Kubernetes 为容器提供了自己的 IP 地址和一组容器的单个 DNS 名称，并可以在它们之间进行负载均衡。<br>4、滚动升级和一键回滚:    Kubernetes 逐渐部署对应用程序或其配置的更改，同时监视应用程序运行状况，以确保它不会同时终止所有实例。 如果出现问题，Kubernetes会为您恢复更改，利用日益增长的部署解决方案的生态系统。<br>5、私密配置文件管理. web容器里面,数据库的账户密码(测试库密码)</p><p><strong>k8s的安装方式</strong><br>yum安装    1.5    最容易安装成功，最适合学习的<br>源码编译安装—难度最大  可以安装最新版<br>二进制安装—步骤繁琐    可以安装最新版       shell,ansible,saltstack<br>kubeadm    安装最容易, 网络    可以安装最新版<br>minikube    适合开发人员体验k8s,  网络</p><p><strong>k8s的应用场景</strong><br>k8s最适合跑微服务项目!</p><p>微服务架构：微小的服务  是一种软件的开发架构   一个模块使用一套架构，微服务能够支撑足够大的用户；业务的稳定性更强；代码的更新发布更加快捷；对于运维来说  代码上线更复杂 节点变多，使用自动化代码上线</p><p>MVC架构：在微服务架构之前    MVC架构比较火  所有模块（秒杀、抢购等）都是一个站点，在站点中分目录  在一个站点中实现所有功能  用户访问量大的时候 容易扛不住</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes常用的资源</title>
      <link href="/2020/06/02/kubernetes%E5%B8%B8%E7%94%A8%E7%9A%84%E8%B5%84%E6%BA%90/"/>
      <url>/2020/06/02/kubernetes%E5%B8%B8%E7%94%A8%E7%9A%84%E8%B5%84%E6%BA%90/</url>
      
        <content type="html"><![CDATA[<p><strong>创建pod资源</strong></p><p>pod是最小资源单位.<br>任何的一个k8s资源都可以由yml清单文件来定义</p><p>k8s yaml的主要组成</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1  api版本<br>kind: pod   资源类型<br>metadata:   属性<br>spec:       详细<br></code></pre></td></tr></tbody></table></figure><p>master节点编写pod.yaml文档<br>vi  k8s_pod.yaml</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: nginx<br>  labels:<br>    app: web<br>spec:<br>  containers:<br>    - name: nginx<br>      image: 10.0.0.11:5000/nginx:1.13<br>      ports:<br>        - containerPort: 80<br></code></pre></td></tr></tbody></table></figure><p>创建pod资源并查看pod资源</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f k8s_pod.yml<br>kubectl get pod <br>kubectl describe pod nginx<br></code></pre></td></tr></tbody></table></figure><p>node节点:根据镜像的pod-infrastructure:latest       image的具体地址进行填写进行填写</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/kubernetes/kubelet<br>KUBELET_POD_INFRA_CONTAINER=<span class="hljs-string">"--pod-infra-container-image=10.0.0.11:5000/pod-infrastructure:latest"</span><br>systemctl restart kubelet.service<br></code></pre></td></tr></tbody></table></figure><p>查看是否启动成功</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pod -o  wide<br> kubectl describe pod nginx<br></code></pre></td></tr></tbody></table></figure><p><strong>pod和容器的关系：</strong><br>为什么创建一个pod资源，需要至少启动两个容器？<br>pod基础容器 实现k8s的高级功能+<br>nginx容器   实现业务功能</p><p><code>pod资源中，多个业务容器的端口不能冲突</code></p><p>pod资源:至少由两个容器组成,pod基础容器和业务容器组成(最多1+4)</p><p>只要创建一个pod资源，都会启动一个pod基础容器+pod资源中的业务容器</p><p>curl -I 172.18.78.2 访问pod的ip地址，pod里面的nginx可以被访问，nginx容器和pod-infrastructure<br>172.18.78.2 究竟是哪一个容器的ip地址？<br>172.18.78.2是pod基础容器的ip<br>nginx容器和pod基础容器共用ip地址</p><p><strong>ReplicationController资源</strong><br>rc:保证指定数量的pod始终存活,rc通过标签选择器来关联pod<br>启动5个相同的pod，pod 5个副本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: nginx<br>spec:<br>  replicas: 5  <span class="hljs-comment">#副本5</span><br>  selector:<br>    app: myweb<br>  template:  <span class="hljs-comment">#模板</span><br>    metadata:<br>      labels:<br>        app: myweb<br>    spec:<br>      containers:<br>      - name: myweb<br>        image: 10.0.0.11:5000/nginx:1.13<br>        ports:<br>        - containerPort: 80<br></code></pre></td></tr></tbody></table></figure><p>启动一个rc  并查看rc信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   create -f  k8s_rc.yaml<br>kubectl  get  rc<br></code></pre></td></tr></tbody></table></figure><p>删除一个  又会创建一个新的</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   delete  pod  nginx-9kstr<br></code></pre></td></tr></tbody></table></figure><p>每一个pod名字，必须唯一<br>k8s 不断的检查不可用的节点，驱逐pod</p><p>停止node节点的服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop  kubelet.service<br></code></pre></td></tr></tbody></table></figure><p>删除节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl  delete node   10.0.0.12<br></code></pre></td></tr></tbody></table></figure><p>会在另外的节点上新建  一直保持rc始终运行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@k8s-master rc]<span class="hljs-comment"># kubectl   get pod -o wide</span><br>NAME          READY     STATUS    RESTARTS   AGE       IP            NODE<br>nginx-1zgwx   1/1       Running   0          32s       172.18.10.8   10.0.0.13<br>nginx-kt27z   1/1       Running   0          8m        172.18.10.5   10.0.0.13<br>nginx-qq1sc   1/1       Running   0          32s       172.18.10.7   10.0.0.13<br>nginx-st72b   1/1       Running   0          8m        172.18.10.4   10.0.0.13<br>nginx-tvf09   1/1       Running   0          32s       172.18.10.6   10.0.0.13<br><span class="hljs-built_in">test</span>          2/2       Running   14         7h        172.18.10.2   10.0.0.13<br></code></pre></td></tr></tbody></table></figure><p>查看标签pod的</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   get pod -o wide   --show-labels<br></code></pre></td></tr></tbody></table></figure><p>查看节点使用那些标签</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl     get rc  -o wide<br></code></pre></td></tr></tbody></table></figure><p>修改pod 标签为myweb  会出现少了一个，删除了最年轻的</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   edit   pod  <span class="hljs-built_in">test</span><br></code></pre></td></tr></tbody></table></figure><p>宏观世界，pod都是同一秒创建<br>微观世界，pod创建相隔几毫米</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl   create  -f   xxx.yaml   创建资源<br>kubectl   get  pod|rc             查看某一个资源列表<br>kubectl  describe  pod  nginx      查看某一个具体资源的详细信息<br>kubectl  delete   pod  nginx        删除某一个具体资源<br> 或者kubectl delete  -f  xxx.yaml<br>kubectl  edit  pod   nginx          编辑某一个资源的配置文件<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>glance镜像服务</title>
      <link href="/2020/05/31/glance%E9%95%9C%E5%83%8F/"/>
      <url>/2020/05/31/glance%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<p>glance镜像服务<br>1、允许用户查看有哪些镜像列表<br>2、允许用户上传镜像<br>3、允许用户下载使用镜像</p><p>glance镜像服务组件：<br>1、glance-api （接受镜像接受API的调用，比如：发现  注册  存储）<br>2、glance-registry（修改镜像的属性信息）</p><h2 id="安装配置步骤：">安装配置步骤：</h2><p>1、创库授权</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE DATABASE glance;<br>GRANT ALL PRIVILEGES ON glance.* TO <span class="hljs-string">'glance'</span>@<span class="hljs-string">'localhost'</span> \<br>  IDENTIFIED BY <span class="hljs-string">'GLANCE_DBPASS'</span>;<br>GRANT ALL PRIVILEGES ON glance.* TO <span class="hljs-string">'glance'</span>@<span class="hljs-string">'%'</span> \<br>  IDENTIFIED BY <span class="hljs-string">'GLANCE_DBPASS'</span>;<br></code></pre></td></tr></tbody></table></figure><p>2、在keystone创建用户，关联角色<br>也就是在keystone数据库中增加一条数据</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack user create --domain default --password GLANCE_PASS glance<br>openstack role add --project service --user glance admin<br></code></pre></td></tr></tbody></table></figure><p>3、在keystone上创建服务，注册api</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack service create --name glance \<br>  --description <span class="hljs-string">"OpenStack Image"</span> image<br>openstack endpoint create --region RegionOne \<br>  image public http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image internal http://controller:9292<br>openstack endpoint create --region RegionOne \<br>  image admin http://controller:9292<br></code></pre></td></tr></tbody></table></figure><p>4、安装服务相关软件包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install openstack-glance -y<br></code></pre></td></tr></tbody></table></figure><p>5、修改配置<br>备份glance-api的配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp /etc/glance/glance-api.conf{,.bak}<br>grep <span class="hljs-string">'^[a-Z\[]'</span> /etc/glance/glance-api.conf.bak &gt;/etc/glance/glance-api.conf<br></code></pre></td></tr></tbody></table></figure><p>配置数据库的链接信息、keystone的认证信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  database  connection  mysql+pymysql://glance:GLANCE_DBPASS@controller/glance<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  glance_store stores  file,http<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  glance_store default_store  file<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  glance_store filesystem_store_datadir  /var/lib/glance/images/<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken auth_uri  http://controller:5000<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken auth_url  http://controller:35357<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken memcached_servers  controller:11211<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken auth_type  password<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken project_domain_name  default<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken user_domain_name  default<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken project_name  service<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken username  glance<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  keystone_authtoken password  GLANCE_PASS<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-api.conf  paste_deploy flavor  keystone<br></code></pre></td></tr></tbody></table></figure><p>备份配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cp /etc/glance/glance-registry.conf{,.bak}<br>grep <span class="hljs-string">'^[a-Z\[]'</span> /etc/glance/glance-registry.conf.bak &gt; /etc/glance/glance-registry.conf<br></code></pre></td></tr></tbody></table></figure><p>修改glance-registry的配置信息<br>配置数据库、配置keystone的认证信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  database  connection  mysql+pymysql://glance:GLANCE_DBPASS@controller/glance<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken auth_uri  http://controller:5000<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken auth_url  http://controller:35357<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken memcached_servers  controller:11211<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken auth_type  password<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken project_domain_name  default<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken user_domain_name  default<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken project_name  service<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken username  glance<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  keystone_authtoken password  GLANCE_PASS<br>openstack-config --<span class="hljs-built_in">set</span> /etc/glance/glance-registry.conf  paste_deploy flavor  keystone<br></code></pre></td></tr></tbody></table></figure><p>校验</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller ~]<span class="hljs-comment"># md5sum   /etc/glance/glance-registry.conf</span><br>46acabd81a65b924256f56fe34d90b8f  /etc/glance/glance-registry.conf<br>[root@controller ~]<span class="hljs-comment"># md5sum   /etc/glance/glance-api.conf</span><br>3e1a4234c133eda11b413788e001cba3  /etc/glance/glance-api.conf<br></code></pre></td></tr></tbody></table></figure><p>6、同步数据库，创建表信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">su -s /bin/sh -c <span class="hljs-string">"glance-manage db_sync"</span> glance<br>mysql glance -e <span class="hljs-string">"show tables;"</span><br></code></pre></td></tr></tbody></table></figure><p>7、启动服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> openstack-glance-api.service \<br>  openstack-glance-registry.service<br>systemctl start openstack-glance-api.service \<br>  openstack-glance-registry.service<br></code></pre></td></tr></tbody></table></figure><p>glance服务启动后监听9191 9292端口</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>keystone认证服务</title>
      <link href="/2020/05/30/OpenStack%E7%BB%84%E4%BB%B6%E4%B9%8Bkeystone%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1/"/>
      <url>/2020/05/30/OpenStack%E7%BB%84%E4%BB%B6%E4%B9%8Bkeystone%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p>keystone 认证服务<br>功能：认证管理  授权管理  服务目录</p><p>认证：账号密码<br>授权管理：为其他组件授权  qq授权其他应用的web页面登录<br>服务目录： 电话本功能</p><h2 id="安装keystone">安装keystone</h2><p><strong>创库授权</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">CREATE DATABASE keystone;<br>GRANT ALL PRIVILEGES ON keystone.* TO <span class="hljs-string">'keystone'</span>@<span class="hljs-string">'localhost'</span> \<br>  IDENTIFIED BY <span class="hljs-string">'KEYSTONE_DBPASS'</span>;<br>GRANT ALL PRIVILEGES ON keystone.* TO <span class="hljs-string">'keystone'</span>@<span class="hljs-string">'%'</span> \<br>  IDENTIFIED BY <span class="hljs-string">'KEYSTONE_DBPASS'</span>;<br></code></pre></td></tr></tbody></table></figure><p><strong>安装keystone相关软件包</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install openstack-keystone httpd mod_wsgi -y<br></code></pre></td></tr></tbody></table></figure><p>软件包解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack-keystone   OpenStack服务<br>httpd   Apache网站服务<br>mod_wsgi    Apache的扩展模块wsgi，用于python（OpenStack使用python编写）连接Apache<br></code></pre></td></tr></tbody></table></figure><p><strong>修改配置文件</strong><br>配置文件路径：/etc/keystone/keystone.conf</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install openstack-utils.noarch -y<br>\cp /etc/keystone/keystone.conf{,.bak}<br>grep -Ev <span class="hljs-string">'^$|#'</span> /etc/keystone/keystone.conf.bak &gt;/etc/keystone/keystone.conf<br>openstack-config --<span class="hljs-built_in">set</span> /etc/keystone/keystone.conf DEFAULT admin_token  ADMIN_TOKEN<br>openstack-config --<span class="hljs-built_in">set</span> /etc/keystone/keystone.conf database connection  mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone<br>openstack-config --<span class="hljs-built_in">set</span> /etc/keystone/keystone.conf token provider  fernet<br></code></pre></td></tr></tbody></table></figure><p><code>openstack-utils.noarch  用于OpenStack命令行方式修改配置文件</code></p><p><strong>校验</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller ~]<span class="hljs-comment"># md5sum /etc/keystone/keystone.conf</span><br>d5acb3db852fe3f247f4f872b051b7a9  /etc/keystone/keystone.conf<br></code></pre></td></tr></tbody></table></figure><p><strong>配置文件解释</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[DEFAULT]<br>admin_token = ADMIN_TOKEN<br>[database]<br>connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone<br>[token]<br>provider = fernet<br></code></pre></td></tr></tbody></table></figure><p><strong>[DEFAULT]</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">admin_token = ADMIN_TOKEN  在没有管理员时 使用admin的token进行 创建 注册 等操作<br></code></pre></td></tr></tbody></table></figure><p><strong>[database] 部分</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql+pymysql://     连接协议<br>keystone:KEYSTONE_DBPASS  连接数据库的账号密码  <br>@ <br>controller 连接数据库的主机  （controller 会使用本地解析为10.0.0.11）<br>/keystone   使用名为keystone的库<br></code></pre></td></tr></tbody></table></figure><p><strong>[token]部分</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">provider = fernet 定义令牌提供者  fernet生成的令牌方式<br></code></pre></td></tr></tbody></table></figure><p><strong>扩展部分</strong></p><p>keystone 认证方式：UUID 、  PKI 、Fernet<br>都是生成一段随机字符串的方法   保证唯一</p><p>token 就是一段随机字符串  用于标识服务，类似于linux用户的UUID 进程号码等</p><h2 id="同步数据库">同步数据库</h2><p>在同步数据库之前查看keystone的表</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller my.cnf.d]<span class="hljs-comment"># mysql keystone  -e   "show tables;"</span><br></code></pre></td></tr></tbody></table></figure><p>使用keystone身份同步数据库</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">su -s /bin/sh -c <span class="hljs-string">"keystone-manage db_sync"</span> keystone<br></code></pre></td></tr></tbody></table></figure><p>命令解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">su  切换用户  <br>-s  指定bash<br>-c 指定 运行的命令<br>keystone   用户<br>有些情况下  必须切换到指定用户身份下才可以执行命令<br> <br>keystone-manage是用来同keystone服务进行交互的命令行工具，通常该命令只用于不能通过HTTP API完成的操作<br>db_sync　　　　同步数据库<br></code></pre></td></tr></tbody></table></figure><p>检查</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mysql keystone -e <span class="hljs-string">'show tables;'</span><br></code></pre></td></tr></tbody></table></figure><p><strong>初始化fernet</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone<br></code></pre></td></tr></tbody></table></figure><p>会在/etc/keystone/目录下生成fernet-keys目录</p><h2 id="配置httpd">配置httpd</h2><p>优化HTTP服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"ServerName controller"</span> &gt;&gt;/etc/httpd/conf/httpd.conf<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-built_in">echo</span> <span class="hljs-string">'Listen 5000</span><br><span class="hljs-string">Listen 35357</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;VirtualHost *:5000&gt;</span><br><span class="hljs-string">    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}</span><br><span class="hljs-string">    WSGIProcessGroup keystone-public</span><br><span class="hljs-string">    WSGIScriptAlias / /usr/bin/keystone-wsgi-public</span><br><span class="hljs-string">    WSGIApplicationGroup %{GLOBAL}</span><br><span class="hljs-string">    WSGIPassAuthorization On</span><br><span class="hljs-string">    ErrorLogFormat "%{cu}t %M"</span><br><span class="hljs-string">    ErrorLog /var/log/httpd/keystone-error.log</span><br><span class="hljs-string">    CustomLog /var/log/httpd/keystone-access.log combined</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;Directory /usr/bin&gt;</span><br><span class="hljs-string">        Require all granted</span><br><span class="hljs-string">    &lt;/Directory&gt;</span><br><span class="hljs-string">&lt;/VirtualHost&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;VirtualHost *:35357&gt;</span><br><span class="hljs-string">    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}</span><br><span class="hljs-string">    WSGIProcessGroup keystone-admin</span><br><span class="hljs-string">    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin</span><br><span class="hljs-string">    WSGIApplicationGroup %{GLOBAL}</span><br><span class="hljs-string">    WSGIPassAuthorization On</span><br><span class="hljs-string">    ErrorLogFormat "%{cu}t %M"</span><br><span class="hljs-string">    ErrorLog /var/log/httpd/keystone-error.log</span><br><span class="hljs-string">    CustomLog /var/log/httpd/keystone-access.log combined</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;Directory /usr/bin&gt;</span><br><span class="hljs-string">        Require all granted</span><br><span class="hljs-string">    &lt;/Directory&gt;</span><br><span class="hljs-string">&lt;/VirtualHost&gt;'</span>  &gt;/etc/httpd/conf.d/wsgi-keystone.conf<br></code></pre></td></tr></tbody></table></figure><p>校验</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller ~]<span class="hljs-comment"># md5sum /etc/httpd/conf.d/wsgi-keystone.conf </span><br>8f051eb53577f67356ed03e4550315c2  /etc/httpd/conf.d/wsgi-keystone.conf<br></code></pre></td></tr></tbody></table></figure><p>启动httpd</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> httpd.service<br>systemctl start httpd.service<br></code></pre></td></tr></tbody></table></figure><p>HTTP监听5000端口（普通用户访问）和35357端口（管理员访问）</p><p><strong>创建服务和注册api：</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> OS_TOKEN=ADMIN_TOKEN<br><span class="hljs-built_in">export</span> OS_URL=http://controller:35357/v3<br><span class="hljs-built_in">export</span> OS_IDENTITY_API_VERSION=3<br><br>openstack service create \<br>  --name keystone --description <span class="hljs-string">"OpenStack Identity"</span> identity<br>openstack endpoint create --region RegionOne \<br>  identity public http://controller:5000/v3  <br>openstack endpoint create --region RegionOne \<br>  identity internal http://controller:5000/v3<br>openstack endpoint create --region RegionOne \<br>  identity admin http://controller:35357/v3<br></code></pre></td></tr></tbody></table></figure><p><strong>解释：</strong><br>1、定义环境变量</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> OS_TOKEN=ADMIN_TOKEN  指定使用admin  token管理操作<br><span class="hljs-built_in">export</span> OS_URL=http://controller:35357/v3 指定keystone本身的URL信息<br><span class="hljs-built_in">export</span> OS_IDENTITY_API_VERSION=3  指定API的版本信息<br></code></pre></td></tr></tbody></table></figure><p>2、创建服务 创建端点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack service create \<br>  --name keystone --description <span class="hljs-string">"OpenStack Identity"</span> identity  创建 服务名称为keystone  描述信息 为 OpenStack Identity<br> 关联到认证    identity<br>openstack endpoint create --region RegionOne \<br>  identity public http://controller:5000/v3 创建公共端点 走5000端口<br>openstack endpoint create --region RegionOne \<br>  identity internal http://controller:5000/v3  创建内部端点 走5000端口<br>openstack endpoint create --region RegionOne \<br>  identity admin http://controller:35357/v3  创建管理员端点 走35357端口<br></code></pre></td></tr></tbody></table></figure><p><strong>创建域 项目 用户</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack domain create --description <span class="hljs-string">"Default Domain"</span> default<br>openstack project create --domain default \<br>  --description <span class="hljs-string">"Admin Project"</span> admin<br>openstack user create --domain default \<br>  --password 123456 admin<br>openstack role create admin<br></code></pre></td></tr></tbody></table></figure><p><strong>关联项目，用户，角色</strong><br>在admin项目上，给admin项目赋予admin角色</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack role add --project admin --user admin admin<br></code></pre></td></tr></tbody></table></figure><p>创建service的项目 给其他组件使用，存放其他组件的系统账号</p><p>keystone服务本身和其他组件不存放同一个项目中</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">openstack project create --domain default \<br>  --description <span class="hljs-string">"Service Project"</span> service<br></code></pre></td></tr></tbody></table></figure><p><strong>创建环境变量脚本</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi admin-openrc<br><br><span class="hljs-built_in">export</span> OS_TOKEN=ADMIN_TOKEN<br><span class="hljs-built_in">export</span> OS_URL=http://controller:35357/v3<br><span class="hljs-built_in">export</span> OS_IDENTITY_API_VERSION=3<br><span class="hljs-built_in">export</span> OS_PROJECT_DOMAIN_NAME=default<br><span class="hljs-built_in">export</span> OS_USER_DOMAIN_NAME=default<br><span class="hljs-built_in">export</span> OS_PROJECT_NAME=admin<br><span class="hljs-built_in">export</span> OS_USERNAME=admin<br><span class="hljs-built_in">export</span> OS_PASSWORD=ADMIN_PASS<br><span class="hljs-built_in">export</span> OS_AUTH_URL=http://controller:35357/v3<br><span class="hljs-built_in">export</span> OS_IDENTITY_API_VERSION=3<br><span class="hljs-built_in">export</span> OS_IMAGE_API_VERSION=2<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OpenStack基础服务安装</title>
      <link href="/2020/05/30/OpenStack%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85/"/>
      <url>/2020/05/30/OpenStack%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<p>CentOS Linux release 7.6.1810 (Core)<br>OpenStack安装M版</p><h2 id="规划">规划</h2><p>controller  内存3G  CPU虚拟化开启  IP地址 10.0.0.11<br>compute1  内存1G  CPU虚拟化开启 IP地址hi  10.0.0.31<br>网关地址为10.0.0.2</p><p><strong>环境准备</strong></p><p>1、修改主机名 IP地址  hosts解析  ping百度测试网络<br>controller节点：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl  <span class="hljs-built_in">set</span>-hostname  controller<br>bash<br>[root@controller ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=Ethernet<br>BOOTPROTO=none<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.11<br>NETMASK=255.255.255.0<br>GATEWAY=10.0.0.2<br>DNS1=180.76.76.76<br>DNS2=223.5.5.5<br><br>[root@controller ~]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.11  controller<br>10.0.0.31  compute1<br>[root@controller ~]<span class="hljs-comment">#</span><br><br>[root@controller ~]<span class="hljs-comment"># ping baidu.com</span><br>PING baidu.com (220.181.38.148) 56(84) bytes of data.<br>64 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=1 ttl=128 time=6.92 ms<br>^C<br>--- baidu.com ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 6.920/6.920/6.920/0.000 ms<br></code></pre></td></tr></tbody></table></figure><p>compute1节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl  <span class="hljs-built_in">set</span>-hostname  compute1<br>[root@compute1 ~]<span class="hljs-comment"># cat   /etc/hosts</span><br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.0.0.11  controller<br>10.0.0.31  compute1<br>[root@compute1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>TYPE=Ethernet<br>BOOTPROTO=none<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>IPADDR=10.0.0.31<br>NETMASK=255.255.255.0<br>GATEWAY=10.0.0.2<br>DNS1=180.76.76.76<br>DNS2=223.5.5.5<br><br><br>[root@compute1 ~]<span class="hljs-comment"># ping baidu.com</span><br>PING baidu.com (39.156.69.79) 56(84) bytes of data.<br>64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=1 ttl=128 time=8.15 ms<br>^C<br>--- baidu.com ping statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 8.157/8.157/8.157/0.000 ms<br></code></pre></td></tr></tbody></table></figure><p>2、配置yum源 （双节点执行）<br>mount /dev/cdrom /mnt<br>rz 上传openstack_rpm.tar.gz到/opt，并解压<br>生成repo配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'[local]</span><br><span class="hljs-string">name=local</span><br><span class="hljs-string">baseurl=file:///mnt</span><br><span class="hljs-string">gpgcheck=0</span><br><span class="hljs-string"></span><br><span class="hljs-string">[openstack]</span><br><span class="hljs-string">name=openstack</span><br><span class="hljs-string">baseurl=file:///opt/repo</span><br><span class="hljs-string">gpgcheck=0'</span> &gt;/etc/yum.repos.d/local.repo<br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">'mount /dev/cdrom /mnt'</span> &gt;&gt;/etc/rc.local<br>chmod +x /etc/rc.d/rc.local<br><br>[root@compute1 opt]<span class="hljs-comment"># yum repolist</span><br>Loaded plugins: fastestmirror<br>Loading mirror speeds from cached hostfile<br>openstack                                                          | 2.9 kB  00:00:00<br>openstack/primary_db                                               | 398 kB  00:00:00<br>repo id                                   repo name                                 status<br><span class="hljs-built_in">local</span>                                     <span class="hljs-built_in">local</span>                                     4,021<br>openstack                                 openstack                                   598<br>repolist: 4,619<br></code></pre></td></tr></tbody></table></figure><p><strong>在线源安装</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">  <span class="hljs-built_in">cd</span> /etc/yum.repos.d/<br>  rm -rf ./*<br>  curl -o /etc/yum.repos.d/CentOS-Base.repo  http://mirrors.aliyun.com/repo/Centos-7.repo<br>  ls<br>    yum  makecache<br>  yum list |grep  openstack<br>  yum install -y  centos-release-openstack-train.noarch<br><br>[root@controller yum.repos.d]<span class="hljs-comment"># ls</span><br>CentOS-Base.repo            CentOS-OpenStack-train.repo<br>CentOS-Ceph-Nautilus.repo   CentOS-QEMU-EV.repo<br>CentOS-NFS-Ganesha-28.repo  CentOS-Storage-common.repo<br></code></pre></td></tr></tbody></table></figure><p><strong>基础服务安装</strong></p><p>1、所有节点安装时间服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install chrony -y<br></code></pre></td></tr></tbody></table></figure><p>客户端 监听  323<br>服务端监听  123<br>controller节点同步阿里云时间</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/chrony.conf<br>server ntp5.aliyun.com iburst<br>allow 10.0.0.0/24<br><br>systemctl restart   chronyd.service<br></code></pre></td></tr></tbody></table></figure><p>compute1同步controller时间</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@compute1 ~]<span class="hljs-comment"># vim /etc/chrony.conf</span><br>[root@compute1 ~]<span class="hljs-comment"># grep  -Ev "^$|#"  /etc/chrony.conf</span><br>server 10.0.0.11 iburst<br>[root@compute1 ~]<span class="hljs-comment"># systemctl restart  chronyd.service</span><br></code></pre></td></tr></tbody></table></figure><p>安装openstack客户端和openstack-selinux 所有节点执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install python-openstackclient -y<br>yum install openstack-selinux -y<br></code></pre></td></tr></tbody></table></figure><p><strong>仅控制节点执行 ：安装配置mariadb</strong><br>存储各个组件的信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install mariadb mariadb-server python2-PyMySQL -y<br>cat /etc/my.cnf.d/openstack.cnf<br></code></pre></td></tr></tbody></table></figure><p>python2-PyMySQL ：帮助python连接mysql的模块</p><p>配置</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller ~]<span class="hljs-comment"># cd /etc/my.cnf.d/</span><br>[root@controller my.cnf.d]<span class="hljs-comment"># vim openstack.cnf</span><br>[root@controller my.cnf.d]<span class="hljs-comment"># cat /etc/my.cnf.d/openstack.cnf</span><br>[mysqld]<br><span class="hljs-built_in">bind</span>-address = 10.0.0.11<br>default-storage-engine = innodb<br>innodb_file_per_table<br>max_connections = 4096<br>collation-server = utf8_general_ci<br>character-set-server = utf8<br></code></pre></td></tr></tbody></table></figure><p>重启数据库并执行安全初始化</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动</span><br>systemctl start mariadb<br>systemctl <span class="hljs-built_in">enable</span> mariadb<br><span class="hljs-comment">#安全初始化</span><br>mysql_secure_installation<br>回车<br>n  不设置数据库密码<br>y<br>y<br>y<br>y<br></code></pre></td></tr></tbody></table></figure><p><strong>安装消息队列服务  controller节点</strong><br>使得各个组件之间互相调用</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">安装rabbitmq并创建用户    监听5672  15672  25672   端口<br>yum install rabbitmq-server -y<br>systemctl start rabbitmq-server.service <br>systemctl <span class="hljs-built_in">enable</span> rabbitmq-server.service<br>rabbitmqctl add_user openstack RABBIT_PASS  OpenStack用户设置密码为  RABBIT_PASS<br>rabbitmqctl set_permissions openstack <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span>  给OpenStack用户授权<br></code></pre></td></tr></tbody></table></figure><p>启动rabbitmq 插件  监听15672<br>用于监控页面查看</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rabbitmq-plugins  <span class="hljs-built_in">enable</span>  rabbitmq_management<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">登录rabbitmqweb页面<br>http://10.0.0.11:15672/<br>默认用户名和密码<br>guest<br>guest<br></code></pre></td></tr></tbody></table></figure><p><strong>memcached缓存token</strong><br>缓存token  监听11211</p><p>安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install memcached python-memcached -y<br></code></pre></td></tr></tbody></table></figure><p>python-memcached      python连接memcache的模块</p><p>配置 监听10.0.0.11的主机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@controller my.cnf.d]<span class="hljs-comment"># cat /etc/sysconfig/memcached</span><br>PORT=<span class="hljs-string">"11211"</span><br>USER=<span class="hljs-string">"memcached"</span><br>MAXCONN=<span class="hljs-string">"1024"</span><br>CACHESIZE=<span class="hljs-string">"64"</span><br>OPTIONS=<span class="hljs-string">"-l 10.0.0.11,::1"</span><br></code></pre></td></tr></tbody></table></figure><p>启动并开机启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart memcached.service <br>systemctl <span class="hljs-built_in">enable</span> memcached.service<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linuxACL控制</title>
      <link href="/2020/05/30/linuxACL%E6%8E%A7%E5%88%B6/"/>
      <url>/2020/05/30/linuxACL%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>1.ACL访问控制概述<br>2.ACL高级特性MASK<br>3.ACL高级特性Default<br>4.ACL访问控制实践案例</p><h2 id="1-ACL访问控制概述">1.ACL访问控制概述</h2><p>在普通权限中，用户对文件只有三种身份，就是属主、属组和其他人；每种用户身份拥有读（read）、写（write）和执行（execute）三种权限。但是在实际工作中，这三种身份实在是不够用<br>ACL是Access Control List（访问控制列表）的缩写，不过在Linux系统中，ACL用于设定用户针对文件的权限</p><p><strong>acl基本使用方式</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">//环境准备<br>[root@xuliangwei ~]<span class="hljs-comment"># cp /etc/passwd /root/passwd</span><br>//文件在没有设定acl, 看到的和传统权限是一样<br>[root@xuliangwei ~]<span class="hljs-comment"># ll passwd</span><br>-rw-r--r-- 1 root root 0 10-26 13:59 /home/test.txt<br><br>//使用getacl查看权限<br>[root@xuliangwei ~]<span class="hljs-comment"># getfacl passwd </span><br><span class="hljs-comment"># file: passwd</span><br><span class="hljs-comment"># owner: root</span><br><span class="hljs-comment"># group: root</span><br>user::rw-   //文件owner权限<br>group::r--  //文件拥有组权限<br>other::r--  //其他人权限<br></code></pre></td></tr></tbody></table></figure><p><strong>1.设定acl权限案例如下</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">-rw-r--r-- 1 root root 1380 Feb 27 11:25 passwd<br><br>alice 拥有读写权限    rw<br>bgx  没有任何权限     -<br>jack 组拥有读权限     r<br>匿名用户拥有读写权限  rw<br><br><br>//建立相关用户<br>[root@xuliangwei ~]<span class="hljs-comment"># useradd alice</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd bgx</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd jack</span><br><br>//增加用户 alice 权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m u:alice:rw passwd</span><br><br>//增加用户 bgx 权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m u:bgx:- passwd</span><br><br>//增加匿名用户权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m o::rw passwd</span><br><br>//增加组权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m g:jack:r passwd</span><br><br><br>注意: 如果用户同时属于不同的两个组，并且两个组设定了acl访问控制<br>    1.根据acl访问控制优先级进行匹配规则<br>    2.如有用户拥有多个组的权限不同的权限，优先使用最高权限（模糊匹配）<br></code></pre></td></tr></tbody></table></figure><p><strong>2.查看acl权限</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@xuliangwei ~]<span class="hljs-comment"># ll passwd</span><br>-rw-rw-rw-+ 1 root root 1531 Jan 26 07:52 passwd<br><br>[root@xuliangwei ~]<span class="hljs-comment"># getfacl passwd</span><br><span class="hljs-comment"># file: passwd</span><br><span class="hljs-comment"># owner: root</span><br><span class="hljs-comment"># group: root</span><br>user::rw-<br>user:bgx:---<br>user:alice:rw-<br>group::r--<br>group:jack:r--<br>mask::rw-<br>other::rw-<br></code></pre></td></tr></tbody></table></figure><p><strong>3.移除acl权限</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">//移除jack组的acl权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -x g:jack passwd</span><br><br>//移除bgx用户的acl权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -x u:bgx passwd</span><br><br>//移除文件和目录所有acl权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -b passwd</span><br><br>//移除默认的acl<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -k dir</span><br></code></pre></td></tr></tbody></table></figure><p>4.查看acl帮助</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">//EXAMPLES 示例文档<br>[root@xuliangwei ~]<span class="hljs-comment"># man setfacl</span><br><br>//复制 file1 的 ACL 权限给 file2<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m u:alice:rw,u:bgx:r,g:jack:rw file1</span><br>[root@xuliangwei ~]<span class="hljs-comment"># getfacl file1 |setfacl --set-file=- file2</span><br></code></pre></td></tr></tbody></table></figure><h2 id="2-ACL高级特性MASK">2.ACL高级特性MASK</h2><p>mask用于临时降低用户或组的权限，但不包括文件的所有者和其他人。<br>mask最主要的作用是用来决定用户的最高权限。</p><p>mask默认不会对匿名用户降低权限，所以为了便于管理文件的访问控制，建议匿名用户的权限置为空</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">//临时降低用户或组权限<br>[root@xuliangwei ~]<span class="hljs-comment"># setfacl -m mask::rw filename</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p>小结<br>1.mask会影响哪些用户，除了所有者和其他人。<br>2.mask权限决定了用户访问文件时的最高权限。(如何影响)<br>3.mask用于临时降低用户访问文件的权限。(mask做什么)<br>4.任何重新设置acl访问控制会清理mask所设定的权限。</p></blockquote><h2 id="3-ACL高级特性Default">3.ACL高级特性Default</h2><p>default: 继承(默认)</p><p>alice能够对/opt目录以及以后在/opt目录下新建的文件有读、写、执行权限</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">//赋予 alice 对/home 读写执行权限 <br>[root@xuliangwei ~]<span class="hljs-comment">## setfacl -R -m u:alice:rwX /opt</span><br>//赋予 alice 对以后在/home 下新建的文件有读写执行权限(使 alice 的权限继承) <br>[root@xuliangwei ~]<span class="hljs-comment">## setfacl -m d:u:alice:rwX /opt</span><br><br>//检查对应的权限<br>[root@linux-node1 ~]<span class="hljs-comment"># getfacl /opt/</span><br>getfacl: Removing leading <span class="hljs-string">'/'</span> from absolute path names<br><span class="hljs-comment"># file: opt/</span><br><span class="hljs-comment"># owner: root</span><br><span class="hljs-comment"># group: bgx</span><br>user::rwx<br>user:alice:rwx<br>group::rwx<br>mask::rwx<br>other::rwx<br>default:user::rwx<br>default:user:alice:rwx<br>default:group::rwx<br>default:mask::rwx<br>default:other::rwx<br></code></pre></td></tr></tbody></table></figure><h2 id="4-ACL访问控制实践案例">4.ACL访问控制实践案例</h2><p><strong>案例1: 将新建文件的属性修改tom:admin, 权限默认为644</strong><br>要求: tom对该文件有所有的权限, mary可以读写该文件, admin组可以读写执行该文件, jack只读该文件, 其他人一律不能访问该文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">//实验前, 建立几个普通用户<br>[root@xuliangwei ~]<span class="hljs-comment"># useradd tom</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd bean</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd mary</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd jack</span><br>[root@xuliangwei ~]<span class="hljs-comment"># useradd sutdent</span><br>[root@xuliangwei ~]<span class="hljs-comment"># groupadd admin</span><br>[root@xuliangwei ~]<span class="hljs-comment"># gpasswd -a mary admin</span><br>[root@xuliangwei ~]<span class="hljs-comment"># gpasswd -a bean admin</span><br><br>//检查用户属性<br>[root@linux-node1 ~]<span class="hljs-comment"># id tom</span><br>uid=1004(tom) gid=1004(tom) groups=1004(tom)<br>[root@linux-node1 ~]<span class="hljs-comment"># id mary</span><br>uid=1006(mary) gid=1006(mary) groups=1006(mary),1007(admin)<br>[root@linux-node1 ~]<span class="hljs-comment"># id bean</span><br>uid=1005(bean) gid=1005(bean) groups=1005(bean),1007(admin)<br>[root@linux-node1 ~]<span class="hljs-comment"># id jack</span><br>uid=1002(jack) gid=1002(jack) groups=1002(jack)<br>[root@linux-node1 ~]<span class="hljs-comment"># id sutdent</span><br>uid=1007(sutdent) gid=1008(sutdent) groups=1008(sutdent)<br><br>//准备相关文件<br>[root@linux-node1 ~]<span class="hljs-comment"># cp /etc/passwd /root/</span><br>[root@linux-node1 ~]<span class="hljs-comment"># chown tom:admin passwd</span><br>[root@linux-node1 ~]<span class="hljs-comment"># chmod 644 passwd</span><br><br>//检查设定前的acl列表<br>[root@linux-node1 ~]<span class="hljs-comment"># getfacl passwd</span><br><span class="hljs-comment"># file: passwd</span><br><span class="hljs-comment"># owner: tom</span><br><span class="hljs-comment"># group: admin</span><br>user::rw-<br>group::r--<br>other::r--<br><br>//设定acl权限<br>[root@linux-node1 ~]<span class="hljs-comment"># setfacl -m u::rwx,u:mary:rw,u:jack:r,g:admin:rwx,o::- passwd</span><br><br>//检查acl权限<br>[root@linux-node1 ~]<span class="hljs-comment"># getfacl passwd</span><br><span class="hljs-comment"># file: passwd</span><br><span class="hljs-comment"># owner: tom</span><br><span class="hljs-comment"># group: admin</span><br>user::rwx<br>user:jack:r--<br>user:mary:rw-<br>group::r--<br>group:admin:rwx<br>mask::rwx<br>other::---<br></code></pre></td></tr></tbody></table></figure><blockquote><p>acl的控制规则是从上往下匹配<br>1.tom由于是文件的拥有者，所以直接按照user::rwx指定的权限去操作<br>2.mary用户从上往下寻找匹配规则，发现user:mary:rw-能够精确匹配mary用户，尽管mary属于admin组，同时admin组有rwx的权限，但是由于mary用户的规则在前面，所有优先生效。<br>3.bean由于找不到精确匹配的规则，而bean是属于admin组，根据文件的定义，该文件是属于admin组，所以bean的权限是按照group:admin:rwx的权限去操作。<br>4.jack用户从上往下寻找匹配规则，发现user:jack:r–能够精确匹配jack用户。<br>5.student用户找不到精确匹配的user定义规则, 也找不到相关组的定义规则，最后属于other。</p></blockquote><p><strong>案例2: lab acl setup</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">controller组成员有:student<br>sodor组成员有:thomas,james<br><br>目录: /shares/steamies<br>文件: /shares/steamies/file<br>脚本: /shares/steamies/test.sh<br><br>controller属于该目录的所属组, 新建文件必须属于controller组<br>sodor组的成员对该目录拥有rwx权限<br>sodor组成员james对该目录及子目录(包括以后新建立的文件)没有任何权限<br></code></pre></td></tr></tbody></table></figure><p>实际操作</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">//准备用户<br>[root@linux-node1 ~]<span class="hljs-comment"># groupadd controller</span><br>[root@linux-node1 ~]<span class="hljs-comment"># groupadd sodor</span><br>[root@linux-node1 ~]<span class="hljs-comment"># useradd student -G controller</span><br>[root@linux-node1 ~]<span class="hljs-comment"># useradd thomas -G sodor</span><br>[root@linux-node1 ~]<span class="hljs-comment"># useradd james -G sodor</span><br><br>//准备目录<br>[root@linux-node1 ~]<span class="hljs-comment"># mkdir /shares/steamies -p</span><br>[root@linux-node1 ~]<span class="hljs-comment"># echo "file" &gt;&gt; /shares/steamies/file</span><br>[root@linux-node1 ~]<span class="hljs-comment"># echo "echo 123" &gt;&gt; /shares/steamies/test.sh</span><br>[root@linux-node1 ~]<span class="hljs-comment"># chmod 755 /shares/steamies/test.sh</span><br>[root@linux-node1 ~]<span class="hljs-comment"># chown -R  :controller /shares/steamies/</span><br>[root@linux-node1 ~]<span class="hljs-comment"># chmod g+s /shares/steamies/</span><br><br><br>//设定权限(X表示,如果原本有执行权限就保留,如果没有则不添加)<br>[root@linux-node1 ~]<span class="hljs-comment"># setfacl -R -m g:sodor:rwX,u:james:- /shares/steamies/</span><br><br>//设定继承规则<br>[root@linux-node1 ~]<span class="hljs-comment"># setfacl -R -m d:g:sodor:rwX,d:u:james:- /shares/steamies/</span><br><br><br>[root@linux-node1 steamies]<span class="hljs-comment"># getfacl /shares/steamies/</span><br>getfacl: Removing leading <span class="hljs-string">'/'</span> from absolute path names<br><span class="hljs-comment"># file: shares/steamies/</span><br><span class="hljs-comment"># owner: root</span><br><span class="hljs-comment"># group: controller</span><br><span class="hljs-comment"># flags: -s-</span><br>user::rwx<br>user:james:---<br>group::r-x<br>group:sodor:rwx<br>mask::rwx<br>other::r-x<br>default:user::rwx<br>default:group::r-x<br>default:group:sodor:rwx<br>default:mask::rwx<br>default:other::r-x<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>linux计划任务</title>
      <link href="/2020/05/30/linux%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/"/>
      <url>/2020/05/30/linux%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p>1、计划任务基本概述<br>2、计划任务时间管理<br>3、计划任务编写实践<br>4、计划任务如何调试</p><h2 id="1、计划任务基本概述">1、计划任务基本概述</h2><p><strong>1、什么是crond</strong><br>crond就是计划任务，类似于我们平时生活中的闹钟，定点执行<br><strong>2、为什么要用crond</strong><br>crond主要做一些周期性的任务，比如凌晨3点定时备份数据。比如：11点开启网站抢购接口，12点关闭网站抢购接口<br><strong>3、计划任务主要分为以下两种情况：</strong><br>1、系统级别的定时任务：临时文件清理、系统信息采集、日志文件切割<br>用户级别的定时任务：定时向互联网同步时间、定时备份系统配置文件、定时备份数据库的数据。</p><h2 id="2、计划任务时间管理">2、计划任务时间管理</h2><p><strong>1.Crontab配置文件记录了时间周期的含义</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@xuliangwei ~]<span class="hljs-comment"># vim /etc/crontab</span><br>SHELL=/bin/bash                     <span class="hljs-comment">#执行命令的解释器</span><br>PATH=/sbin:/bin:/usr/sbin:/usr/bin  <span class="hljs-comment">#环境变量</span><br>MAILTO=root                         <span class="hljs-comment">#邮件发给谁</span><br><span class="hljs-comment"># Example of job definition:</span><br><span class="hljs-comment"># .---------------- minute (0 - 59) #分钟</span><br><span class="hljs-comment"># |  .------------- hour (0 - 23)   #小时</span><br><span class="hljs-comment"># |  |  .---------- day of month (1 - 31)   #日期</span><br><span class="hljs-comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr #月份</span><br><span class="hljs-comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat  #星期</span><br><span class="hljs-comment"># |  |  |  |  |</span><br><span class="hljs-comment"># *  *  *  *  *   command to be executed</span><br><br><span class="hljs-comment"># *  表示任意的(分、时、日、月、周)时间都执行</span><br><span class="hljs-comment"># -  表示一个时间范围段, 如5-7点</span><br><span class="hljs-comment"># ,  表示分隔时段, 如6,0,4表示周六、日、四</span><br><span class="hljs-comment"># /1 表示每隔n单位时间, 如*/10 每10分钟</span><br></code></pre></td></tr></tbody></table></figure><p><strong>2.了解crontab的时间编写规范</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">00 02 * * * ls      <span class="hljs-comment">#每天的凌晨2点整执行</span><br>00 02 1 * * ls      <span class="hljs-comment">#每月的1日的凌晨2点整执行</span><br>00 02 14 2 * ls     <span class="hljs-comment">#每年的2月14日凌晨2点执行</span><br>00 02 * * 7 ls      <span class="hljs-comment">#每周天的凌晨2点整执行</span><br>00 02 * 6 5 ls      <span class="hljs-comment">#每年的6月周五凌晨2点执行</span><br>00 02 14 * 7 ls     <span class="hljs-comment">#每月14日或每周日的凌晨2点都执行</span><br>00 02 14 2 7 ls     <span class="hljs-comment">#每年的2月14日或每年2月的周天的凌晨2点执行   </span><br>*/10  02 * * * ls   <span class="hljs-comment">#每天凌晨2点，每隔10分钟执行一次</span><br>* * * * *  ls       <span class="hljs-comment">#每分钟都执行</span><br>00 00 14 2 *  ls    <span class="hljs-comment">#每年2月14日的凌晨执行命令 </span><br>*/5 * * * *  ls     <span class="hljs-comment">#每隔5分钟执行一次</span><br>00 02 * 1,5,8 * ls  <span class="hljs-comment">#每年的1月5月8月凌晨2点执行</span><br>00 02 1-8 * *  ls    <span class="hljs-comment">#每月1号到8号凌晨2点执行</span><br>0 21 * * * ls       <span class="hljs-comment">#每天晚上21:00执行</span><br>45 4 1,10,22 * * ls <span class="hljs-comment">#每月1、10、22日的4:45执行</span><br>45 4 1-10 * * l     <span class="hljs-comment">#每月1到10日的4:45执行</span><br>3,15 8-11 */2 * * ls <span class="hljs-comment">#每隔两天的上午8点到11点的第3和第15分钟执行</span><br>0 23-7/1 * * * ls   <span class="hljs-comment">#晚上11点到早上7点之间，每隔一小时执行</span><br>15 21 * * 1-5 ls    <span class="hljs-comment">#周一到周五每天晚上21:15执行</span><br></code></pre></td></tr></tbody></table></figure><p><strong>3.使用crontab编写cron定时任务</strong></p><p>参数 含义<br>-e     编辑定时任务<br>-l    查看定时任务<br>-r    删除定时任务<br>-u   指定其他用户</p><h2 id="3-计划任务编写实践">3.计划任务编写实践</h2><p><strong>1.使用root用户每5分钟执行一次时间同步</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1.如何同步时间</span><br>[root@xuliangwei ~]<span class="hljs-comment"># ntpdate time.windows.com &amp;&gt;/dev/null</span><br><span class="hljs-comment">#2.配置定时任务</span><br>[root@xuliangwei ~]<span class="hljs-comment"># crontab -e -u root</span><br>[root@xuliangwei ~]<span class="hljs-comment"># crontab -l -u root</span><br>*/5 * * * * ntpdate time.windows.com &amp;&gt;/dev/null<br></code></pre></td></tr></tbody></table></figure><p><strong>2.每天的下午3,5点，每隔半小时执行一次sync命令</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@xuliangwei ~]<span class="hljs-comment"># crontab -l</span><br>*/30 15,17 * * * sync &amp;&gt;/dev/null<br></code></pre></td></tr></tbody></table></figure><p><strong>3.案例：每天凌晨3点做一次备份？备份/etc/目录到/backup下面</strong></p><ol><li>将备份命令写入一个脚本中</li><li>每天备份文件名要求格式: 2019-05-01_hostname_etc.tar.gz</li><li>在执行计划任务时，不要输出任务信息</li><li>存放备份内容的目录要求只保留三天的数据</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1.实现如上备份需求</span><br>[root@xuliangwei ~]<span class="hljs-comment"># mkdir /backup</span><br>[root@xuliangwei ~]<span class="hljs-comment"># tar zcf $(date +%F)_$(hostname)_etc.tar.gz /etc</span><br>[root@xuliangwei ~]<span class="hljs-comment"># find /backup -name “*.tar.gz” -mtime +3 -exec rm -f {}\;</span><br><br><span class="hljs-comment">#2.将命令写入至一个文件中</span><br>[root@xuliangwei ~]<span class="hljs-comment"># vim /root/back.sh</span><br>mkdir /backup<br>tar zcf $(date +%F)_$(hostname)_etc.tar.gz /etc<br>find /backup -name “*.tar.gz” -mtime +3 -<span class="hljs-built_in">exec</span> rm -f {}\;<br><br><span class="hljs-comment">#3.配置定时任务</span><br>[root@xuliangwei ~]<span class="hljs-comment"># crontab -l</span><br>00 03 * * * bash /root/back.sh  &amp;&gt;/dev/null<br><br><span class="hljs-comment">#3.备份脚本</span><br></code></pre></td></tr></tbody></table></figure><p><strong>4.crond注意的事项</strong></p><ol><li>给定时任务注释</li><li>将需要定期执行的任务写入Shell脚本中，避免直接使用命令无法执行的情况tar date</li><li>定时任务的结尾一定要有&amp;&gt;/dev/null或者将结果追加重定向&gt;&gt;/tmp/date.log文件</li><li>注意有些命令是无法成功执行的 echo “123” &gt;&gt;/tmp/test.log &amp;&gt;/dev/null<br>5.如果一定要是用命令，命令必须使用绝对路径</li></ol><p><strong>5.crond如何备份</strong></p><ol><li>通过查找/var/log/cron中执行的记录，去推算任务执行的时间</li><li>定时的备份/var/spool/cron/{usernmae}</li></ol><p><strong>6.crond如何拒绝某个用户使用</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1.使用root将需要拒绝的用户加入/etc/cron.deny</span><br>[root@xuliangwei ~]<span class="hljs-comment"># echo "xuliangwei" &gt;&gt; /etc/cron.deny</span><br><br><span class="hljs-comment">#2.登陆该普通用户，测试是否能编写定时任务</span><br>[oldboy@xuliangwei ~]$ crontab -e<br>You (xuliangwei) are not allowed to use this program (crontab)<br>See crontab(1) <span class="hljs-keyword">for</span> more information<br></code></pre></td></tr></tbody></table></figure><h2 id="4-计划任务如何调试">4.计划任务如何调试</h2><p><strong>1.crond调试</strong></p><ol><li>调整任务每分钟执行的频率, 以便做后续的调试。</li><li>如果使用cron运行脚本，请将脚本执行的结果写入指定日志文件, 观察日志内容是否正常。</li><li>命令使用绝对路径, 防止无法找到命令导致定时任务执行产生故障。</li><li>通过查看/var/log/cron日志，以便检查我们执行的结果，方便进行调试。</li></ol><p><strong>2.crond编写思路</strong></p><p>1.手动执行命令，然后保留执行成功的结果。<br>2.编写脚本<br>脚本需要统一路径/scripts<br>脚本内容复制执行成功的命令(减少每个环节出错几率)<br>脚本内容尽可能的优化, 使用一些变量或使用简单的判断语句<br>脚本执行的输出信息可以重定向至其他位置保留或写入/dev/null<br>3.执行脚本<br>使用bash命令执行, 防止脚本没有增加执行权限(/usr/bin/bash)<br>执行脚本成功后，复制该执行的命令，以便写入cron<br>4.编写计划任务<br>加上必要的注释信息, 人、时间、任务<br>设定计划任务执行的周期<br>粘贴执行脚本的命令(不要手敲)<br>5.调试计划任务<br>增加任务频率测试<br>检查环境变量问题<br>检查crond服务日志</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>harbor+registry</title>
      <link href="/2020/05/30/harbor+registry/"/>
      <url>/2020/05/30/harbor+registry/</url>
      
        <content type="html"><![CDATA[<p><strong>docker私有仓库  registry</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull registry:latest<br>docker run -d -p 5000:5000  --restart=always  --name  registry -v /opt/myregistry/:/var/lib/registry registry<br></code></pre></td></tr></tbody></table></figure><p>从私有仓库pull镜像会有域名</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull  index.tenxcloud.com/system_containers/metrics-server-amd64:v0.3.1<br></code></pre></td></tr></tbody></table></figure><p><a href="http://xn--docker-vy7iv52dee467b751a.io" target="_blank" rel="noopener">官方地址为docker.io</a></p><p>私有仓库用的是http协议<br>客户端默认是用HTTPS协议<br>报错：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Get https://10.0.0.11:5000/v2/: http: server gave HTTP response to HTTPS client<br></code></pre></td></tr></tbody></table></figure><p>解决方法：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># cat /etc/docker/daemon.json</span><br>{<br>  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.docker-cn.com"</span>],<br>  <span class="hljs-string">"insecure-registries"</span>: [<span class="hljs-string">"10.0.0.11:5000"</span>]<br>}<br></code></pre></td></tr></tbody></table></figure><p>重启docker</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># systemctl restart  docker</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker push   10.0.0.11:5000/centos6.9_nginx:lsy</span><br></code></pre></td></tr></tbody></table></figure><p>记得带上<br>push镜像的步骤<br>1、打标签tag<br>2、push</p><p><strong>web页面获取registry仓库中有哪些镜像</strong><br><a href="http://10.0.0.11:5000/v2/_catalog" target="_blank" rel="noopener">http://10.0.0.11:5000/v2/_catalog</a><br>web页面获取registry仓库中镜像的标签（不好用）<br><a href="http://10.0.0.11:5000/v2/image_name/tags/list" target="_blank" rel="noopener">http://10.0.0.11:5000/v2/image_name/tags/list</a></p><p><strong>registry删除镜像</strong></p><p>docker  registry：功能弱 ，占用资源少</p><p>查看 registry的ID</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE                                  COMMAND                  CREATE<br>b527b0e7b9a2        registry                               <span class="hljs-string">"/entrypoint.sh /etc…"</span>   6 hour<br>8d0033ddd574        wordpress:latest                       <span class="hljs-string">"docker-entrypoint.s…"</span>   24 hou<br>6e259fb0cd13        mysql:5.7                              <span class="hljs-string">"docker-entrypoint.s…"</span>   24 hou<br>d26d86b6e13a        zabbix/zabbix-web-nginx-mysql:latest   <span class="hljs-string">"/bin/bash /run_zabb…"</span>   25 houql_1<br>08fac4684e98        zabbix/zabbix-server-mysql:latest      <span class="hljs-string">"/bin/bash /run_zabb…"</span>   25 hou<br>d21c6baf0a23        zabbix/zabbix-java-gateway:latest      <span class="hljs-string">"/bin/bash /run_zabb…"</span>   25 hou1<br>835662f0d3af        mysql:5.7                              <span class="hljs-string">"docker-entrypoint.s…"</span>   25 hou<br></code></pre></td></tr></tbody></table></figure><p>进入registry容器查看系统信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker exec -it b527b0e7b9a2 /bin/sh</span><br>/ <span class="hljs-comment"># su - root</span><br>b527b0e7b9a2:~<span class="hljs-comment">#</span><br>b527b0e7b9a2:~<span class="hljs-comment">#</span><br>b527b0e7b9a2:~<span class="hljs-comment">#</span><br>b527b0e7b9a2:~<span class="hljs-comment">#</span><br>b527b0e7b9a2:~<span class="hljs-comment"># cat /etc/os-release</span><br>NAME=<span class="hljs-string">"Alpine Linux"</span><br>ID=alpine<br>VERSION_ID=3.8.5<br>PRETTY_NAME=<span class="hljs-string">"Alpine Linux v3.8"</span><br>HOME_URL=<span class="hljs-string">"http://alpinelinux.org"</span><br>BUG_REPORT_URL=<span class="hljs-string">"http://bugs.alpinelinux.org"</span><br>b527b0e7b9a2:~<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>进入目录查看大小</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">b527b0e7b9a2:~<span class="hljs-comment"># cd /var/lib/registry/docker/registry/v2/</span><br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># ls</span><br>blobs         repositories<br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># du -smh *</span><br>276.6M  blobs<br>108.0K  repositories<br></code></pre></td></tr></tbody></table></figure><p>删除镜像（但是有时不会释放空间）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># rm -rf repositories/centos</span><br>centos/           centos6.9_nginx/  centos_test/<br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># rm -rf repositories/centos</span><br>centos/           centos6.9_nginx/  centos_test/<br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># rm -rf repositories/centos6.9_nginx</span><br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># du -smh *</span><br>276.6M  blobs<br>72.0K   repositories<br><br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># registry garbage-collect /etc/docker/re</span><br>gistry/config.yml<br>blobs/         repositories/<br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># registry garbage-collect /etc/docker/re</span><br>gistry/config.yml<br></code></pre></td></tr></tbody></table></figure><p>查看大小</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment"># du -smh *</span><br>276.6M  blobs<br>72.0K   repositories<br>b527b0e7b9a2:/var/lib/registry/docker/registry/v2<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p><strong>官方仓库使用</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker登录官方仓库<br>docker login<br></code></pre></td></tr></tbody></table></figure><p>打标签上传</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker tag  alpine:latest  17695691664/alpine:latest</span><br>[root@docker01 ~]<span class="hljs-comment"># docker push   17695691664/alpine:latest</span><br>The push refers to repository [docker.io/17695691664/alpine]<br>1bfeebd65323: Pushed<br>latest: digest: sha256:57334c50959f26ce1ee025d08f136c2292c128f84e7b229d1b0da5dac89e9866 size: 528<br>[root@docker01 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>访问指定uri信息 web方式查看镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://10.0.0.11:5000/v2/_catalog<br></code></pre></td></tr></tbody></table></figure><p>harbor  docker registry  基础上扩展了很多功能</p><p>docker  registry 安装在11上面  harbor安装12<br>harbor是在registry基础上 使用仓库<br>使用harbor是基于 registry的  首先registry要配置好</p><p>重新安装</p><p>修改为HTTPS方式<br>vim  harbor.yml</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https:<br>  <span class="hljs-comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span><br>  port: 443<br>  certificate: /opt/cert/Nginx/1_blog.oldqiang.com_bundle.crt<br>  private_key: /opt/cert/Nginx/2_blog.oldqiang.com.key<br></code></pre></td></tr></tbody></table></figure><p>使用强的密钥</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker02 harbor]<span class="hljs-comment"># cat /etc/docker/daemon.json</span><br>{<br>  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.docker-cn.com"</span>],<br>  <span class="hljs-string">"insecure-registries"</span>: [<span class="hljs-string">"10.0.0.12:5000"</span>]<br>}<br></code></pre></td></tr></tbody></table></figure><p>镜像推送到harbor</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker02 harbor]<span class="hljs-comment"># docker tag  nginx:latest   blog.oldqiang.com/library/nginx:latest</span><br>[root@docker02 harbor]<span class="hljs-comment"># docker push  blog.oldqiang.com/library/nginx:latest</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>docker总览</title>
      <link href="/2020/05/29/docker%E6%80%BB%E8%A7%88/"/>
      <url>/2020/05/29/docker%E6%80%BB%E8%A7%88/</url>
      
        <content type="html"><![CDATA[<p><strong>1.什么是容器</strong><br>容器是隔离的环境中运行的一个进程,如果进程结束,容器就会停止,容器的隔离环境,拥有自己的ip地址,系统文件,主机名,进程管理</p><p>程序: 代码,软件,命令</p><p>进程:正在运行的程序</p><p><strong>2:容器和虚拟机的区别</strong><br>虚拟机: 硬件cpu支持(vt虚拟化),模拟计算硬件,走正常的开机启动</p><p>bios开机自检–根据bios启动项–读取硬盘第一个扇区grub,uefi,  centos7, 加载内核,启动系统第一个进程/sbin/init  systemd</p><p>容器: 不需要硬件cpu的支持,共用宿主机内核,启动容器的第一个进程</p><p>容器优势: 启动快,性能高,损耗少,轻量级</p><p>100虚拟机  100个服务     10宿主机</p><p>100容器     100个服务      6宿主机</p><p><strong>3:docker-ce的安装</strong><br>主机名  内存    ip<br>docker012G10.0.0.11<br>docker022G10.0.0.12</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装docker-ce</span><br>wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo<br>sed -i <span class="hljs-string">'s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo<br>yum install docker-ce -y<br><br>systemctl <span class="hljs-built_in">enable</span> docker<br>systemctl start docker<br><br><span class="hljs-comment">#验证</span><br>[root@docker01 yum.repos.d]<span class="hljs-comment"># docker version </span><br>Client: Docker Engine - Community<br> Version:           19.03.5<br> API version:       1.40<br> Go version:        go1.12.12<br> Git commit:        633a0ea<br> Built:             Wed Nov 13 07:25:41 2019<br> OS/Arch:           linux/amd64<br> Experimental:      <span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><strong>4:docker主要内容</strong><br>docker是一个cs架构, docker主要:镜像  容器   仓库  网络  存储   监控</p><p>docker是一个软件的打包技术.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d  -p 80:80  nginx:latest <br>run 创建并启动一个容器<br>-d  放后台启动<br>-p  端口映射<br>nginx:latest docker镜像名称<br></code></pre></td></tr></tbody></table></figure><p><strong>5:docker镜像常用命令</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker search  搜索镜像, 优先选官方,stars数量多<br>docker pull    拉取镜像(下载镜像)，注意版本<br>docker push    推送镜像(上传镜像)<br>docker load    导入镜像<br>   例子: docker load  -i  docker_nginx.tar.gz<br>docker save    导出镜像<br>   例子:docker save centos:7 -o docker_centos7.tar.gz<br>docker image  ls   查看镜像列表<br>docker rmi      删除镜像<br>docker tag      给镜像打标签<br></code></pre></td></tr></tbody></table></figure><p><strong>6:docker容器的常用命令</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run 创建并启动容器<br>     例子:docker run  -d -it -p 80:80  nginx:latest<br>docker create  创建容器 --name<br>docker start   启动容器<br>docker  stop   停止容器<br>docker  restart 重启容器<br>docker  <span class="hljs-built_in">kill</span>   强制停止容器<br>docker  ps     查看容器列表  -a 查看所有容器<br>docker  rm     删除容器<br>    批量删除所有容器 docker rm -f `docker ps -a -q`<br>docker  <span class="hljs-built_in">exec</span>   进入正在运行的容器(分配一个新终端)<br>       例子: docker <span class="hljs-built_in">exec</span>  -it  容器id/容器名字   /bin/bash(/bin/sh)<br>docker attach  进入正在运行的容器(使用相同的终端),偷偷离开的快捷键ctrl +p,ctrl +q<br></code></pre></td></tr></tbody></table></figure><p>容器想要放在后台一直运行的化,那么容器的初始命令,必须夯住(前台运行),否则容器就会退出.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">前台运行<br>nginx -g <span class="hljs-string">'daemon off;'</span><br>/usr/sbin/php-fpm --nodaemonize<br></code></pre></td></tr></tbody></table></figure><p><strong>7:docker端口映射</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run<br>-p  宿主机端口:容器端口<br>-p  宿主机ip1:宿主机端口:容器端口 (多个容器同时使用80端口)<br>-p  宿主机ip1::容器端口   随机端口映射<br>-p  宿主机ip1::容器端口/udp   使用udp协议做随机端口映射<br>-p 80:80  -p 3306:3306<br>-p 1111-1119:1111-1119  端口范围映射<br><br>-P 自动随机端口映射<br></code></pre></td></tr></tbody></table></figure><p><strong>8:docker数据卷</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run<br>-v  宿主机绝对目录:容器目录<br>-v  容器目录        <span class="hljs-comment">#创建一个随机卷,来持久化容器的目录下的数据</span><br>-v  卷名:容器目录    <span class="hljs-comment">#创建一个固定名字的卷,来持久化容器的目录下的数据</span><br>--volumes-from  跟某一个容器挂载所有相同的卷<br></code></pre></td></tr></tbody></table></figure><p><strong>9:手动制作docker镜像</strong><br>制作一个基于centos6系统的nginx镜像(单服务)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">1:启动一个纯净的centos:6.9容器,安装nginx<br>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>yum install nginx -y<br>2:把安装好服务的容器,提交为镜像<br>docker container commit eb109f194821 centos6.9_nginx:v1<br><br>3:测试镜像的功能<br>docker run -d  -p 82:80 centos6.9_nginx:v1 nginx -g <span class="hljs-string">'daemon off;'</span><br></code></pre></td></tr></tbody></table></figure><p><strong>制作一个基于centos6系统的kod网盘的镜像(多服务)</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1:启动一个centos6.9_nginx:v1,再安装php<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'192.168.12.201  mirrors.aliyun.com'</span> &gt;&gt;/etc/hosts<br>yum install php-fpm php-gd php-mbstring -y<br>vi /etc/php-fpm.d/www.conf<br>service php-fpm start<br><span class="hljs-built_in">cd</span> /etc/nginx/conf.d/<br>vi default.conf <br>mkdir /html<br><span class="hljs-built_in">cd</span> /html<br>curl -o kodexplorer4.40.zip http://192.168.12.201/191216/kodexplorer4.40.zip<br>yum install unzip -y<br>unzip kodexplorer4.40.zip <br>chown -R nginx:nginx .<br><br>vi /init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><br>service php-fpm start<br>nginx -g <span class="hljs-string">'daemon off;'</span><br><br>2:把安装好服务的容器,提交为镜像<br>docker commit 47208e3e3796 kod:v2<br>3:测试镜像的功能<br>docker run -d -p 83:80 kod:v2 /bin/bash /init.sh<br></code></pre></td></tr></tbody></table></figure><p>制作一个基于centos7系统的nginx+sshd双服务镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>yum install nginx -y<br>yum install openssh-server -y<br>yum install initscripts -y<br>/usr/sbin/sshd-keygen<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'123456'</span>|passwd --stdin root<br>/usr/sbin/sshd -D<br>vi /init.sh<br></code></pre></td></tr></tbody></table></figure><p><strong>10:自动制作docker镜像</strong><br>镜像： 中药</p><p>dockerfile： 配方</p><p>dockerfile常用指令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM  基础镜像<br>RUN   制作镜像过程中需要的执行命令(安装服务)<br>CMD   容器启动的时候执行的初始命令，容易被替换(启动服务)<br>ENTRYPOINT  容器启动的时候执行的初始命令，不能被替换，如果同时使用CMD和ENTRYPOINT，cmd命令将作为ENTRYPOINT命令的参数<br>ADD   把dockerfile当前目录下的文件拷贝到容器中（自动解压tar包）<br>COPY  把dockerfile当前目录下的文件拷贝到容器中（不解压tar包）<br>WORKDIR 指定容器的默认工作目录<br>EXPOSE  镜像要暴露的端口<br>VOLUME  持久化卷<br>ENV     环境变量(ssh的密码,数据库的密码)<br>LABEL       镜像的属性标签<br>MAINTAINER  管理者标识<br></code></pre></td></tr></tbody></table></figure><p>根据dockerfile自动构建镜像的思路</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">a:手动制作docker镜像，记录历史命令<br>b：根据历史命令编写dockerfile文件<br>c：docker build构建docker镜像<br>d：测试镜像的功能<br></code></pre></td></tr></tbody></table></figure><p>dockerfile单服务例子1：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">'192.168.19.200  mirrors.aliyun.com'</span> &gt;&gt;/etc/hosts<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure><p>dockerfile多服务例子2：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos6.9_nginx:v1<br>RUN yum install php-fpm php-gd php-mbstring -y<br>ADD www.conf /etc/php-fpm.d/www.conf<br>ADD default.conf /etc/nginx/conf.d/default.conf <br>RUN mkdir /html<br>WORKDIR /html<br>RUN curl -o kodexplorer4.40.zip http://192.168.19.200/191127/kodexplorer4.40.zip<br>RUN yum install unzip -y<br>RUN unzip kodexplorer4.40.zip <br>RUN chown -R nginx:nginx .<br>ADD init.sh   /init.sh<br><br>CMD [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br><br>vi /init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><br>service php-fpm start<br>nginx -g <span class="hljs-string">'daemon off;'</span><br></code></pre></td></tr></tbody></table></figure><p>dockerfile使用环境变量的例子：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:7<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>RUN yum install nginx openssh-server initscripts -y<br>RUN /usr/sbin/sshd-keygen<br>ADD init.sh  /init.sh<br>ENTRYPOINT [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br><br>vi  init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-variable">$SSH_PWD</span> ];<span class="hljs-keyword">then</span><br>    SSH_PWD=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SSH_PWD</span>|passwd --stdin root<br>nginx<br>/usr/sbin/sshd -D<br></code></pre></td></tr></tbody></table></figure><p><strong>11:docker镜像的分层(复用,节省空间)</strong></p><p><strong>12:dockerfile的优化</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">a: 使用体积小的linux镜像alpine<br>b：尽可能的清理无用的缓存文件（尽可能把多个RUN合并）<br>c：修改dockerfile的时候，尽可能把修改的内容放在最后<br>d：使用.dockerignore忽略构建docker镜像时，不需要的文件<br></code></pre></td></tr></tbody></table></figure><p><strong>13:容器间的互联</strong><br>docker run  --link 正在运行容器的名字（单方向）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"> docker run --name mysql-server -it \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -d mysql:5.7 \   <br>      --character-set-server=utf8 --collation-server=utf8_bin<br>     <br>docker run --name zabbix-java-gateway -t \<br>      -d zabbix/zabbix-java-gateway:latest<br>    <br>docker run --name zabbix-server-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -e ZBX_JAVAGATEWAY=<span class="hljs-string">"zabbix-java-gateway"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-java-gateway:zabbix-java-gateway \<br>      -p 10051:10051 \<br>      -d zabbix/zabbix-server-mysql:latest<br>      <br>docker run --name zabbix-web-nginx-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-server-mysql:zabbix-server \<br>      -p 80:80 \<br>      -d zabbix/zabbix-web-nginx-mysql:latest<br></code></pre></td></tr></tbody></table></figure><p><strong>14:单机版的容器编排</strong><br>yum install  docker-compose   -y(需要epel源)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">version: <span class="hljs-string">'3'</span><br><br>services:<br>   mysql-server:<br>     image: mysql:5.7<br>     restart: always<br>     environment:<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>     <span class="hljs-built_in">command</span>: --character-set-server=utf8 --collation-server=utf8_bin<br>     <br>   zabbix-java-gateway:<br>     image: zabbix/zabbix-java-gateway:latest<br>     restart: always<br>     <br>   zabbix-server:<br>     depends_on:<br>       - mysql-server<br>     image: zabbix/zabbix-server-mysql:latest<br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       ZBX_JAVAGATEWAY: zabbix-java-gateway<br>     ports:<br>       - <span class="hljs-string">"10051:10051"</span><br>       <br>   zabbix-web-nginx-mysql:<br>     depends_on:<br>       - zabbix-server<br>     image: zabbix/zabbix-web-nginx-mysql:latest<br>     ports:<br>       - <span class="hljs-string">"80:80"</span><br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br></code></pre></td></tr></tbody></table></figure><p>docker-compose  up  -d    启动服务</p><p>docker-compose  down   停止服务</p><p><strong>15:私有仓库docker-registry</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动私有仓库</span><br>docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry<br><br><span class="hljs-comment">#镜像地址</span><br>nginx:1.15        官方仓库的官方镜像<br>nginx/nginx:1.15  官方仓库的用户镜像<br><br>daocloud.io/nginx/nginx:1.15  私有仓库的镜像<br><br><span class="hljs-comment">#上传镜像</span><br>docker tag alpine:3.9 10.0.0.11:5000/alpine:3.9<br>docker image push 10.0.0.11:5000/alpine:3.9<br><span class="hljs-comment">#第一次上传镜像会报错</span><br>vim /etc/docker/daemon.json<br>{<br>  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.docker-cn.com"</span>],<br>  <span class="hljs-string">"insecure-registries"</span>: [<span class="hljs-string">"10.0.0.11:5000"</span>]<br>}<br><br>systemctl  restart docker<br><br>docker image push 10.0.0.11:5000/alpine:3.9<br><br><br><span class="hljs-comment">#下载镜像</span><br>docker image pull 10.0.0.11:5000/alpine:3.9<br></code></pre></td></tr></tbody></table></figure><p><strong>16: 企业级私有仓库harbor(docker-compose)</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载安装器</span><br>https://github.com/goharbor/harbor/releases/download/v1.10.0/harbor-offline-installer-v1.10.0.tgz<br><span class="hljs-comment">#解压</span><br>[root@docker01 opt]<span class="hljs-comment"># tar xf harbor-offline-installer-v1.8.0.tgz </span><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-built_in">cd</span>  harbor<br>vim harbor.yml<br>hostname: 10.0.0.12<br>harbor_admin_password: 123456<br><span class="hljs-comment">#执行安装脚本</span><br> ./install.sh<br><br>为harbor配置https证书<br><br><span class="hljs-comment">#修改harbor.yml</span><br><span class="hljs-comment">#配置域名</span><br>hostname: blog.oldqiang.com<br><br><span class="hljs-comment">#配置证书</span><br>https:<br>  port: 443<br>  certificate: /opt/certs/nginx/1_blog.oldqiang.com_bundle.crt<br>  private_key: /opt/certs/nginx/2_blog.oldqiang.com.key<br><br><span class="hljs-comment">#重新执行安装脚本</span><br>./install.sh<br></code></pre></td></tr></tbody></table></figure><p><strong>17:docker基础网络</strong><br>四种基础网络类型</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">bridge  默认类型 NAT模式<br>host    host类型，使用宿主机网络，网络性能最高<br>container 容器类型。使用其他容器共用网络，k8s中使用<br>none    没有网络，上不了外网<br></code></pre></td></tr></tbody></table></figure><p>创建自定义网络</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker network create -d bridge --subnet 172.18.0.0/16 --gateway 172.18.0.1 oldqiang<br></code></pre></td></tr></tbody></table></figure><p><strong>18:跨宿主机容器间的通讯之macvlan</strong><br>macvlan类似与虚拟机的桥接网络</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建网络</span><br>docker network create -d macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1<br><br><span class="hljs-comment">#启动容器</span><br>docker run -it --network macvlan_1 --ip 10.0.0.105 alpine:3.9<br></code></pre></td></tr></tbody></table></figure><p><strong>19:跨宿主机容器间的通讯之overlay</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker03上： consul存储ip地址的分配<br>docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap<br><br>docker01、02上：<br>vim  /etc/docker/daemon.json<br>{<br>  <span class="hljs-string">"cluster-store"</span>: <span class="hljs-string">"consul://10.0.0.13:8500"</span>,<br>  <span class="hljs-string">"cluster-advertise"</span>: <span class="hljs-string">"10.0.0.11:2376"</span><br>}<br><br>systemctl restart docker<br><br>2）创建overlay网络<br>docker network create -d overlay --subnet 172.26.0.0/16 --gateway 172.26.0.1  ol1<br><br>3）启动容器测试<br>docker run -it --network ol1 --name oldboy01  alpine:3.9  /bin/sh<br>每个容器有两块网卡,eth0实现容器间的通讯,eth1实现容器访问外网<br></code></pre></td></tr></tbody></table></figure><p><strong>20:docker容器的监控</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#客户端节点</span><br><span class="hljs-comment">#启动node-exporter</span><br>docker run -d   -p 9100:9100   -v <span class="hljs-string">"/:/host:ro,rslave"</span>   --name=node_exporter   quay.io/prometheus/node-exporter   --path.rootfs /host<br><br><span class="hljs-comment">#启动cadvisor</span><br>docker run --volume=/:/rootfs:ro  --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro  --publish=8080:8080 --detach=<span class="hljs-literal">true</span> --name=cadvisor google/cadvisor:latest<br><br><span class="hljs-comment">#prometheus节点</span><br>安装prometheus和grafana<br> tar xf prometheus-2.12.0.linux-amd64.tar.gz <br><br> <span class="hljs-built_in">cd</span> prometheus-2.12.0.linux-amd64/<br><br>vim prometheus.yml <br>scrape_configs:<br>  - job_name: <span class="hljs-string">'prometheus'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'localhost:9090'</span>]<br>  - job_name: <span class="hljs-string">'cadvisor'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'10.0.0.11:8080'</span>,<span class="hljs-string">'10.0.0.12:8080'</span>]<br>  - job_name: <span class="hljs-string">'node_exporter'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'10.0.0.11:9100'</span>,<span class="hljs-string">'10.0.0.12:9100'</span>]<br><br>./prometheus --config.file=<span class="hljs-string">"prometheus.yml"</span> <br><br><span class="hljs-comment">#安装grafana</span><br>yum localinstall grafana-6.3.3-1.x86_64.rpm -y<br>systemctl start grafana-server.service <br>systemctl <span class="hljs-built_in">enable</span> grafana-server.service<br><span class="hljs-comment">#访问grafana  http://IP:3000，默认账号admin:admin</span><br>新建数据源--导入dashboard模板<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>容器互联</title>
      <link href="/2020/05/29/%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94/"/>
      <url>/2020/05/29/%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94/</url>
      
        <content type="html"><![CDATA[<p>现状：每次启动镜像容器  容器的IP地址都不相同<br>导致问题：使用容器搭建一个架构 相互无法通讯</p><p>容器之间互联：<br>容器和容器之间可以ping同    主要问题是容器的IP地址不固定 每启一个容器IP地址都会随机</p><p>互联过程：<br>容器的link web01(源容器)需要启动状态<br>容器web02 link到web01容器  实现互联：web02在hosts中加入web01的IP地址信息<br>注意一点：web02中单项解析到web01   web01中不会解析到web02</p><p>操作：</p><p>启动容器web01并linkweb02</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 word]<span class="hljs-comment"># docker run -d -it  --name web01   kode:v1  /bin/bash</span><br>a9c8b9ec66ed84e485ea73d5afe3281156bbb7d79903ac92cea74d1cdd4414ba<br>[root@docker01 word]<span class="hljs-comment"># docker run -it --link web01:web01_lsy kode:v1  /bin/bash</span><br></code></pre></td></tr></tbody></table></figure><p>登录web02查看hosts文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 word]<span class="hljs-comment"># docker run -it --link web01:web01_lsy kode:v1  /bin/bash</span><br>[root@1ecca6a6e0d2 /]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1       localhost<br>::1     localhost ip6-localhost ip6-loopback<br>fe00::0 ip6-localnet<br>ff00::0 ip6-mcastprefix<br>ff02::1 ip6-allnodes<br>ff02::2 ip6-allrouters<br>172.17.0.2      web01_lsy a9c8b9ec66ed web01<br>172.17.0.3      1ecca6a6e0d2<br></code></pre></td></tr></tbody></table></figure><p>登录web01查看hosts文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 word]<span class="hljs-comment"># docker exec -it web01 /bin/bash</span><br>[root@a9c8b9ec66ed /]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1       localhost<br>::1     localhost ip6-localhost ip6-loopback<br>fe00::0 ip6-localnet<br>ff00::0 ip6-mcastprefix<br>ff02::1 ip6-allnodes<br>ff02::2 ip6-allrouters<br>172.17.0.2      a9c8b9ec66ed<br>[root@a9c8b9ec66ed /]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p><strong>命令行方式启动容器互联</strong></p><p>导入镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># ll</span><br>total 657864<br>-rw-r--r-- 1 root root 392823296 May 28 12:20 docker-mysql-5.7.tar.gz<br>-rw-r--r-- 1 root root 153172992 May 28 12:20 zabbix-java-gateway.tar.gz<br>-rw-r--r-- 1 root root 110936576 May 28 12:20 zabbix-server-mysql.tar.gz<br>-rw-r--r-- 1 root root  12779520 May 28 12:20 zabbix-web-nginx-mysql.tar.gz<br>[root@docker01 ~]<span class="hljs-comment"># for i in `ls *.tar.gz` ;do docker load -i $i ;done</span><br></code></pre></td></tr></tbody></table></figure><p>启动容器互联</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --name mysql-server -it \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -d mysql:5.7 \<br>      --character-set-server=utf8 --collation-server=utf8_bin<br><br>docker run --name zabbix-java-gateway -t \<br>      -d zabbix/zabbix-java-gateway:latest<br><br>docker run --name zabbix-server-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -e ZBX_JAVAGATEWAY=<span class="hljs-string">"zabbix-java-gateway"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-java-gateway:zabbix-java-gateway \<br>      -p 10051:10051 \<br>      -d zabbix/zabbix-server-mysql:latest<br><br>docker run --name zabbix-web-nginx-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-server-mysql:zabbix-server \<br>      -p 80:80 \<br>      -d zabbix/zabbix-web-nginx-mysql:latest<br></code></pre></td></tr></tbody></table></figure><p><strong>容器编排（yaml）</strong><br>作用：实现容器的批量管理<br>批量启动容器<br>批量停止容器<br>批量重启容器</p><p>docker-compose 单机容器编排(epel)</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl  -o /etc/yum.repos.d/epel.repo  http://mirrors.aliyun.com/repo/epel-7.repo<br></code></pre></td></tr></tbody></table></figure><p>安装docker-compose</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum  install -y  docker-compose<br></code></pre></td></tr></tbody></table></figure><p>docker-compose 有三个版本 v1 v2 v3 不同版本yaml语法不同</p><p>docker 重启 会死掉</p><p>设置容器随着docker启动而启动</p><p>设置容器随着docker启动而启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># docker run -d -it --restart always  wordpress:v1 tail -f /etc/hosts</span><br>21986a40f52fc415d3a77d1aa0ecab13c971ce0c214d44257b19611ca5e20109<br></code></pre></td></tr></tbody></table></figure><p>查看启动情况</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># docker ps -a -l</span><br>CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES<br>21986a40f52f        wordpress:v1        <span class="hljs-string">"tail -f /etc/hosts"</span>   8 seconds ago       Up 8 seconds                            reverent_goldwasser<br></code></pre></td></tr></tbody></table></figure><p>重启docker服务并查看</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># systemctl restart docker</span><br>[root@docker01 yum.repos.d]<span class="hljs-comment"># docker ps -a -l</span><br>CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES<br>21986a40f52f        wordpress:v1        <span class="hljs-string">"tail -f /etc/hosts"</span>   28 seconds ago      Up 1 second                             reverent_goldwasser<br>[root@docker01 yum.repos.d]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>通过yaml配置文件docker-compose 如何调用docker启动容器<br>每个docker-compose 单独一个目录<br>每个单独的docker-compose下只能一个docker-compose.yaml文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up   -d 后台创建并运行容器<br>docker-compose  down  停止并删除容器<br>docker-compose  start  批量启动容器<br>docker-compose stop   批量停止容器<br>docker-compose  restart  批量重启容器<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">version: <span class="hljs-string">'3'</span><br><br>services:<br>   mysql-server:<br>     image: mysql:5.7<br>     restart: always<br>     environment:<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>     <span class="hljs-built_in">command</span>: --character-set-server=utf8 --collation-server=utf8_bin<br>     <br>   zabbix-java-gateway:<br>     image: zabbix/zabbix-java-gateway:latest<br>     restart: always<br>     <br>   zabbix-server:<br>     depends_on:<br>       - mysql-server<br>     image: zabbix/zabbix-server-mysql:latest<br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       ZBX_JAVAGATEWAY: zabbix-java-gateway<br>     ports:<br>       - <span class="hljs-string">"10051:10051"</span><br>       <br>   zabbix-web-nginx-mysql:<br>     depends_on:<br>       - zabbix-server<br>     image: zabbix/zabbix-web-nginx-mysql:latest<br>     ports:<br>       - <span class="hljs-string">"80:80"</span><br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>dockerfile编写项目</title>
      <link href="/2020/05/28/dockerfile%E7%BC%96%E5%86%99%E9%A1%B9%E7%9B%AE/"/>
      <url>/2020/05/28/dockerfile%E7%BC%96%E5%86%99%E9%A1%B9%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<p><strong>项目一：dockerfile编写可道云</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 kode]<span class="hljs-comment"># ll</span><br>total 13596<br>-rw-r--r-- 1 root root      320 May 27 17:26 default.conf<br>-rw-r--r-- 1 root root      392 May 27 17:18 dockerfile<br>-rwxr-xr-x 1 root root       80 May 27 17:49 init.sh<br>-rw-r--r-- 1 root root 13894810 May 27 17:16 kodexplorer4.40.zip<br>-rw-r--r-- 1 root root    10016 May 27 17:15 www.conf<br>[root@docker01 kode]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p><strong>dockerfile 的附件</strong><br>1、dockerfile内容</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 kode]<span class="hljs-comment"># cat dockerfile</span><br>FROM  centos6.9_nginx_ssh:v3<br>RUN  yum install -y  php-fpm  php-gd php-mbstring<br>ADD  www.conf  /etc/php-fpm.d/www.conf<br>ADD  default.conf /etc/nginx/conf.d/default.conf<br>RUN  mkdir /code<br>WORKDIR  /code<br>ADD  kodexplorer4.40.zip .<br>RUN  yum install -y   unzip<br>RUN  unzip kodexplorer4.40.zip<br>RUN  chown -R nginx.nginx .<br>ADD  init.sh  /init.sh<br>EXPOSE 80<br>VOLUME  /code<br>CMD  [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br></code></pre></td></tr></tbody></table></figure><p>2、default.conf 配置文件内容</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">server {<br>    listen 80;<br>    server_name localhost;<br>    root /code;<br>    location / {<br>        index index.php index.html index.htm;<br>    }<br><br>    location ~ \.php$ {<br>        fastcgi_pass 127.0.0.1:9000;<br>        fastcgi_param SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;<br>                include fastcgi_params;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>3、init.sh脚本信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 kode]<span class="hljs-comment"># cat init.sh</span><br><span class="hljs-meta">#!/bin/bash</span><br>/usr/sbin/sshd<br>/etc/init.d/php-fpm start<br>nginx -g <span class="hljs-string">"daemon off;"</span><br></code></pre></td></tr></tbody></table></figure><p>4、www.conf php修改后的配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 kode]<span class="hljs-comment"># cat www.conf |grep nginx</span><br>user = nginx<br>group = nginx<br></code></pre></td></tr></tbody></table></figure><p><strong>项目二：dockerfile基于centos7系统构建WordPress</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:7<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>RUN yum install nginx mariadb-server php-fpm php-mysql -y<br>RUN mysql_install_db --user=mysql --defaults-file=/etc/my.cnf<br>RUN tmp=`nohup mysqld_safe --defaults-file=/etc/my.cnf &amp;` &amp;&amp; sleep 5 &amp;&amp; \<br> mysql -e <span class="hljs-string">"create database wordpress;"</span> &amp;&amp; \<br> mysql -e <span class="hljs-string">"grant all on wordpress.* to wordpress@localhost identified by '123456';"</span><br><br><br>ADD www.conf /etc/php-fpm.d/www.conf<br><br>ADD nginx.conf /etc/nginx/nginx.conf<br><br>RUN  mkdir /code<br>WORKDIR /code/<br>ADD wordpress-4.9.4-zh_CN.zip .<br>RUN yum install unzip -y<br><br>RUN  unzip wordpress-4.9.4-zh_CN.zip<br>RUN  mv wordpress/* .<br>RUN  chown -R nginx:nginx .<br><br>ADD init.sh /init.sh<br><br>CMD [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br></code></pre></td></tr></tbody></table></figure><p><strong>项目三：dockerfile基于centos6.9系统构建WordPress</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN  curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN  curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN  yum install -y  mysql-server<br>RUN /etc/init.d/mysqld  start &amp;&amp; /usr/bin/mysql -e <span class="hljs-string">"create database word;"</span> &amp;&amp; /usr/bin/mysql -e <span class="hljs-string">"grant all on word.* to 'word'@'localhost' identified by '123456';"</span><br>RUN  yum install -y nginx<br>RUN yum install -y  php-fpm  php-gd php-mbstring  php-mysql<br>COPY  www.conf /etc/php-fpm.d/www.conf<br>RUN /etc/init.d/php-fpm start<br>COPY  default.conf /etc/nginx/conf.d/default.conf<br>RUN  mkdir /word<br>COPY wordpress-4.8.13.zip /word<br>RUN  yum install -y  unzip<br>WORKDIR /word<br>RUN  unzip wordpress-4.8.13.zip<br>RUN  mv wordpress/* ./<br>RUN  chown  nginx.nginx  -R /word<br>EXPOSE 80<br>COPY  init.sh /init.sh<br>RUN chmod  a+x /init.sh<br>CMD  <span class="hljs-built_in">source</span> /init.sh<br></code></pre></td></tr></tbody></table></figure><p>脚本信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 word]<span class="hljs-comment"># cat init.sh</span><br><span class="hljs-meta">#!/bin/bash</span><br>/etc/init.d/mysqld  start<br>/etc/init.d/php-fpm start<br>nginx -g <span class="hljs-string">"daemon off;"</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>502 Bad Gateway</title>
      <link href="/2020/05/28/502%20Bad%20Gateway/"/>
      <url>/2020/05/28/502%20Bad%20Gateway/</url>
      
        <content type="html"><![CDATA[<p>502 Bad Gateway</p><p><strong>页面报错信息：502 Bad Gateway</strong><br>日志信息：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">2020/05/28 01:55:29 [error] 205<span class="hljs-comment">#0: *2 connect() failed (111: Connection refused) while connecting to upstream, client: 10.0.0.1, server: localhost, request: "GET / HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: "10.0.0.11:90"</span><br></code></pre></td></tr></tbody></table></figure><p><strong>原因</strong>：php-fpm  在centos6.9的系统中 使用/etc/init.d/php-fpm  start 启动后是秒死的</p><p>如果没有启动php-fpm 就会保这个错误<br><strong>解决：</strong><br>在docker容器中启动php-fpm的方法是</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">php-fpm -D<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Your PHP installation appears to be missing the MySQL</title>
      <link href="/2020/05/28/Your%20PHP%20installation%20appears%20to%20be%20missing%20the%20MySQL/"/>
      <url>/2020/05/28/Your%20PHP%20installation%20appears%20to%20be%20missing%20the%20MySQL/</url>
      
        <content type="html"><![CDATA[<p><strong>报错</strong>：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Your PHP installation appears to be missing the MySQL extension <span class="hljs-built_in">which</span> is required by WordPress.<br></code></pre></td></tr></tbody></table></figure><p><strong>原因</strong>：没有安装完整mysql与PHP对接的依赖<br><strong>解决办法</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  php-fpm  php-gd php-mbstring  php-mysql<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>dockerfile编写</title>
      <link href="/2020/05/27/dockerfile%E7%BC%96%E5%86%99/"/>
      <url>/2020/05/27/dockerfile%E7%BC%96%E5%86%99/</url>
      
        <content type="html"><![CDATA[<p>docker镜像  — 启动容器<br>v1—上传仓库   ----下载镜像   ----启动容器<br>v2 —上传仓库  -----下载镜像   —启动容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">dockerfile 配方v1  --用户----&gt;构建镜像---启动容器<br>dockerfile 配方v2  ---用户  -----&gt; 构架镜像---启动容器<br></code></pre></td></tr></tbody></table></figure><p>手动制作镜像和dockerfile的区别：<br>1、传输方便<br>2、支持自定义镜像的初始命令</p><p><strong>指令</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM  基础镜像<br>RUN   制作镜像过程中需要的执行命令(安装服务)<br>CMD   容器启动的时候执行的初始命令，容易被替换(启动服务)<br>ENTRYPOINT  容器启动的时候执行的初始命令，不能被替换，如果同时使用CMD和ENTRYPOINT，cmd命令将作为ENTRYPOINT命令的参数<br>ADD   把dockerfile当前目录下的文件拷贝到容器中（自动解压tar包）<br>COPY  把dockerfile当前目录下的文件拷贝到容器中（不解压tar包）<br>WORKDIR 指定容器的默认工作目录<br>EXPOSE  镜像要暴露的端口<br>VOLUME  持久化卷<br>ENV     环境变量(ssh的密码,数据库的密码)<br>LABEL       镜像的属性标签<br>MAINTAINER  管理者标识<br></code></pre></td></tr></tbody></table></figure><p>自动构建dockerfile镜像时需要一个dockerfile文件<br>一个镜像一个目录  一个镜像一个dockerfile</p><p><strong>简单构建一个基于centos6.9的nginx镜像</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 centos_nginx]<span class="hljs-comment"># cat dockerfile</span><br>FROM centos:6.9<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]  容器启动后的初始化命令<br></code></pre></td></tr></tbody></table></figure><p>构建镜像命令        buibuibuibui</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image build  -t  centos6.9_nginx:lsy .<br></code></pre></td></tr></tbody></table></figure><p>给构建的镜像命名   要有版本号</p><p><strong>自动构建dockerfile镜像步骤：</strong><br>1、手动制作一次docker镜像，记录历史命令<br>2、根据历史命令 编写dockerfile文件<br>3、docker build 构建镜像<br>4、测试docker镜像</p><p>每个镜像构建时都单独创建一个目录 在目录下编写dockerfile</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># cat dockerfile</span><br>FROM centos:6.9  基于当前docker images 中的镜像进行构建<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y  运行的命令<br>COPY  xiaoniao  /usr/share/nginx/html  不解压tar包<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]  容器运行时执行的命令 也是初始化命令<br></code></pre></td></tr></tbody></table></figure><p>docker 底层linux系统镜像 centos， Ubuntu，Debian，Alpine</p><p>清除构建失败的镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image prune<br></code></pre></td></tr></tbody></table></figure><p>查看镜像构建的过程</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 lsy]<span class="hljs-comment"># docker image history  xiaoniao:v1 </span><br> IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>b28a88f6d669        20 minutes ago      /bin/sh -c <span class="hljs-comment">#(nop)  CMD ["nginx" "-g" "daemon…   0B</span><br>3eb1210beb00        20 minutes ago      /bin/sh -c <span class="hljs-comment">#(nop) ADD dir:7f68cc1ed7946d74d3…   162kB</span><br>c49ca361424f        39 minutes ago      /bin/sh -c yum install nginx -y                 265MB<br>35c010dc84c5        41 minutes ago      /bin/sh -c curl -o /etc/yum.repos.d/epel.rep…   664B<br>dfcf950e01d9        41 minutes ago      /bin/sh -c curl -o /etc/yum.repos.d/CentOS-B…   2.52kB<br><br>adf829198a7f        21 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  CMD ["/bin/bash"]            0B</span><br>&lt;missing&gt;           21 months ago       /bin/sh -c <span class="hljs-comment">#(nop)  LABEL name=CentOS Base Im…   0B</span><br>&lt;missing&gt;           21 months ago       /bin/sh -c <span class="hljs-comment">#(nop) ADD file:b99efdfca7b4df4ef…   195MB</span><br></code></pre></td></tr></tbody></table></figure><p><strong>构建最基础的镜像</strong><br>1、获取一个最小的镜像到本地</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget  https://mirrors.tuna.tsinghua.edu.cn/lxc-images/images/alpine/3.11/amd64/default/20200526_13%3A00/rootfs.tar.xz<br></code></pre></td></tr></tbody></table></figure><p>2、移动路径到dockerfile目录下（ADD只能使用相对路径）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mv  /root/rootfs.tar.xz  .<br></code></pre></td></tr></tbody></table></figure><p>3、编写dockerfile文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM scratch<br>ADD rootfs.tar.xz /<br>CMD  [<span class="hljs-string">"/bin/sh"</span>]  注意这里是/bin/sh！！是因为最小系统 没有/bin/bash<br></code></pre></td></tr></tbody></table></figure><p>4、构建docker镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image build  -t alipen:lsy .<br></code></pre></td></tr></tbody></table></figure><p>5、启动容器并登录测试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -it  alipen:lsy   /bin/sh 构建最基础的镜像时没有指定初始化夯住命令<br>docker <span class="hljs-built_in">exec</span> -it   b655b22d29ee /bin/sh<br></code></pre></td></tr></tbody></table></figure><p><strong>WORKDIR指令作用</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>ADD  xiaoniao.tar.gz  /usr/share/nginx/html<br>WORKDIR /usr/share/nginx/html  切换登录时的目录<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure><p>指定端口</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># cat dockerfile</span><br>FROM centos:6.9<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>ADD  xiaoniao.tar.gz  /usr/share/nginx/html<br>WORKDIR /usr/share/nginx/html<br>EXPOSE  80 22 开放端口  和docker run  -P 使用时起作用<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure><p>结合端口使用</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># docker ps -a -l</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                          NAMES<br>f7af944b7804        xiaoniao:v6         <span class="hljs-string">"nginx -g 'daemon of…"</span>   7 seconds ago       Up 6 seconds        0.0.0.0:32769-&gt;22/tcp, 0.0.0.0:32768-&gt;80/tcp   bold_snyder<br></code></pre></td></tr></tbody></table></figure><p><strong>volume  创建随机名字的卷</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>ADD  xiaoniao.tar.gz  /usr/share/nginx/html<br>WORKDIR /usr/share/nginx/html<br>EXPOSE  80 22<br>VOLUME /usr/share/nginx/html 将容器的目录持久化到宿主机的随机卷<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># docker run -d -P  xiaoniao:v7</span><br>9f7366ddf4209b4e3147d884b6b5e427fed55ca5d0ed10bc411e5ce3cab79543<br>[root@docker01 xiaoniao]<span class="hljs-comment"># docker volume ls</span><br>DRIVER              VOLUME NAME<br><span class="hljs-built_in">local</span>               590db49fbecbe1614928b0bf1452c35eecb95bcdc4428129dc1a41a3ad21b657<br>[root@docker01 xiaoniao]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p><strong>ENV指定环境变量</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>ADD  xiaoniao.tar.gz  /usr/share/nginx/html<br>WORKDIR /usr/share/nginx/html<br>EXPOSE  80 22<br>VOLUME /usr/share/nginx/html<br>ENV LIUSHIYA 123456<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># docker run -it  xiaoniao:v8   /bin/bash</span><br>[root@7f229d087161 html]<span class="hljs-comment"># env</span><br>....<br>LIUSHIYA=123456<br></code></pre></td></tr></tbody></table></figure><p>docker不走开机启动  /etc/profile不会被加载</p><p>docker不走 开机启动流程 是优势  启动快 劣势是不加载开机启动时的文件  但是ENV等指令可以补这个缺点</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>WARNING REMOTE HOST IDENTIFICATION HAS CHANGED</title>
      <link href="/2020/05/27/ssh%E6%8A%A5%E9%94%99/"/>
      <url>/2020/05/27/ssh%E6%8A%A5%E9%94%99/</url>
      
        <content type="html"><![CDATA[<p>在测试dockerfile根据环境变量来控制root用户密码时 出现报错如下</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 centos_nginx]<span class="hljs-comment"># ssh  root@10.0.0.11 -p1022</span><br>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @<br>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!<br>Someone could be eavesdropping on you right now (man-in-the-middle attack)!<br>It is also possible that a host key has just been changed.<br>The fingerprint <span class="hljs-keyword">for</span> the RSA key sent by the remote host is<br>SHA256:tWl86iRp7oRjF2WQahyBVvBj8Sjc4wNZM67YNaRS6aE.<br>Please contact your system administrator.<br>Add correct host key <span class="hljs-keyword">in</span> /root/.ssh/known_hosts to get rid of this message.<br>Offending RSA key <span class="hljs-keyword">in</span> /root/.ssh/known_hosts:2<br>RSA host key <span class="hljs-keyword">for</span> [10.0.0.11]:1022 has changed and you have requested strict checking.<br>Host key verification failed.<br></code></pre></td></tr></tbody></table></figure><p><strong>原因</strong><br>每次失败之后 会删除失败的容器 并修改dockerfile 打算从新来过  但是每次重新启动时<br>指定的端口都是一样的<br>公钥验证不匹配  就 会出现这个错误<br><strong>解决办法</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 centos_nginx]<span class="hljs-comment"># &gt; ~/.ssh/known_hosts</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>手动制作docker镜像</title>
      <link href="/2020/05/27/%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F/"/>
      <url>/2020/05/27/%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<p><strong>手动制作docker镜像（单个服务）的流程</strong><br>1、启动一个纯净的容器 ，在容器中安装服务<br>2、把安装好服务的容器提交为镜像<br>3、测试镜像</p><p>制作一个基于centos6系统的nginx镜像(单服务)</p><p>1:启动一个纯净的centos:6.9容器,安装nginx</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>yum install nginx -y<br></code></pre></td></tr></tbody></table></figure><p>2:把安装好服务的容器,提交为镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker container commit eb109f194821 centos6.9_nginx:v1<br></code></pre></td></tr></tbody></table></figure><p>3:测试镜像的功能</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d  -p 82:80 centos6.9_nginx:v1 nginx -g <span class="hljs-string">'daemon off;'</span><br> <br> <br> curl -I  10.0.0.11:82<br>HTTP/1.1 200 OK<br>Server: nginx/1.10.3<br>Date: Wed, 27 May 2020 02:26:26 GMT<br>Content-Type: text/html<br>Content-Length: 3698<br>Last-Modified: Tue, 07 May 2019 06:09:40 GMT<br>Connection: keep-alive<br>ETag: <span class="hljs-string">"5cd12124-e72"</span><br>Accept-Ranges: bytes<br></code></pre></td></tr></tbody></table></figure><p>手动做的镜像不能修改初始命令  自动的可以修改</p><p><strong>手动制作镜像（双服务）</strong><br>启动一个已经安装nginx的容器  安装ssh<br>1、启动一个nginx基础容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -it  -p 88:80  -p 1022:22 centos6.9_nginx:v1 /bin/bash<br>yum install -y  openssh-server <br>service sshd restart<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'123456'</span>|passwd  --stdin root<br></code></pre></td></tr></tbody></table></figure><p>指定进程  不会秒死</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d  -it  -p 89:80 -p 1022:22 centos6.9_nginx_ssh:v2<br></code></pre></td></tr></tbody></table></figure><p>进入容器之后<br>启动双服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@b464d8664f20 /]<span class="hljs-comment"># /etc/init.d/sshd start</span><br>Starting sshd:                                             [  OK  ]<br>[root@b464d8664f20 /]<span class="hljs-comment"># nginx</span><br></code></pre></td></tr></tbody></table></figure><p>在制作镜像之前<br>写一个脚本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@1b8dfe535159 ~]<span class="hljs-comment"># cat /init.sh</span><br><span class="hljs-meta">#!/bin/bash</span><br>/etc/init.d/sshd  start<br>nginx -g <span class="hljs-string">'daemon  off;'</span><br></code></pre></td></tr></tbody></table></figure><p>并授权可执行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chmod  +x   /init.sh<br></code></pre></td></tr></tbody></table></figure><p>执行尝试一下</p><p>没有问题  退出  制作镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker container  commit d063154e7962 lsy_test:v1</span><br>sha256:715c718400b2b33abaf2b03fe853aad6856c87e6d9edafb6da2d53270afab108<br>[root@docker01 ~]<span class="hljs-comment"># docker rm -f `docker ps -a -q`</span><br>d063154e7962<br></code></pre></td></tr></tbody></table></figure><p>运行镜像 启动容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker run -d -p 90:80 -p 1024:22  lsy_test:v1   /init.sh</span><br>1b8dfe535159c05abac6551b21a4ed0e9512c511874b87af191fbd63175f1d31<br>[root@docker01 ~]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                      NAMES<br>1b8dfe535159        lsy_test:v1         <span class="hljs-string">"/init.sh"</span>          6 seconds ago       Up 4 seconds        0.0.0.0:1024-&gt;22/tcp, 0.0.0.0:90-&gt;80/tcp   hungry_lamarr<br>[root@docker01 ~]<span class="hljs-comment"># ssh  root@10.0.0.11 -p 1024  测试</span><br>root@10.0.0.11<span class="hljs-string">'s password:</span><br><span class="hljs-string">Last login: Wed May 27 03:17:32 2020 from 10.0.0.11 </span><br><span class="hljs-string">[root@1b8dfe535159 ~]# exit</span><br><span class="hljs-string">logout</span><br><span class="hljs-string">Connection to 10.0.0.11 closed.</span><br><span class="hljs-string"> 测试</span><br><span class="hljs-string">[root@docker01 ~]# curl  -I  10.0.0.11:90</span><br><span class="hljs-string">HTTP/1.1 200 OK</span><br><span class="hljs-string">Server: nginx/1.10.3</span><br><span class="hljs-string">Date: Wed, 27 May 2020 03:22:29 GMT</span><br><span class="hljs-string">Content-Type: text/html</span><br><span class="hljs-string">Content-Length: 3698</span><br><span class="hljs-string">Last-Modified: Tue, 07 May 2019 06:09:40 GMT</span><br><span class="hljs-string">Connection: keep-alive</span><br><span class="hljs-string">ETag: "5cd12124-e72"</span><br><span class="hljs-string">Accept-Ranges: bytes</span><br></code></pre></td></tr></tbody></table></figure><p>docker  共用宿主机内核  直接启动自己的服务  不走开机启动流程<br>容器的初始命令只能执行一条</p><p><strong>部署有道云盘并制作镜像</strong><br>注释：有道云网盘不需要后端数据库服务</p><p>制作一个kodexplorer镜像(nginx+php)<br>1：启动一个基础环境的容器，在容器中安装服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 80:80 centos6.9_nginx:v1 /bin/bash<br>yum install php-fpm php-gd php-mbstring -y<br></code></pre></td></tr></tbody></table></figure><p>修改PHP配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /etc/php-fpm.d/www.conf<br>user = nginx<br>group = nginx<br></code></pre></td></tr></tbody></table></figure><p>写入nginx配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /etc/nginx/conf.d/default.conf<br>server {<br>    listen 80;<br>    server_name localhost;<br>    root /code;<br>    location / {<br>        index index.php index.html index.htm;<br>    }<br><br>    location ~ \.php$ {<br>        fastcgi_pass 127.0.0.1:9000;<br>        fastcgi_param SCRIPT_FILENAME <span class="hljs-variable">$document_root</span><span class="hljs-variable">$fastcgi_script_name</span>;<br>                include fastcgi_params;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>创建站点目录</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /code<br></code></pre></td></tr></tbody></table></figure><p>宿主机操作：将本地的有道代码文件放入到容器中</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker cp kodexplorer4.40.zip f12048d09d53:/code<br></code></pre></td></tr></tbody></table></figure><p>解压并授权</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install unzip -y<br>unzip kodexplorer4.40.zip<br>chown -R nginx:ngin<br></code></pre></td></tr></tbody></table></figure><p>编写一个自动启动脚本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><br>service php-fpm start<br>nginx -g <span class="hljs-string">'daemon off;'</span><br></code></pre></td></tr></tbody></table></figure><p>2：把安装好服务的容器提交为镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker commit f12048d09d53 kod:v1<br></code></pre></td></tr></tbody></table></figure><p>3：测试docker run</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 81:80 kod:v1 /bin/bash /init.sh<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>KVM基本管理</title>
      <link href="/2020/05/27/kvm%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/"/>
      <url>/2020/05/27/kvm%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p><strong>介绍云计算</strong><br>云计算和虚拟化有什么不同？<br>没有可比性  ；<br><code>云计算是一种按量付费的模式，云计算的底层是由虚拟化技术来实现的</code>。<br><code>一个是模式  一个是技术</code></p><p>最先提出云计算概念，亚马逊 从2006年开始提供云计算<br>阿里云 2008年创建团队  2011年正式对外提供服务</p><p>按量付费的模式</p><p>没有云计算之前 ，运维的工作非常杂</p><p>硬件  服务器型号  raid知识  网络知识  对运维人员的身体素质都有要求的   等<br>物理服务器</p><p>数据库服务器要做raid10  存储服务器做raid5    web服务器raid5</p><p>硬件性能特别高 ，需要对服务器做虚拟化</p><p>服务器配置  4课CPU  40核心   内存2T  硬盘2.5 可以插很多块12x4T</p><p>这么高配置的服务器  只运行一个ftp的话  过多的性能浪费<br>多运行一些 来提高资源的利用率<br>很多服务 运行环境不同  彼此冲突<br>jumpserver 和ansible相互冲突    依赖的python模块版本不同  环境乱 管理难度很大</p><p>虚拟化切分成一个一个独立运行环境的虚拟机</p><p>没有云计算之前 运维就是打杂的  什么都得会</p><p>服务类型</p><p>iaas 底层硬件+操作系统    运维的工作：部署运维环境lnmp  放入服务代码<br>paas  底层硬件+操作系统+运维行业 运维：放入服务代码   备份数据<br>saas:  底层硬件+操作系统+运行环境+服务代码+数据   运维：掏钱买服务</p><p>有了云计算之后  运维更加专注网站架构设置</p><p>为什么要用云计算？<br>小公司：游戏公司  研发一款游戏  上线  有玩家充值了  才算是有收入；托管到IDC机房<br>大公司：每年都会有一些大型活动，活动过后 造成资源闲置   出现大量闲置的计算资源</p><p>阿里云最挣钱   前期低价吸引用户  后期涨价</p><p>IDC机房  ：互联网数据中心  微软 腾讯  阿里</p><p>容器 ：进程级别虚拟化<br>KVM：虚拟化技术</p><p><strong>什么是虚拟化？</strong><br>虚拟化，通过模拟计算机的硬件，来实现同一台计算机上</p><p>物理服务器：称为宿主机<br>通过VMware 模拟一台物理服务器，来实现同一台同时运行多个不同的操作系统的技术</p><p><strong>linux虚拟化软件：</strong></p><p>1、qemu 软件纯模拟全虚拟化软件 特变慢  兼容性好（因为全部都是虚拟模拟的，不基于硬件）   qemu是虚拟化技术的鼻祖   qemu可以运行一切的操作系统</p><p>2、xen（半）   性能特别好 需要使用专门修改后的内核，兼容性差  Redhat5.5  xen  kvm  xen没有模拟全部的硬件  直接使用物理机的CPU  ；为了避免虚拟机里面执行reboot命令 导致宿主机也胡重启<br>xen  的虚拟机需要使用专门的内核，这个操作系统内核会翻译转换一些指令。</p><p>3、KVM 全虚拟机  他有硬件支持CPU   基于内核，而且不需要使用专门的内核，centos6 kvm 性能好  兼容性较好     内置在linux的内核模块的</p><p>VMware  workstations   需要linux的安装centos为 图形界面</p><p>virtual  box    图形界面  Oracle</p><p>安装一个KVM的管理工具  因为已经是基于内核了<br>kvm全称：Kernel-based Virtual Machine  属于内核的模块<br>linux都是通过应用程序来调用内核的      通过内核来 调用硬件<br>qemu-kvm    管理虚拟机的虚拟磁盘</p><p>关闭tab 滴滴的声音</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@virtualization ~]<span class="hljs-comment"># cat /etc/inputrc</span><br><span class="hljs-comment"># do not bell on tab-completion</span><br><span class="hljs-built_in">set</span> bell-style none<br></code></pre></td></tr></tbody></table></figure><p>为什么要使用vnc  ？<br>linux是一个纯命令行的系统 不支持图形界面<br>kvm启动虚拟机之后 将虚拟机的控制台通过vnc协议输出 相当与启动了一个vnc服务端<br>vnc分为客户端和服务端</p><p>注意：安装centos7系统时  没有勾选中文支持会导致Jenkins无法汉化</p><p>安装kvm虚拟化管理工具</p><p>环境要求：</p><p>centos 7.4   7.6</p><p>vmware   宿主机  kvm虚拟机</p><p>内存4G，cpu开启虚拟化</p><p>echo  ‘192.168.12.201  <a href="http://mirrors.aliyun.com" target="_blank" rel="noopener">mirrors.aliyun.com</a>’ &gt;&gt;/etc/hosts</p><p>curl -o /etc/yum.repos.d/CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-7.repo" target="_blank" rel="noopener">http://mirrors.aliyun.com/repo/Centos-7.repo</a></p><p>安装软件包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install libvirt virt-install qemu-kvm -y<br></code></pre></td></tr></tbody></table></figure><p>解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">libvirt  作用：虚拟机的管理软件<br>libvirt: kvm,xen,qemu,lxc....<br><br>virt   virt-install virt-clone   作用：虚拟机的安装工具和克隆工具<br>qemu-kvm  qemu-img (qcow2,raw)作用：管理虚拟机的虚拟磁盘<br></code></pre></td></tr></tbody></table></figure><p>开启服务  并设置为开机自启</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start libvirtd.service<br>systemctl status libvirtd.service<br></code></pre></td></tr></tbody></table></figure><p>查看加载的内核模块</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># lsmod |grep kvm</span><br>kvm_intel             183621  3<br>kvm                   586948  1 kvm_intel<br>irqbypass              13503  1 kvm<br></code></pre></td></tr></tbody></table></figure><p>qemu 是管理虚拟机进程的</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"> netstat  -ntpl<br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name<br>tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      18096/qemu-kvm<br>tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      10752/dnsmasq<br>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      8635/sshd<br>tcp6       0      0 :::22                   :::*                    LISTEN      8635/sshd<br>[root@kvmnode01 qemu]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>启动虚拟机时 自动检查端口   5900</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">shutdown： 关机速度慢  安全<br>destroy:  关机速度快  不安全 异常关机  容易造成mysql启动失败<br>reboot： virsh stop  virsh  start<br></code></pre></td></tr></tbody></table></figure><p>kvm虚拟机主要有配置文件和磁盘文件组成<br>修改配置之前进行备份</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh   dumpxml centos7 输出配置文件<br>virsh  dumpxml  centos7 &gt;centos8 备份配置文件<br></code></pre></td></tr></tbody></table></figure><p>配置文件 决定了虚拟机的硬件配置</p><p>文件名字是给自己看的  起名字一定要见名知意</p><p><strong>kvm虚拟机管理操作：</strong></p><p>创建虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /opt/centos2.raw,format=raw,size=10 --cdrom /opt/CentOS-7-x86_64-DVD-1708.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole<br></code></pre></td></tr></tbody></table></figure><p>解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">vnc：10.0.0.11:5900  默认vnc的连接登录端口 <br>--virt-type kvm 虚拟化的类型(qemu)  <br>--os-type=linux 系统类型<br> --os-variant rhel7 系统版本 查看支持的系统版本 osinfo-query os<br> --name centos7 虚拟机的名字 必须唯一<br> --memory 1024 虚拟机的内存<br> --vcpus 1 虚拟cpu的核数 <br>--disk /opt/centos2.raw,format=raw,size=10  虚拟硬盘 每个虚拟机的磁盘文件必须唯一<br>--cdrom /opt/CentOS-7-x86_64-DVD-1708.iso   镜像源<br>--network network=default 使用默认NAT的网络<br> --graphics vnc,listen=0.0.0.0  配置虚拟机显示设置 vnc协议  监听0.0.0.0<br> --noautoconsole  不要自动尝试连接到客户端控制台<br></code></pre></td></tr></tbody></table></figure><p>kvm虚拟机默认配置文件位置</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 qemu]<span class="hljs-comment"># pwd</span><br>/etc/libvirt/qemu<br>[root@kvmnode01 qemu]<span class="hljs-comment"># ls</span><br>centos7.xml  networks<br>[root@kvmnode01 qemu]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>virsh version 查看kvm的版本信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">Compiled against library: libvirt 4.5.0<br>Using library: libvirt 4.5.0<br>Using API: QEMU 4.5.0<br>Running hypervisor: QEMU 1.5.3<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 ~]<span class="hljs-comment"># virsh vcpuinfo  centos7  查看虚拟机的CPU信息</span><br>VCPU:           0<br>CPU:            0<br>State:          running<br>CPU time:       119.8s<br>CPU Affinity:   y<br></code></pre></td></tr></tbody></table></figure><p>查看kvm 虚拟机列表</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 qemu]<span class="hljs-comment"># virsh list 显示正在运行的虚拟机</span><br> Id    Name                           State<br>----------------------------------------------------<br> 2     centos7                        running<br><br>[root@kvmnode01 qemu]<span class="hljs-comment"># virsh list --all</span><br> Id    Name                           State<br>----------------------------------------------------<br> 2     centos7                        running<br></code></pre></td></tr></tbody></table></figure><p>启动centos7虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  start  centos7<br></code></pre></td></tr></tbody></table></figure><p>设置虚拟机跟随系统启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  autostart  centos7<br></code></pre></td></tr></tbody></table></figure><p>关闭虚拟机自启</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  autostart --<span class="hljs-built_in">disable</span> centos7<br></code></pre></td></tr></tbody></table></figure><p>关闭centos7的虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh shutdown centos7<br></code></pre></td></tr></tbody></table></figure><p>拔出电源关闭centos7的虚拟机  什么情况下使用这种方式关机    当虚拟机还有装系统的时候使用这样方式</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  destory centos7<br></code></pre></td></tr></tbody></table></figure><p>移除centos7的虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  undefine  centos7<br></code></pre></td></tr></tbody></table></figure><p>设置centos7虚拟机开机启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh   autostart  centos7<br></code></pre></td></tr></tbody></table></figure><p>默认情况下 virsh工具不能对linux虚拟机进行关机操作（在虚拟机内部进行关机操作）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  acpid<br>/etc/init.d/acpid  start<br></code></pre></td></tr></tbody></table></figure><p>通过配置文件启动虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh   create  /etc/libvirt/qemu/centos7.xml<br></code></pre></td></tr></tbody></table></figure><p>挂起回复virsh命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh   <span class="hljs-built_in">suspend</span>  centos7  挂起<br>virsh  resume  centos7    恢复<br></code></pre></td></tr></tbody></table></figure><p><strong>修改虚拟机名字</strong></p><p>修改虚拟机名字<br>1、导出虚拟机配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  dumpxml centos7 &gt; <span class="hljs-built_in">test</span>-centos7.xml<br></code></pre></td></tr></tbody></table></figure><p>2、更改配置文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">'s/centos7/test-centos7/g'</span> <span class="hljs-built_in">test</span>-centos7.xml<br></code></pre></td></tr></tbody></table></figure><p>3、移除原有的虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  undefine  <span class="hljs-built_in">test</span>-centos7<br></code></pre></td></tr></tbody></table></figure><p>4、通过配置文件  导入虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  define <span class="hljs-built_in">test</span>-centos7.xml<br></code></pre></td></tr></tbody></table></figure><p>5、启动虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  start  centos7<br></code></pre></td></tr></tbody></table></figure><p>问题1：可以命令方式修改主机名吗<br>可以</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  domrename centos7  centos2  将centos7修改名为centos2<br></code></pre></td></tr></tbody></table></figure><p>如果修改了虚拟机的文件 再启动不可以吗  为什么要移除原来的虚拟机</p><p>是因为已经加载了配置文件，需要重新导入</p><p>虚拟机的IP地址可以修改吗</p><p>默认的配置信息是dhcp 并不代表是不能设置为static 手动设置</p><p>显示虚拟机信息</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 qemu]<span class="hljs-comment"># virsh  dominfo  centos7</span><br>Id:             2<br>Name:           centos7<br>UUID:           ee1fb9d9-0df9-4b38-aeb7-afef00a39247<br>OS Type:        hvm<br>State:          running<br>CPU(s):         1<br>CPU time:       584.4s<br>Max memory:     1048576 KiB<br>Used memory:    1048576 KiB<br>Persistent:     yes<br>Autostart:      <span class="hljs-built_in">disable</span><br>Managed save:   no<br>Security model: none<br>Security DOI:   0<br><br>[root@kvmnode01 qemu]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>查看虚拟机内存和CPU使用情况</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum  install -y  virt-top<br>virt-top<br></code></pre></td></tr></tbody></table></figure><p>查看虚拟机的分区情况</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 qemu]<span class="hljs-comment"># virt-df centos7</span><br>Filesystem                           1K-blocks       Used  Available  Use%<br>libguestfs: error: list_filesystems: sgdisk: Invalid partition data!<br>[root@kvmnode01 qemu]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>修改配置文件  默认会检查语法</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh edit centos7<br></code></pre></td></tr></tbody></table></figure><p>这样修改不需要重新define。 但是需要手动shutdown 和  start 不能reboot 是因为进程需要重新生成才可以</p><p>在kvm虚拟机关机状态下  可以在线状态下修改名字</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh domrename centos2  centos7<br></code></pre></td></tr></tbody></table></figure><p>挂起操作：以及状态</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># virsh  suspend   centos7</span><br>Domain centos7 suspended<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh   list  --all</span><br> Id    Name                           State<br>----------------------------------------------------<br> 12    centos7                        paused<br></code></pre></td></tr></tbody></table></figure><p>解放挂起</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># virsh resume  centos7</span><br>Domain centos7 resumed<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh list  --all</span><br> Id    Name                           State<br>----------------------------------------------------<br> 12    centos7                        running<br><br>[root@kvmnode01 opt]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>虚拟机挂起    会导致时间不一致的问题<br>虚拟机模拟的时钟频率    虚拟机运行时间一长   就容易导致时间不对<br>需要做时间同步</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  chronyd <br>systemctl  restart  chronyd<br></code></pre></td></tr></tbody></table></figure><p>查看时间同步</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># timedatectl</span><br>      Local time: Thu 2020-05-21 17:33:49 CST<br>  Universal time: Thu 2020-05-21 09:33:49 UTC<br>        RTC time: Thu 2020-05-21 09:33:48<br>       Time zone: Asia/Shanghai (CST, +0800)<br>     NTP enabled: yes<br>NTP synchronized: yes<br> RTC <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span> TZ: no<br>      DST active: n/a<br>[root@kvmnode01 opt]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>查看kvm虚拟机端口  是vnc的最后一位端口数  5900 最后一位就是0  第二台5901 就是1</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># virsh  list  --all</span><br> Id    Name                           State<br>----------------------------------------------------<br> 12    centos7                        running<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh   vncdisplay  centos7</span><br>:0<br><br>[root@kvmnode01 opt]<span class="hljs-comment">#</span><br><br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh vncdisplay  1</span><br>:0<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh vncdisplay  centos2.raw</span><br>:0<br><br>[root@kvmnode01 opt]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>服务器，通电后 自动启动</p><p>配置虚拟机随宿主机启动而启动</p><p>配置开机自启动<br>virsh  autostart   centos7</p><p>设置了开机自启动的都在autostart中有软连接</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 qemu]<span class="hljs-comment"># ll</span><br>total 16<br>drwxr-xr-x 2 root root    6 May 21 17:49 autostart<br>-rw------- 1 root root 4521 May 21 17:41 centos2.raw.xml<br>-rw------- 1 root root 4513 May 21 17:20 centos7.xml<br>drwx------ 3 root root   42 May 21 12:24 networks<br>[root@kvmnode01 qemu]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>或者使用这个命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 autostart]<span class="hljs-comment"># virsh   list  --autostart</span><br> Id    Name                           State<br>----------------------------------------------------<br> 1     centos2.raw                    running<br> 2     centos7                        running<br></code></pre></td></tr></tbody></table></figure><p>测试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 autostart]<span class="hljs-comment"># systemctl restart  libvirtd.service</span><br>[root@kvmnode01 autostart]<span class="hljs-comment"># virsh   list</span><br> Id    Name                           State<br>----------------------------------------------------<br> 1     centos2.raw                    running<br> 2     centos7                        running<br></code></pre></td></tr></tbody></table></figure><p>关闭开机自启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># virsh   autostart   --disable  centos7</span><br>Domain centos7 unmarked as autostarted<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh  list   --autostart</span><br> Id    Name                           State<br>----------------------------------------------------<br> 1     centos2.raw                    running<br></code></pre></td></tr></tbody></table></figure><p>开启开机自启动</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 opt]<span class="hljs-comment"># virsh   autostart   centos7</span><br>Domain centos7 marked as autostarted<br><br>[root@kvmnode01 opt]<span class="hljs-comment"># virsh   list  --autostart</span><br> Id    Name                           State<br>----------------------------------------------------<br> 1     centos2.raw                    running<br> 2     centos7                        running<br></code></pre></td></tr></tbody></table></figure><p>ssh登录到kvm虚拟机<br>只能是本地宿主机登录 ，需要提前到vnc查看IP地址</p><p>在kvm虚拟机进行操作<br>修改内核命令  使用console命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grubby --update-kernel=ALL --args=<span class="hljs-string">"console=ttyS0,115200n8"</span><br>reboot<br></code></pre></td></tr></tbody></table></figure><p>console登录到虚拟机</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode01 autostart]<span class="hljs-comment"># virsh console  centos7</span><br>Connected to domain centos7<br>Escape character is ^]<br><br>CentOS Linux 7 (Core)<br>Kernel 3.10.0-957.el7.x86_64 on an x86_64<br><br>localhost login: root<br>Password:<br>Last login: Thu May 21 17:57:44 from gateway<br>[root@localhost ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>ctrl1  +】 回到宿主机上</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">CentOS Linux 7 (Core)<br>Kernel 3.10.0-957.el7.x86_64 on an x86_64<br><br>localhost login:<br>[root@kvmnode01 autostart]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>再次console是不需要重新登录</p><p>只要保存一个centos7.raw 和vm_centos7.xml 配置文件 就可以了 不用以后再使用vnc去安装系统了。</p><p>关于磁盘文件格式的问题：</p><p>因为xfs文件系统的原因，他们实例占用空间不多  ，qemu-img info  看到的理论上的10G 未必是真实的    用du就能看到他们实际占用大小</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>网络端口+持久化卷</title>
      <link href="/2020/05/26/%E7%BD%91%E7%BB%9C%E7%AB%AF%E5%8F%A3+%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%B7/"/>
      <url>/2020/05/26/%E7%BD%91%E7%BB%9C%E7%AB%AF%E5%8F%A3+%E6%8C%81%E4%B9%85%E5%8C%96%E5%8D%B7/</url>
      
        <content type="html"><![CDATA[<p>docker是一个软件打包的技术<br>docker容器默认只有内网</p><p>假设：启动了一个WordPress容器  只有宿主机可以访问这个WordPress。<br>容器没有桥接模式  做端口映射 用来让外界访问</p><p>端口映射：<br>客户访问宿主机某个端口  宿主机做端口转发    将请求转发到容器的80端口<br>docker  run -d  -it  -p 80本地端口:80容器端口   nginx:latest  /bin/bash<br>企业级宽带   静态ip   公网ip<br>外网用户  路由器  端口映射    内网服务器</p><p>容器的端口转发 是使用iptables端口映射的方式<br>iptables  -nL</p><p>多个容器使用80端口（前提：多个ip）<br>添加一个外网ip</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ifconfig   eth0:1 10.0.0.13/24 up<br></code></pre></td></tr></tbody></table></figure><p>多个网卡的80端口对应多个容器的80端口（虽然是基于同一个镜像启动的容器）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  run -d  -p 10.0.0.11:80:80  nginx:latest</span><br>559c9057f46659b4b410f57ff1a9186bd3fade5ba06e3ae04299bdff93079475<br>[root@docker01 ~]<span class="hljs-comment"># docker  run -d  -p 10.0.0.13:80:80  nginx:latest</span><br>22872a511cc7c6e422f662b6cff9eed6c1c522b36e126010d92f101d2d760559<br>[root@docker01 ~]<span class="hljs-comment"># docker  ps -a</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES<br>22872a511cc7        nginx:latest        <span class="hljs-string">"nginx -g 'daemon of…"</span>   6 seconds ago       Up 5 seconds        10.0.0.13:80-&gt;80/tcp   epic_grothendieck<br>559c9057f466        nginx:latest        <span class="hljs-string">"nginx -g 'daemon of…"</span>   13 seconds ago      Up 12 seconds       10.0.0.11:80-&gt;80/tcp   epic_cohen<br></code></pre></td></tr></tbody></table></figure><p>IP地址端不同  但是每个IP地址的端口和80容器端口对应  也就是说 一个web容器 允许多个 不同IP地址进行映射</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  rm -f  `docker  ps -a -q`</span><br>22872a511cc7<br>559c9057f466<br>[root@docker01 ~]<span class="hljs-comment"># docker run -d  -p 10.0.0.11::80  -p 10.0.0.13::80 nginx:latest</span><br>14ec410a394bd4cd672a477f30320f2585fe9300aabfe1c7eeae11e2b1cfab29<br>[root@docker01 ~]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                              NAMES<br>14ec410a394b        nginx:latest        <span class="hljs-string">"nginx -g 'daemon of…"</span>   6 seconds ago       Up 5 seconds        10.0.0.11:32768-&gt;80/tcp, 10.0.0.13:32768-&gt;80/tcp   gallant_lovelace<br>[root@docker01 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>批量做端口映射</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d -p 10.0.0.12::80  -p 10.0.0.13::81  nginx:latest<br></code></pre></td></tr></tbody></table></figure><p>前10个  后10个</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d -P   nginx:latest<br></code></pre></td></tr></tbody></table></figure><p>自动做随机端口映射</p><p>docker是一个软件打包技术<br>PaaS层主要使用docker技术<br>docker数据卷</p><p>如果-v 指定宿主机的绝对目录  和    指定容器目录时  会持久化到卷里面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># docker  run -d -P  -v /opt/xiaoniao:/usr/share/nginx/html  nginx:latest</span><br>d2a9a8d2e251246a9a42b41bfe2dd79c5a2b6c8b312c1e182c98088a69482ff6<br>[root@docker01 xiaoniao]<span class="hljs-comment"># -P    随机指定端口  如果是有多个网卡  那么也是多个IP地址 的同一个端口进行访问</span><br>[root@docker01 xiaoniao]<span class="hljs-comment">#     -v /opt/xiaoniao:/usr/share/nginx/html  </span><br> -v   /opt/xiaoniao是指定 本地的文件     /usr/share/nginx/html是容器的默认站点目录  <br>[root@docker01 xiaoniao]<span class="hljs-comment"># docker ps -a</span><br>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                              NAMES<br>d2a9a8d2e251        nginx:latest        <span class="hljs-string">"nginx -g 'daemon of…"</span>   7 seconds ago       Up 6 seconds        0.0.0.0:32769-&gt;80/tcp                              keen_johnson<br>14ec410a394b        nginx:latest        <span class="hljs-string">"nginx -g 'daemon of…"</span>   8 minutes ago       Up 8 minutes        10.0.0.11:32768-&gt;80/tcp, 10.0.0.13:32768-&gt;80/tcp   gallant_lovelace<br>[root@docker01 xiaoniao]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>10.0.0.13：32769<br>10.0.0.11:32769</p><p>如果-v 只指定容器目录时  会持久化到卷里面</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 xiaoniao]<span class="hljs-comment"># docker  run -d -P  -v  /usr/share/nginx/html  nginx:latest</span><br>b601a86e20b29b89f3f3572ff40b5fe82d1b60a03d39a98db0213b6448f33684<br>[root@docker01 xiaoniao]<span class="hljs-comment"># docker volume  ls</span><br>DRIVER              VOLUME NAME<br><span class="hljs-built_in">local</span>               9b2aac171a4a95e40c4d3ea2c07976c809bdc3ef90154fd78fc973db1438da60<br>[root@docker01 xiaoniao]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>容器删除  目录/usr/share/nginx/html下的数据文件会在本地宿主机的卷中</p><p>数据卷持久化</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d -P  -v  /usr/share/nginx/html  nginx:latest<br> docker volume  ls<br>[root@docker01 volumes]<span class="hljs-comment"># docker  inspect  b601a86e20b2  |grep  -i volume</span><br>            <span class="hljs-string">"VolumeDriver"</span>: <span class="hljs-string">""</span>,<br>            <span class="hljs-string">"VolumesFrom"</span>: null,<br>                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"volume"</span>,<br>                <span class="hljs-string">"Source"</span>: <span class="hljs-string">"/var/lib/docker/volumes/9b2aac171a4a95e40c4d3ea2c07976c809bdc3ef90154fd78fc973db1438da60/_data"</span>,<br>            <span class="hljs-string">"Volumes"</span>: {<br><br>[root@docker01 _data]<span class="hljs-comment"># echo "web01" &gt; index.html</span><br></code></pre></td></tr></tbody></table></figure><p>数据卷持久化</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d -P  -v  /usr/share/nginx/html  nginx:latest<br> docker volume  ls<br>[root@docker01 volumes]<span class="hljs-comment"># docker  inspect  b601a86e20b2  |grep  -i volume</span><br>            <span class="hljs-string">"VolumeDriver"</span>: <span class="hljs-string">""</span>,<br>            <span class="hljs-string">"VolumesFrom"</span>: null,<br>                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"volume"</span>,<br>                <span class="hljs-string">"Source"</span>: <span class="hljs-string">"/var/lib/docker/volumes/9b2aac171a4a95e40c4d3ea2c07976c809bdc3ef90154fd78fc973db1438da60/_data"</span>,<br>            <span class="hljs-string">"Volumes"</span>: {<br><br>[root@docker01 _data]<span class="hljs-comment"># echo "web01" &gt; index.html</span><br></code></pre></td></tr></tbody></table></figure><p>docker run<br>-v  宿主机绝对目录:容器目录<br>-v  容器目录        #创建一个随机卷,来持久化容器的目录下的数据<br>-v  卷名:容器目录    #创建一个固定名字的卷,来持久化容器的目录下的数据<br>–volumes-from  跟某一个容器挂载所有相同的卷</p><p>–from-volumes 的使用：本地目录（和from的容器相同） 容器目录（和from容器相同）<br>两个都挂载在本地  那么可以修改两个站点目录的页面嘛</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">挂载相同的站点目录，数据是同步的<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 _data]<span class="hljs-comment">#  docker volume  ls 查看volume</span><br>DRIVER              VOLUME NAME<br><span class="hljs-built_in">local</span>               9b2aac171a4a95e40c4d3ea2c07976c809bdc3ef90154fd78fc973db1438da60<br>[root@docker01 _data]<span class="hljs-comment">#</span><br>[root@docker01 _data]<span class="hljs-comment">#挂载volume 并指定卷名字</span><br>[root@docker01 _data]<span class="hljs-comment"># docker  run  -d -P  -v  lsy:/usr/share/nginx/html nginx:latest</span><br>bf23f266ca805e72c1b2acced4189396d879f8f66e05fac19d360c6448f81c00<br>             新建一个容器  使用上个容器卷<br>[root@docker01 _data]<span class="hljs-comment"># docker  run  -d -P  --volumes-from bf23f266ca805  nginx:latest</span><br>ce0a6c5943e273a8fb13e0154a02b9c7581e2abf4530eec4f0b9b24cbbccd813<br>[root@docker01 _data]<span class="hljs-comment"># docker volume ls</span><br>DRIVER              VOLUME NAME<br><span class="hljs-built_in">local</span>               9b2aac171a4a95e40c4d3ea2c07976c809bdc3ef90154fd78fc973db1438da60<br><span class="hljs-built_in">local</span>               lsy<br>                                指定容器id  inspect 查看容器属性  <br>[root@docker01 _data]<span class="hljs-comment"># docker inspect  ce0a6c5943e2  |grep  -i  volume</span><br>            <span class="hljs-string">"VolumeDriver"</span>: <span class="hljs-string">""</span>,<br>            <span class="hljs-string">"VolumesFrom"</span>: [<br>                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"volume"</span>,<br>                <span class="hljs-string">"Source"</span>: <span class="hljs-string">"/var/lib/docker/volumes/lsy/_data"</span>,<br>            <span class="hljs-string">"Volumes"</span>: null,<br>[root@docker01 _data]<span class="hljs-comment"># docker inspect  bf23f266ca80  |grep  -i  volume</span><br>            <span class="hljs-string">"VolumeDriver"</span>: <span class="hljs-string">""</span>,<br>            <span class="hljs-string">"VolumesFrom"</span>: null,<br>                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"volume"</span>,<br>                <span class="hljs-string">"Source"</span>: <span class="hljs-string">"/var/lib/docker/volumes/lsy/_data"</span>,<br>            <span class="hljs-string">"Volumes"</span>: null,<br>[root@docker01 _data]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>已经启动的容器 不能挂载  只能是在启动时挂载</p><p>本地目录会覆盖 容器的目录</p><p>卷的信息放在metadata.db</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>容器管理</title>
      <link href="/2020/05/26/%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/"/>
      <url>/2020/05/26/%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p>docker  container run  等效于  docker  run</p><p>docker  run 创建并启动容器<br>-d  守护进程方式<br>-p  端口映射<br>-it   分配一个交互式终端</p><p>守护方式启动容器并指定端口映射</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run  -d  -p 80:80  nginx:latest<br></code></pre></td></tr></tbody></table></figure><p>守护方式启动容器并指定端口映射并进入</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run  -d -it -p 80:80  nginx:latest /bin/bash<br></code></pre></td></tr></tbody></table></figure><p>容器启动并进入</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  run -it  centos:6.9  /bin/bash</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@2b7c08aec561 /]<span class="hljs-comment"># uname  -r</span><br>3.10.0-957.el7.x86_64<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@2b7c08aec561 /]<span class="hljs-comment"># cat /etc/redhat-release</span><br>CentOS release 6.9 (Final)<br></code></pre></td></tr></tbody></table></figure><p>docker run  等于  docker   container  create  +  docker  start<br>创建容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  container  create  nginx:latest</span><br></code></pre></td></tr></tbody></table></figure><p>查看容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  container ls  -a</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONTAINER ID 容器ID       IMAGE使用的镜像               COMMAND  描述<br></code></pre></td></tr></tbody></table></figure><p>docker run  等于  docker   container  create  +  docker  start<br>创建容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  container  create  nginx:latest</span><br></code></pre></td></tr></tbody></table></figure><p>查看容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker  container ls  -a</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONTAINER ID 容器ID       IMAGE使用的镜像               COMMAND  描述                CREATED  时间            STATUS  状态                     PORTS  端口             NAMES 名字<br></code></pre></td></tr></tbody></table></figure><p>启动容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  start  4201aa771789<br></code></pre></td></tr></tbody></table></figure><p>查看容器列表  等效于 docker  container ls  -a<br>docker ps  -a</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run  -d  --name  lsy  nginx:lastest<br>docker   container create   --name  lsy  nginx:lastest<br></code></pre></td></tr></tbody></table></figure><p>启动容器 start</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  start  lsy<br></code></pre></td></tr></tbody></table></figure><p>停止容器 stop</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  stop  lsy<br></code></pre></td></tr></tbody></table></figure><p>重启容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  restart  lsy<br></code></pre></td></tr></tbody></table></figure><p>kill容器进程</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker container  <span class="hljs-built_in">kill</span>  lsy<br></code></pre></td></tr></tbody></table></figure><p>删除容器（非运行状态）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker container rm lsy<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker container rm  -f   lsy 运行状态时 强制删除<br></code></pre></td></tr></tbody></table></figure><p>启动容器并进入：<br><strong>问题</strong>： docker  run -d  -it --name lsy  nginx:latest  /bin/bash   进入不了容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run  -it  --name  lsy -p 80:80  nginx:latest  /bin/bash<br></code></pre></td></tr></tbody></table></figure><p><strong>原因</strong>：-d 是守护方式进行 所以不能进入  取消-d    ok</p><p>清理不是up状态的容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  container  prune<br></code></pre></td></tr></tbody></table></figure><p>清理镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image  prune  出现构建失败时使用<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker ps  -a -q<br></code></pre></td></tr></tbody></table></figure><p>ps  默认是长格式<br>-q  指定短格式</p><p><strong>批量删除容器</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  rm -f  `docker  ps -a  -q`<br></code></pre></td></tr></tbody></table></figure><p>进入正在运行的容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span>  -it<br>docker  attche<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker create  创建容器 --name<br>docker start   启动容器<br>docker  stop   停止容器<br>docker  restart 重启容器<br>docker  <span class="hljs-built_in">kill</span>   强制停止容器<br>docker  ps     查看容器列表  -a 查看所有容器<br>docker  rm     删除容器<br>批量删除所有容器 docker rm -f `docker ps -a -q`<br>docker  <span class="hljs-built_in">exec</span>   进入正在运行的容器(分配一个新终端)<br>例子: docker <span class="hljs-built_in">exec</span>  -it  容器id/容器名字   /bin/bash(/bin/sh)<br>docker attach  进入正在运行的容器(使用相同的终端),偷偷离开的快捷键ctrl +p,ctrl +q<br></code></pre></td></tr></tbody></table></figure><p>每个容器在启动时都要执行一个初始命令<br>容器在本质上就是一个进程（初始命令产生进程  初始命令必须要夯住）<br>每一个镜像默认都有一个初始命令<br>初始命令执行完  进程结束  容器死掉<br>完美解释：因为没有命令  但是为啥-d 了 还是这样：是因为nginx镜像中有守护进程，启动容器 自己就会一直运行  nginx是因为自身会产生进程</p><p>显示最后一个容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  ps  -a  -l  显示最后一个<br></code></pre></td></tr></tbody></table></figure><p>docker  -d  -it  centos:6.9  /bin/bash  这个命令是说  让centos容器夯住   作用点就是分配的交互式中端  但是我们也不进去</p><p>每一个镜像都有默认的初始命令<br>启动容器没有在镜像后面指定初始命令  那么容器就会执行镜像默认的初始化命令</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nginx -g  <span class="hljs-string">'daemon off;'</span>     nginx镜像不仅是夯住了 而且启动了服务<br></code></pre></td></tr></tbody></table></figure><p>为了保证，docker镜像小 纯净  很多命令都没有安装<br>只要是使用linux内核的操作系统  都可以叫Linux系统</p><p><strong>小技巧</strong>：查看</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">which</span>  ifconfig<br>rpm -qf  /usr/sbin/ifconfig<br></code></pre></td></tr></tbody></table></figure><p>alpine  体积小  5M  因为docker才火的</p><p>容器想要放在后台一直运行的化,那么容器的初始命令,必须夯住(前台运行),否则容器就会退出.<br>xxxxxxxxxx<br>前台运行</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">nginx -g <span class="hljs-string">'daemon off;'</span><br>/usr/sbin/php-fpm --nodaemonize<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>国内镜像加速</title>
      <link href="/2020/05/26/%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F-1/%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/"/>
      <url>/2020/05/26/%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F-1/%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/</url>
      
        <content type="html"><![CDATA[<p>docker镜像加速（新建json文件）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># cat /etc/docker/daemon.json</span><br>{<br>  <span class="hljs-string">"registry-mirrors"</span>: [<br>    <span class="hljs-string">"https://registry.docker-cn.com"</span>,<br>    <span class="hljs-string">"http://hub-mirror.c.163.com"</span>,<br>    <span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span><br>  ]<br>}<br></code></pre></td></tr></tbody></table></figure><p>重启docker</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart  docker<br></code></pre></td></tr></tbody></table></figure><p>测试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker search  httpd<br></code></pre></td></tr></tbody></table></figure><p>[root@docker01 yum.repos.d]# docker search  httpd<br>NAME  镜像名字                                  DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED<br>用户名 镜像名字</p><p>方法一：</p><p>Docker中国区官方镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://registry.docker-cn.com<br></code></pre></td></tr></tbody></table></figure><p>网易</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://hub-mirror.c.163.com<br></code></pre></td></tr></tbody></table></figure><p>ustc</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docker.mirrors.ustc.edu.cn<br></code></pre></td></tr></tbody></table></figure><p>中国科技大学</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docker.mirrors.ustc.edu.cn<br></code></pre></td></tr></tbody></table></figure><p>方法二：</p><p>阿里云容器 生成自己的加速地址</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">登录：https://cr.console.aliyun.com/<br></code></pre></td></tr></tbody></table></figure><p><img class="lazyload" data-original="%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/docker.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>加载重启docker</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo systemctl daemon-reload<br>$ sudo systemctl restart docker<br></code></pre></td></tr></tbody></table></figure><p>查看是否成功</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker info<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 volumes]<span class="hljs-comment"># docker info</span><br>Client:<br> Debug Mode: <span class="hljs-literal">false</span><br><br>Server:<br> Containers: 5<br>  Running: 5<br>  Paused: 0<br>  Stopped: 0<br> Images: 8<br> Server Version: 19.03.9<br> Storage Driver: overlay2<br>  Backing Filesystem: xfs<br>  Supports d_type: <span class="hljs-literal">true</span><br>  Native Overlay Diff: <span class="hljs-literal">true</span><br> Logging Driver: json-file<br> Cgroup Driver: cgroupfs<br> Plugins:<br>  Volume: <span class="hljs-built_in">local</span><br>  Network: bridge host ipvlan macvlan null overlay<br>  Log: awslogs fluentd gcplogs gelf journald json-file <span class="hljs-built_in">local</span> logentries splunk syslog<br> Swarm: inactive<br> Runtimes: runc<br> Default Runtime: runc<br> Init Binary: docker-init<br> containerd version: 7ad184331fa3e55e52b890ea95e65ba581ae3429<br> runc version: dc9208a3303feef5b3839f4323d9beb36df0a9dd<br> init version: fec3683<br> Security Options:<br>  seccomp<br>   Profile: default<br> Kernel Version: 3.10.0-957.el7.x86_64<br> Operating System: CentOS Linux 7 (Core)<br> OSType: linux<br> Architecture: x86_64<br> CPUs: 1<br> Total Memory: 3.578GiB<br> Name: docker01<br> ID: EATY:RGMT:DFD7:5W2F:ZOAG:YTDC:D7Z6:EQV6:BLSV:V4AU:53IB:T54A<br> Docker Root Dir: /var/lib/docker<br> Debug Mode: <span class="hljs-literal">false</span><br> Registry: https://index.docker.io/v1/<br> Labels:<br> Experimental: <span class="hljs-literal">false</span><br> Insecure Registries:<br>  127.0.0.0/8<br> Registry Mirrors:<br>  https://registry.docker-cn.com/<br>  http://hub-mirror.c.163.com/<br>  https://docker.mirrors.ustc.edu.cn/<br> Live Restore Enabled: <span class="hljs-literal">false</span><br><br>[root@docker01 volumes]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ESXI虚拟化</title>
      <link href="/2020/05/26/ESXI/"/>
      <url>/2020/05/26/ESXI/</url>
      
        <content type="html"><![CDATA[<p>ESXI  虚拟化 操作系统   商业软件  软件成本搞<br>KVM  虚拟化  软件     开源软件  软件成本低  人力成本高</p><p>Oracle  DBA<br>mysql  DBA<br>centos7  iso光盘<br>ESXI iso光盘 最低配置 2c4g 服务器<br>普通台式电脑 安装ESXI 失败  驱动不支持</p><p>==esxi是一个系统  在这个系统上跑虚拟机  类似于VMware  在VMware上装虚拟机系统  类似于这样==</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141710376.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141738403.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141746180.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141911888.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141917722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141924460.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141930548.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141936254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526141943258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br>许可证：0A65P-00HD0-3Z5M1-M097M-22P7H  激活<br>创建虚拟机</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/202005261420158.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526142026266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>注意：在虚拟机导入过程中千万不能刷新</p><p>可以使用VMware的虚拟机然后将ova文件导入 在exsi上跑虚拟机</p><p><strong>exsi手动安装虚拟机</strong><br>1、上传iso镜像</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/2020052614205092.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br>2、走安装流程</p><p><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526142106467.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526142117895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"><br><img class="lazyload" data-original="https://img-blog.csdnimg.cn/20200526142129146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUwNjU5OQ==,size_16,color_FFFFFF,t_70" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="在这里插入图片描述"></p><p>esxi 不支持克隆  虚拟机支持开机自启动<br>esxi的集群管理  vcenter 是管理esxi集群的工具  不讲解 只是自己了解</p><p>esxi可以导入ova文件</p><p><strong>把esxi上的虚拟机迁移到kvm</strong><br>目的：迁移到kvm  —&gt;省钱</p><p>1、把esxi虚拟机导出成ova文件<br>2、在kvm上  导入配置文件和磁盘文件   启动</p><p>如果esxi导出的是ovf  使用VMware把ovf转成ova<br>上传ova文件<br>下载virt-v2v文件</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y virt-v2v<br></code></pre></td></tr></tbody></table></figure><p>开始转换</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvmnode02 srv]<span class="hljs-comment"># virt-v2v  -i ova  /root/CentOS7.6.ova  -o local -os  /srv -of  qcow2</span><br></code></pre></td></tr></tbody></table></figure><p>3、导入</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">virsh  define  /srv/Centos7.6.xml<br>virsh  start centos7<br></code></pre></td></tr></tbody></table></figure><p>报错：没有网卡叫nat</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: Failed to start domain CentOS7.6<br>error: Cannot get interface MTU on <span class="hljs-string">'nat'</span>: No such device<br></code></pre></td></tr></tbody></table></figure><p>修改配置文件：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nat修改为  br0<br></code></pre></td></tr></tbody></table></figure><p>4、启动<br>启动后会没有console 的登录  需要修改配置文件去设置</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">console 控制台 登录<br>centos7的kvm虚拟机：<br>grubby --update-kernel=ALL --args=<span class="hljs-string">"console=ttyS0,115200n8"</span><br>reboot<br></code></pre></td></tr></tbody></table></figure><p>==OpenStack是一个kvm集群管理的工具，很灵活<br>OpenStack可以解决kvm的一些问题  而kvm解决虚拟化的其他问题  层层解决 。<br>OpenStack是kvm集群管理的 平台==</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ansible定义主机清单</title>
      <link href="/2020/05/26/ansible%E5%AE%9A%E4%B9%89%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95/"/>
      <url>/2020/05/26/ansible%E5%AE%9A%E4%B9%89%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95/</url>
      
        <content type="html"><![CDATA[<p><strong>主机清单文件</strong>: /etc/ansible/hosts<br>文件作用：通常用于定义要管理哪些主机的认证信息，例如ssh登录用户名，密码信息等<br><strong>定义主机组方式：</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[webservers]<br>192.168.1.31<br>192.168.1.32<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># ansible webservers -uroot -k -m ping -o</span><br>SSH password: <br>192.168.1.32 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>192.168.1.31 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br></code></pre></td></tr></tbody></table></figure><p><strong>批量定义主机</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[webservers]<br>192.168.1.[31:34]<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># ansible webservers -uroot -k -m ping -o</span><br>SSH password: <br>192.168.1.32 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>192.168.1.31 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br></code></pre></td></tr></tbody></table></figure><p><strong>内置参数:ssh端口</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[webservers]<br>192.168.1.[31:32] ansible_ssh_user=<span class="hljs-string">'root'</span> ansible_ssh_pass=<span class="hljs-string">'redhat'</span> ansible_ssh_port=<span class="hljs-string">'22'</span><br></code></pre></td></tr></tbody></table></figure><p><strong>vars变量：定义主机的内置参数</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim /etc/ansible/hosts</span><br>[webservers]<br>192.168.1.[31:32]<br>[webservers:vars]<br>ansible_ssh_user=<span class="hljs-string">'root'</span><br>ansible_ssh_pass=<span class="hljs-string">'redhat'</span><br>ansible_ssh_port=<span class="hljs-string">'22'</span><br></code></pre></td></tr></tbody></table></figure><p><strong>子组分类变量：children</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#vim /etc/ansible/hosts </span><br>[nginx]<br>192.168.1.31<br>[apache]<br>192.168.1.32<br>[webservers:children]<br>apache<br>nginx<br>[webservers:vars]<br>ansible_ssh_user=<span class="hljs-string">'root'</span><br>ansible_ssh_pass=<span class="hljs-string">'redhat'</span><br>ansible_ssh_port=<span class="hljs-string">'22'</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># ansible webservers -m ping -o</span><br>192.168.1.31 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>192.168.1.32 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>[root@localhost ~]<span class="hljs-comment"># ansible nginx -m ping -o</span><br>192.168.1.31 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>[root@localhost ~]<span class="hljs-comment"># ansible apache -m ping -o</span><br>192.168.1.32 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br></code></pre></td></tr></tbody></table></figure><p><strong>自定义主机清单文件</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># ansible -i /etc/ansible/webservices webservers -m ping -o</span><br>192.168.1.31 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br>192.168.1.32 | SUCCESS =&gt; {<span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>}<br></code></pre></td></tr></tbody></table></figure><p><strong>查看组中的主机列表</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]<span class="hljs-comment"># ansible webservers --list-host</span><br>  hosts (2):<br>    192.168.1.32<br>    192.168.1.31<br>[root@localhost ~]<span class="hljs-comment"># ansible nginx  --list-host</span><br>  hosts (1):<br>    192.168.1.31<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>docker部署以及基本镜像管理</title>
      <link href="/2020/05/26/docker%E9%83%A8%E7%BD%B2%E4%BB%A5%E5%8F%8A%E5%9F%BA%E6%9C%AC%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/"/>
      <url>/2020/05/26/docker%E9%83%A8%E7%BD%B2%E4%BB%A5%E5%8F%8A%E5%9F%BA%E6%9C%AC%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p>容器在本质上是一个进程，拥有自己的IP地址  系统文件   主机名  进程管理</p><p>程序：shell、软件、命令</p><p>进程：正在运行的程序</p><p>命令执行结束时 进程被关闭 释放内存资源</p><p><strong>容器和虚拟机的区别：</strong></p><p>虚拟机：1、模拟计算机硬件 启动时正常走启动流程；2、虚拟机有自己的内核；3、需要走开机启动流程，有自己的内核</p><p>容器：1、不需要模拟计算机硬件；2、共用宿主的内核；3、不需要走开机启动流程，共用宿主机内核</p><p>容器的优势：启动快（直接启动第一个进程 不走开机启动流程）、性能高（共用宿主机内核）、损耗少（不需要模拟计算机硬件 不损耗硬件性能）、轻量级（消耗少）</p><p><u>使用容器替代虚拟机最终目的：最终目的是降低成本</u></p><p>100台虚拟机  需要在10台宿主机上跑</p><p>100台容器    需要跑在6台宿主机上   省4台宿主机的管理费用</p><p>补充说明：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">开机启动流程：按下电源按钮，BIOS开机自检，根据BIOS的启动项选择设备来启动，选择硬盘启动，引导程序，选择操作系统，加载内核，启动第一个进程，第一个进程再启动其他进程，操作系统启动完成<br><br><br><br>BIOS启动项的顺序：从上到下<br><br><br><br>引导程序两种：引导程序放在磁盘的第一个扇区<br><br>grub<br><br>uefi：支持图形界面<br></code></pre></td></tr></tbody></table></figure><p><strong>docker发展历史</strong>：</p><p>2008年 dotcloud  paas</p><p>2013年要黄了  CEO决定开源，绝地逢生</p><p>传统docker  1.1-1.13</p><p>docker  ce 社区办 17.03  17.06  17.19  17.12   18.03  18.06  18.09   19.03</p><p>docker  ee  企业版  17</p><p><u>传统docker和docker ce不兼容 所以在安装docker ce之前要检查一下环境中有没有传统docker</u></p><p><strong>安装docker</strong></p><p>安装前检查环境中是否已经安装传统docker，以免不兼容问题</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo 下载docker源<br>sed -i s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+<span class="hljs-string">' /etc/yum.repos.d/docker-ce.repo 修改为国内地址</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install docker-ce -y<br>systemctl <span class="hljs-built_in">enable</span> docker<br>systemctl start docker<br>docker version  测试检查<br></code></pre></td></tr></tbody></table></figure><p>docker 是使用golang语言开发</p><p>原本的base源里面就有docker  但是是传统版的</p><p>docker是一个CS架构：主要镜像  容器  仓库  网络 存储  监控</p><p>docker 是一个软件的打包技术</p><p>docker容器 安装好mysql5.7  打包成镜像  发不到docker仓库</p><p>用户：下载docker镜像 mysql5.7，启动容器  启动mysql5.7</p><p>类似功能：kvm也可以做到    在虚拟机中安装mysql5.7 然后导出kvm的磁盘文件，生成虚拟机配置文件  导入启动虚拟机</p><p>pull镜像并运行容器</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d  -p 80:80  nginx:latest<br>run 创建并启动一个容器<br>-d  放后台启动<br>-p  端口映射<br>nginx:latest docker镜像名称<br></code></pre></td></tr></tbody></table></figure><p>搜索镜像（仓库地址在国外）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker search  httpd<br></code></pre></td></tr></tbody></table></figure><p><strong>配置docker镜像加速</strong></p><p>1、docker镜像加速（新建json文件）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># cat /etc/docker/daemon.json {   "registry-mirrors": [     "https://registry.docker-cn.com",     "http://hub-mirror.c.163.com",     "https://docker.mirrors.ustc.edu.cn"   ] }</span><br></code></pre></td></tr></tbody></table></figure><p>2、重启docker</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart  docker<br></code></pre></td></tr></tbody></table></figure><p>3、测试</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker search  httpd<br></code></pre></td></tr></tbody></table></figure><p>解释：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># docker search  httpd</span><br>NAME  镜像名字                                  DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED<br>用户名 镜像名字                                  描述<br></code></pre></td></tr></tbody></table></figure><p>使用镜像时的原则：优先用官方的  星数多的</p><p>下载镜像：不指定版本     默认下载最新版（Using default tag: latest）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  image  pull  httpd<br></code></pre></td></tr></tbody></table></figure><p>登录官方网站 查看镜像的版本</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://hub.docker.com/<br></code></pre></td></tr></tbody></table></figure><p>如果pull的版本不存在会报错：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Error response from daemon: manifest <span class="hljs-keyword">for</span> httpd:2.4.42 not found: manifest unknown: manifest unknown<br></code></pre></td></tr></tbody></table></figure><p>docker  pull  下载镜像</p><p>docker   push  推送镜像</p><p>查看 已有镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># docker  images REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE nginx               latest              9beeba249f3e        10 days ago         127MB httpd               2.4.43              d4e60c8eb27a        10 days ago         166MB httpd               latest              d4e60c8eb27a        10 days ago         166MB</span><br></code></pre></td></tr></tbody></table></figure><p>导出镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 yum.repos.d]<span class="hljs-comment"># docker  image save  nginx:latest -o docker_nginx.tar.gz</span><br>[root@docker01 yum.repos.d]<span class="hljs-comment"># ll</span><br>total 127572<br>-rw-r--r--  1 root root      2523 May 26 10:23 CentOS-Base.repo<br>-rw-r--r--  1 root root      2880 May 26 10:24 docker-ce.repo<br>-rw-------  1 root root 130625536 May 26 11:21docker_nginx.tar.gz`<br>drwxr-xr-x. 2 root root       187 May 26 10:23 <span class="hljs-built_in">test</span><br>[root@docker01 yum.repos.d]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>镜像是把一堆文件打成的压缩包  可以解压</p><p>导入镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker02 ~]<span class="hljs-comment"># docker image  load  -i docker_nginx.tar.gz</span><br></code></pre></td></tr></tbody></table></figure><p>docker pull拉取到本地的镜像 存放在本地路径：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/var/lib/docker/overlay2/<br></code></pre></td></tr></tbody></table></figure><p>删除镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image  rm  b7b28af77ffe  id方式  docker image rm  alpine:latest  名字方式<br></code></pre></td></tr></tbody></table></figure><p>查看镜像列表</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@docker01 ~]<span class="hljs-comment"># docker images</span><br></code></pre></td></tr></tbody></table></figure><p>docker镜像名字 类似linux硬连接</p><p>docker镜像id  类似linuxinode</p><p>镜像在容器使用时 不能删除</p><p>docker命令都进行了分组</p><p>docker image  镜像命令</p><p>docker container  容器命令</p><p>docker  volume  卷命令</p><p>docker network  网络命令</p><p><strong>[root@docker01 ~]# docker image</strong></p><p>build      构建镜像</p><p>import     导入镜像    不会导入镜像的名称和版本  不推荐</p><p>load     导入镜像 会导入镜像的名称和版本</p><p>prune  清理无效镜像</p><p>push      推送</p><p>save    导出</p><p>history   构建镜像的历史命令</p><p>inspect      镜像属性</p><p>ls       查看镜像</p><p>pull     拉取</p><p>rm        删除镜像</p><p>tag  打标签</p><p>镜像打标签</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image   tag  a7fc88580f30 <span class="hljs-built_in">test</span>:v1<br></code></pre></td></tr></tbody></table></figure><p>查看镜像属性</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image  inspect a7fc88580f30<br></code></pre></td></tr></tbody></table></figure><p>批量操作</p><p>批量导入镜像</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span>   n <span class="hljs-keyword">in</span> ls *.tar.gz;<span class="hljs-keyword">do</span> docker image  load  -i <span class="hljs-variable">$n</span> ; <span class="hljs-keyword">done</span><br></code></pre></td></tr></tbody></table></figure><p>将多个镜像打成一个包</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker image  save   nginx:latest   centos  httpd -o test.tar.gz<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>docker+ceph实现私网云盘</title>
      <link href="/2020/05/19/ceph+docker%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAowncloud%E5%AE%9E%E7%8E%B0%E7%A7%81%E7%BD%91%E4%BA%91%E7%9B%98/"/>
      <url>/2020/05/19/ceph+docker%E6%96%B9%E5%BC%8F%E6%90%AD%E5%BB%BAowncloud%E5%AE%9E%E7%8E%B0%E7%A7%81%E7%BD%91%E4%BA%91%E7%9B%98/</url>
      
        <content type="html"><![CDATA[<h3 id="ceph-docker方式搭建owncloud实现私网云盘">ceph+docker方式搭建owncloud实现私网云盘</h3><h4 id="项目背景">项目背景</h4><p>企业应用中越来越多的会使用容器技术来是实现解决方案</p><p>1、单节点的docker和docker-compose</p><p>2、多节点的docker swarm集群</p><p>3、多节点的k8s集群</p><p>以上都是可以基于容器技术实现企业应用的编排和快速部署</p><p>在特别大型的业务架构中, 数据达到T级别,P级别,甚至E级别或更高。如此大量 的数据,我们需要保证它的数据读写性能, 数据可靠性, 在线扩容等, 并且希望能 与容器技术整合使用。<br>ceph分布式存储是非常不错的开源解决方案<br>目前ceph在docker swarm集群与kubernetes集群中已经可以实现对接使用。 虽然3种类型存储并不是在任何场合都支持，但开源社区中也有相应的解决方 案，也会越来越成熟。<br>下面我们就使用ceph做底层存储, 分别在docker节点,docker swarm集 群,kubernetes集群中对接应用打造私有云盘与web应用。</p><h4 id="项目架构图">项目架构图</h4><p><img class="lazyload" data-original="C:%5CUsers%5Cmy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587473152092.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1587473152092"></p><p>PS:在架构图中写的比较全，但是在这个项目中不会全部做完，只是ceph集群加单台docker部署owncloud，实现云盘的功能，并没有docker集群的操作。</p><p>四台主机</p><p>系统版本为7.6  1810</p><p>ceph1  10.0.0.5    作为管理ceph集群的节点，它自身也在集群中</p><p>ceph2  10.0.0.6      组成ceph集群</p><p>ceph3    10.0.0.41  组成ceph集群</p><p>owncloud  10.0.0.63   docker部署owncloud</p><h4 id="部署过程">部署过程</h4><h5 id="准备过程">准备过程</h5><h6 id="1、所有节点配置静态IP地址（要求能上公网）（ceph1举例）">1、所有节点配置静态IP地址（要求能上公网）（ceph1举例）</h6><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ceph1 yum.repos.d 04:14:18]</span><span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="hljs-attr">TYPE</span>=Ethernet<br><span class="hljs-attr">PROXY_METHOD</span>=none<br><span class="hljs-attr">BROWSER_ONLY</span>=<span class="hljs-literal">no</span><br><span class="hljs-attr">BOOTPROTO</span>=static<br><span class="hljs-attr">DEFROUTE</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">IPV4_FAILURE_FATAL</span>=<span class="hljs-literal">no</span><br><span class="hljs-attr">IPV6INIT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">IPV6_AUTOCONF</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">IPV6_DEFROUTE</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">IPV6_FAILURE_FATAL</span>=<span class="hljs-literal">no</span><br><span class="hljs-attr">IPV6_ADDR_GEN_MODE</span>=stable-privacy<br><span class="hljs-attr">NAME</span>=eth0<br><span class="hljs-attr">DEVICE</span>=eth0<br><span class="hljs-attr">ONBOOT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">IPADDR</span>=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.5</span><br><span class="hljs-attr">NETMASK</span>=<span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><br><span class="hljs-attr">GATEWAY</span>=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.254</span><br><span class="hljs-attr">DNS1</span>=<span class="hljs-number">223.5</span>.<span class="hljs-number">5.5</span><br></code></pre></td></tr></tbody></table></figure><h6 id="2、所有节点主机名配置在-etc-hosts文件中">2、所有节点主机名配置在/etc/hosts文件中</h6><p>（ceph1举例）</p><figure class="highlight accesslog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@ceph1 yum.repos.d 04:14:36]</span># cat /etc/hosts<br><span class="hljs-number">127.0.0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::<span class="hljs-number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><span class="hljs-number">10.0.0.5</span> ceph1<br><span class="hljs-number">10.0.0.6</span> ceph2<br><span class="hljs-number">10.0.0.41</span> ceph3<br><span class="hljs-number">10.0.0.63</span> owncloud<br></code></pre></td></tr></tbody></table></figure><p>说明：还有没有开始部署的节点，也请先把IP地址和主机名进行绑定到/etc/hosts中</p><h6 id="3、所有节点关闭centos7的firewalld房防火墙，iptables规则清空">3、所有节点关闭centos7的firewalld房防火墙，iptables规则清空</h6><figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs clean"># systemctl stop firewalld # systemctl disable firewalld<br><br># yum install iptables-services -y # systemctl restart iptables # systemctl enable iptables<br><br># iptables -F # iptables -F -t nat # iptables -F -t mangle # iptables -F -t raw<br><br># service iptables save iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]<br></code></pre></td></tr></tbody></table></figure><h6 id="4、所有节点关闭selinux">4、所有节点关闭selinux</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 yum.repos.d 04:16:08]<span class="hljs-comment"># cat /etc/selinux/config</span><br><br><span class="hljs-comment"># This file controls the state of SELinux on the system.</span><br><br><span class="hljs-comment"># SELINUX= can take one of these three values:</span><br><br><span class="hljs-comment"># enforcing - SELinux security policy is enforced.</span><br><br><span class="hljs-comment"># permissive - SELinux prints warnings instead of enforcing.</span><br><br><span class="hljs-comment"># disabled - No SELinux policy is loaded.</span><br><br>SELINUX=disabled<br><br><span class="hljs-comment"># SELINUXTYPE= can take one of three values:</span><br><br><span class="hljs-comment"># targeted - Targeted processes are protected,</span><br><br><span class="hljs-comment"># minimum - Modification of targeted policy. Only selected processes are protected.</span><br><br><span class="hljs-comment"># mls - Multi Level Security protection.</span><br><br>SELINUXTYPE=targeted<br><br>[root@ceph1 yum.repos.d 04:18:09]<span class="hljs-comment"># getenforce</span><br>Disabled<br></code></pre></td></tr></tbody></table></figure><h6 id="5、同步时间">5、同步时间</h6><figure class="highlight vala"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># systemctl restart ntpd </span><br><span class="hljs-meta"># systemctl enabled ntpd</span><br></code></pre></td></tr></tbody></table></figure><p>PS：准备工作是在所有节点都进行操作的</p><h5 id="部署开始">部署开始</h5><h6 id="1、添加ceph的yum源">1、添加ceph的yum源</h6><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ceph1 yum.repos.d 02:40:54]</span><span class="hljs-comment"># cat ceph.repo</span><br><span class="hljs-section">[ceph]</span><br><span class="hljs-attr">name</span>=ceph<br><span class="hljs-attr">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/x<span class="hljs-number">86_64</span>/<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[ceph-noarch]</span><br><span class="hljs-attr">name</span>=cephnoarch<br><span class="hljs-attr">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/noarch/<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[ceph-source]</span><br><span class="hljs-attr">name</span>=Ceph source packages<br><span class="hljs-attr">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-mimic/el7/SRPMS/<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[root@ceph1 yum.repos.d 02:40:57]</span><span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>注释：我这里使用的清华源，也可以使用阿里源或者是搭建本地yum源（搭建本地yum源的前提是将所有的rpm下载到本地）</p><p>将此ceph.repo拷贝到其他所有节点</p><h6 id="2、配置ceph集群ssh免密">2、配置ceph集群ssh免密</h6><p>以ceph1为部署节点，在ceph1上配置到其他节点的ssh免密</p><p>目的：因为ceph集群会经常同步配置文件到其他节点，免密会方便很多</p><figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root@ceph1 ~]<span class="hljs-comment"># ssh-keygen            # 三次回车做成空密码密钥[root<span class="hljs-doctag">@ceph</span>_node1 ~]# ssh-copy-id ceph1 </span><br>[root@ceph_node1 ~]<span class="hljs-comment"># ssh-copy-id ceph2 </span><br>[root@ceph_node1 ~]<span class="hljs-comment"># ssh-copy-id ceph3 </span><br>[root@ceph_node1 ~]<span class="hljs-comment"># ssh-copy-id owncloud</span><br></code></pre></td></tr></tbody></table></figure><h6 id="3、在ceph1上安装部署工具">3、在ceph1上安装部署工具</h6><p>其他节点不需要安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y  python-setuptools.noarch  <span class="hljs-comment">#先安装一个模块</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> ceph-deploy -y  <span class="hljs-comment">#安装部署工具</span><br></code></pre></td></tr></tbody></table></figure><h6 id="4、在ceph1上创建集群">4、在ceph1上创建集群</h6><p>创建一个集群配置目录</p><p>注意：后面大部分的操作都在这个目录中操作</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /etc/ceph<br> <span class="hljs-built_in">cd</span> /etc/ceph<br></code></pre></td></tr></tbody></table></figure><p>创建一个ceph1集群</p><figure class="highlight actionscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">ceph-deploy <span class="hljs-keyword">new</span>  ceph1<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 06:41:01]<span class="hljs-comment"># ll</span><br>total 16<br>-rw-r--r-- 1 root root  191 Apr 21 02:38 ceph.conf<br>-rw-r--r-- 1 root root 2917 Apr 21 02:38 ceph-deploy-ceph.log<br>-rw------- 1 root root   73 Apr 21 02:38 ceph.mon.keyring<br>-rw-r--r-- 1 root root   92 Apr 16 12:47 rbdmap<br>[root@ceph1 ceph 06:42:02]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>说明：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">ceph.conf 集群配置文件<br><br>ceph-deploy-ceph.log  使用ceph-deploy部署的日志记录<br><br>ceph.mon.keyring   验证key文件<br></code></pre></td></tr></tbody></table></figure><h6 id="5、安装ceph软件">5、安装ceph软件</h6><p>在所有ceph集群节点安装ceph与ceph-radosgw软件包</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">06</span>:<span class="hljs-number">42</span>:<span class="hljs-number">32</span>]# ceph -v<br>ceph version <span class="hljs-number">13.2</span><span class="hljs-number">.9</span> (<span class="hljs-number">58</span>a2a9b31fd08d8bb3089fce0e312331502ff945) mimic (stable)<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">06</span>:<span class="hljs-number">42</span>:<span class="hljs-number">36</span>]#<br></code></pre></td></tr></tbody></table></figure><p>补充说明：如果网速够好的话，可以使用ceph-deploy install ceph1 ceph2 ceph3 命令来安装。ceph-deploy命令会自动通过公网官方源安装。（网速不给力就不要使用这种方式了）</p><p>在ceph客户端节点（k8s集群节点上）安装ceph-common</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yum install ceph-common -y</span><br></code></pre></td></tr></tbody></table></figure><h5 id="创建mon监控组件">创建mon监控组件</h5><p>增加监控网络，网段为实验环境的集群物理网络</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 06:50:47]<span class="hljs-comment"># cat /etc/ceph/ceph.conf</span><br>[global]<br>fsid = bb1d01eb-0d72-4794-9d7c-cb692d7a8f34<br>mon_initial_members = ceph1<br>mon_host = 10.0.0.5<br>auth_cluster_required = cephx<br>auth_service_required = cephx<br>auth_client_required = cephx<br><br>public network = 10.0.0.0/24  <span class="hljs-comment">#添加的配置，监控网络</span><br></code></pre></td></tr></tbody></table></figure><h6 id="1、集群节点初始化">1、集群节点初始化</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 06:52:13]<span class="hljs-comment"># ceph-deploy mon create-initial</span><br>[root@ceph1 ceph 06:52:05]<span class="hljs-comment"># ceph health</span><br>HEALTH_OK<br></code></pre></td></tr></tbody></table></figure><h6 id="2、将配置文件信息同步到所有的ceph集群节点">2、将配置文件信息同步到所有的ceph集群节点</h6><figure class="highlight nsis"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis">ceph-deploy <span class="hljs-literal">admin</span> ceph1 ceph2 ceph3<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>[root@ceph1 ceph 06:57:15]<span class="hljs-comment"># ceph -s</span><br>  cluster:<br>    id:     bb1d01eb-0d72-4794-9d7c-cb692d7a8f34<br>    health: HEALTH_OK<br><br>  services:<br>    mon: 1 daemons, quorum ceph1<br>    mgr: no daemons active<br>    osd: 0 osds: 0 up, 0 <span class="hljs-keyword">in</span><br><br>  data:<br>    pools:   0 pools, 0 pgs<br>    objects: 0  objects, 0 B<br>    usage:   0 B used, 0 B / 0 B avail<br>    pgs:<br><br>[root@ceph1 ceph 06:57:19]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>此时集群已经搭建好了</p><h6 id="3、多个mon节点">3、多个mon节点</h6><p>为了防止mon节点单点故障，你可以添加多个mon节点（非必要步骤）</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">ceph-deploy mon <span class="hljs-keyword">add</span><span class="bash"> ceph2</span><br>ceph-deploy mon <span class="hljs-keyword">add</span><span class="bash"> ceph3</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">06</span><span class="hljs-string">:59:11]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><span class="hljs-string">健康状态为ok</span><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span>  <span class="hljs-string">三个监控</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-literal">no</span> <span class="hljs-string">daemons</span> <span class="hljs-string">active</span><br>    <span class="hljs-attr">osd: 0 osds:</span> <span class="hljs-number">0</span> <span class="hljs-string">up,</span> <span class="hljs-number">0</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">used,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">/</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><h5 id="监控到时间不同不的解决方法">监控到时间不同不的解决方法</h5><p>ceph集群对时间同步的要求非常高，即使你已经将ntpd服务开启，但仍然有可能会有clock skew deteted相关警告</p><p>可以尝试如下做法：</p><h6 id="1、在ceph集群节点上使用crontab同步">1、在ceph集群节点上使用crontab同步</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># systemctl stop ntpd # systemctl disable ntpd</span><br><br><span class="hljs-comment"># crontab -e */10 * * * * ntpdate ntp1.aliyun.com                每5或10 分钟同步1次公网的任意时间服务器</span><br></code></pre></td></tr></tbody></table></figure><h6 id="2、调大时间警告的阈值">2、调大时间警告的阈值</h6><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph_node1 ceph]# vim ceph.conf <br>[global]                                在global参数组里添加 以下两行                       <span class="hljs-built_in">..</span><span class="hljs-built_in">..</span><span class="hljs-built_in">..</span> <br>mon<span class="hljs-built_in"> clock </span>drift allowed = 2             # monitor间的时钟滴 答数(默认0.5秒) <br>mon<span class="hljs-built_in"> clock </span>drift warn backoff = 30       # 调大时钟允许的偏移量 (默认为5)<br></code></pre></td></tr></tbody></table></figure><h6 id="3、同步到所有节点">3、同步到所有节点</h6><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph_node1 ceph]<span class="hljs-comment"># ceph-deploy --overwrite-conf admin ceph_node1 ceph_node2 ceph_node3</span><br><br>前面第1次同步不需要加--overwrite-conf参数 这次修改ceph.conf再同步就需要加--overwrite-conf参数覆盖<br></code></pre></td></tr></tbody></table></figure><h6 id="4、所有ceph集群节点上重启ceph-mon-target服务">4、所有ceph集群节点上重启ceph-mon.target服务</h6><figure class="highlight aspectj"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">systemctl  restart  ceph-mon.<span class="hljs-keyword">target</span><br></code></pre></td></tr></tbody></table></figure><h5 id="创建mgr管理组件">创建mgr管理组件</h5><p>ceph luminous版本之后新增加了一个组件：ceph  manager daemon ，简称ceph-mgr</p><p>该组件的主要作用是分担和扩展monitor的部分功能，减轻monitor的负担，让更好的管理ceph存储系统</p><p>ceph dashboard图形化管理就用到了mgr</p><h6 id="1、创建一个mgr">1、创建一个mgr</h6><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">07</span>:<span class="hljs-number">11</span>:<span class="hljs-number">17</span>]# ceph-deploy mgr  create ceph1<br></code></pre></td></tr></tbody></table></figure><p>查看一下</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">07</span><span class="hljs-string">:11:32]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active)</span> <span class="hljs-string">这里就是mgr</span> <br>    <span class="hljs-attr">osd: 0 osds:</span> <span class="hljs-number">0</span> <span class="hljs-string">up,</span> <span class="hljs-number">0</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">used,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">/</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><h6 id="2、添加多个mgr可以实现HA">2、添加多个mgr可以实现HA</h6><figure class="highlight gauss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss">ceph-deploy mgr  <span class="hljs-keyword">create</span> ceph2<br>ceph-deploy mgr  <span class="hljs-keyword">create</span> ceph3<br></code></pre></td></tr></tbody></table></figure><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 07:13:12]<span class="hljs-comment"># ceph -s</span><br>  cluster:<br>    id:     bb1d01eb-0d72-4794-9d7c-cb692d7a8f34<br>    health: HEALTH_WARN<br>            OSD count 0 &lt; osd_pool_default_size 3<br><br>  services:<br>    mon: 3 daemons, quorum ceph1,ceph2,ceph3  三个监控<br>    mgr: ceph1(active), standbys: ceph2, ceph3    ceph1为主mgr<br>    osd: 0 osds: 0 up, 0 <span class="hljs-keyword">in</span><br>看到0个磁盘<br>  data:<br>    pools:   0 pools, 0 pgs<br>    objects: 0  objects, 0 B<br>    usage:   0 B used, 0 B / 0 B avail<br>    pgs:<br><br>[root@ceph1 ceph 07:13:19]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>至此ceph集群基本已经搭建完成，但是还需要增加OSD磁盘</p><h5 id="ceph集群管理">ceph集群管理</h5><h6 id="1、物理上添加磁盘">1、物理上添加磁盘</h6><p>在ceph集群所有节点上增加磁盘</p><p>（我这里只是模拟，就增加一个5G的做测试使用)</p><p><img class="lazyload" data-original="C:%5CUsers%5Cmy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587468133938.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1587468133938"></p><p>ceph1 ceph2 ceph3 三个节点上都要进行操作</p><p>不重启让系统识别新增加的磁盘</p><p>操作之前</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 07:13:19]<span class="hljs-comment"># lsblk</span><br>NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sda               8:0    0   50G  0 disk<br>├─sda1            8:1    0    1G  0 part /boot<br>└─sda2            8:2    0   49G  0 part<br>  ├─centos-swap 253:0    0    2G  0 lvm  [SWAP]<br>  └─centos-root 253:1    0   47G  0 lvm  /<br>sr0              11:0    1  4.3G  0 rom<br>[root@ceph1 ceph 07:24:28]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><p>操作之中</p><figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">07</span>:<span class="hljs-number">24</span>:<span class="hljs-number">28</span>]# echo <span class="hljs-string">"- - -"</span> &gt; /sys/<span class="hljs-class"><span class="hljs-keyword">class</span>/<span class="hljs-title">scsi_host</span>/<span class="hljs-title">host0</span>/<span class="hljs-title">scan</span></span><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">07</span>:<span class="hljs-number">26</span>:<span class="hljs-number">01</span>]# echo <span class="hljs-string">"- - -"</span> &gt; /sys/<span class="hljs-class"><span class="hljs-keyword">class</span>/<span class="hljs-title">scsi_host</span>/<span class="hljs-title">host1</span>/<span class="hljs-title">scan</span></span><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">07</span>:<span class="hljs-number">26</span>:<span class="hljs-number">08</span>]# echo <span class="hljs-string">"- - -"</span> &gt; /sys/<span class="hljs-class"><span class="hljs-keyword">class</span>/<span class="hljs-title">scsi_host</span>/<span class="hljs-title">host2</span>/<span class="hljs-title">scan</span></span><br></code></pre></td></tr></tbody></table></figure><p>操作之后</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ceph1 ceph 07:26:12]<span class="hljs-comment"># lsblk</span><br>NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sda               8:0    0   50G  0 disk<br>├─sda1            8:1    0    1G  0 part /boot<br>└─sda2            8:2    0   49G  0 part<br>  ├─centos-swap 253:0    0    2G  0 lvm  [SWAP]<br>  └─centos-root 253:1    0   47G  0 lvm  /<br>sdb       这里就是我们新加的        8:16   0    5G  0 disk<br>sr0              11:0    1  4.3G  0 rom<br>[root@ceph1 ceph 07:26:36]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><h6 id="2、创建OSD磁盘">2、创建OSD磁盘</h6><p>将磁盘添加到ceph集群中需要osd</p><p>ceph OSD ：功能是存储于处理一些数据，并通过检查其他OSD守护进程的心跳来向ceph monitors 提供一些监控信息</p><p>1、列表所有节点的磁盘 并使用zap命令清除磁盘信息准备创建OSD</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"> ceph-deploy disk zap ceph1 <span class="hljs-regexp">/dev/</span>sdb<br>ceph-deploy disk zap ceph2 <span class="hljs-regexp">/dev/</span>sdb<br>ceph-deploy disk zap ceph3 <span class="hljs-regexp">/dev/</span>sdb<br></code></pre></td></tr></tbody></table></figure><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ceph1 ceph 07:32:01]# ceph-deploy disk zap ceph3 /dev/sdb<br>[<span class="hljs-string">ceph_deploy.conf</span>][<span class="hljs-symbol">DEBUG </span>] found configuration file at: /root/.cephdeploy.conf<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>] Invoked (2.0.1): /usr/bin/ceph-deploy disk zap ceph3 /dev/sdb<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>] ceph-deploy options:<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  username                      : None<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  verbose                       : False<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  debug                         : False<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  overwrite_conf                : False<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  subcommand                    : zap<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  quiet                         : False<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  cd<span class="hljs-emphasis">_conf                       : &lt;ceph_</span>deploy.conf.cephdeploy.Conf instance at 0x7feb12eb0368&gt;<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  cluster                       : ceph<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  host                          : ceph3<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  func                          : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">function</span> <span class="hljs-attr">disk</span> <span class="hljs-attr">at</span> <span class="hljs-attr">0x7feb12eec8c0</span>&gt;</span></span><br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  ceph_conf                     : None<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  default_release               : False<br>[<span class="hljs-string">ceph_deploy.cli</span>][<span class="hljs-symbol">INFO </span>]  disk                          : ['/dev/sdb']<br>[<span class="hljs-string">ceph_deploy.osd</span>][<span class="hljs-symbol">DEBUG </span>] zapping /dev/sdb on ceph3<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] connected to host: ceph3<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] detect platform information from remote host<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] detect machine type<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] find the location of an executable<br>[<span class="hljs-string">ceph_deploy.osd</span>][<span class="hljs-symbol">INFO </span>] Distro info: CentOS Linux 7.6.1810 Core<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] zeroing last few blocks of device<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">DEBUG </span>] find the location of an executable<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">INFO </span>] Running command: /usr/sbin/ceph-volume lvm zap /dev/sdb<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">WARNIN</span>] --&gt; Zapping: /dev/sdb<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">WARNIN</span>] --&gt; --destroy was not specified, but zapping a whole device will remove the partition table<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">WARNIN</span>] Running command: /bin/dd if=/dev/zero of=/dev/sdb bs=1M count=10 conv=fsync<br>[<span class="hljs-string">ceph3</span>][<span class="hljs-symbol">WARNIN</span>] --&gt; Zapping successful for: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Raw</span> <span class="hljs-attr">Device:</span> /<span class="hljs-attr">dev</span>/<span class="hljs-attr">sdb</span>&gt;</span></span><br></code></pre></td></tr></tbody></table></figure><p>2、创建OSD磁盘</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">ceph-deploy osd create <span class="hljs-params">--data</span> <span class="hljs-string">/dev/sdb</span> ceph1<br>ceph-deploy osd create <span class="hljs-params">--data</span> <span class="hljs-string">/dev/sdb</span> ceph2<br>ceph-deploy osd create <span class="hljs-params">--data</span> <span class="hljs-string">/dev/sdb</span> ceph3<br></code></pre></td></tr></tbody></table></figure><p>3、验证</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">07</span><span class="hljs-string">:34:31]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">osd: 3 osds:</span> <span class="hljs-number">3</span> <span class="hljs-string">up,</span> <span class="hljs-number">3</span> <span class="hljs-string">in</span><br><span class="hljs-string">三个磁盘</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">3.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">12</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">15</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span>  <span class="hljs-string">合成一个15G的磁盘，但是使用了3G</span> <span class="hljs-string">是因为合成时会用掉一些空间</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><h5 id="扩容操作">扩容操作</h5><h6 id="节点中增加某个磁盘">节点中增加某个磁盘</h6><p>如：在ceph3上再添加一块磁盘/dev/sdc。做如下操作就可以</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">ceph-deploy disk zap ceph3 <span class="hljs-string">/dev/sdc</span><br>ceph-deploy osd create <span class="hljs-params">--data</span> <span class="hljs-string">/dev/sdc</span> ceph3<br></code></pre></td></tr></tbody></table></figure><p>验证</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">08</span><span class="hljs-string">:10:41]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">osd: 4 osds:</span> <span class="hljs-number">4</span> <span class="hljs-string">up,</span> <span class="hljs-number">4</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">4.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">16</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">20</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><h6 id="增加某个节点并添加此节点的磁盘">增加某个节点并添加此节点的磁盘</h6><p>如果是新增加一个节点（假设是owncloud节点）并添加一块磁盘</p><p>那么做法如下：</p><p>1、准备好owncloud节点的基本环境，安装ceph相关软件</p><figure class="highlight gml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gml">yum install -<span class="hljs-symbol">y</span>  ceph  ceph-radosgw -<span class="hljs-symbol">y</span><br></code></pre></td></tr></tbody></table></figure><p>2、在ceph1上同步1配置到owncloud节点</p><figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ceph-deploy admin  owncloud</span><br></code></pre></td></tr></tbody></table></figure><p>3、将owncloud加入集群</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">ceph-deploy disk  zap  owncloud <span class="hljs-string">/dev/sdb</span><br>ceph-deploy osd create <span class="hljs-params">--data</span>   <span class="hljs-string">/dev/sdb</span>  owncloud<br></code></pre></td></tr></tbody></table></figure><p>4、验证</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">08</span><span class="hljs-string">:15:44]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">osd: 5 osds:</span> <span class="hljs-number">5</span> <span class="hljs-string">up,</span> <span class="hljs-number">5</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">5.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">20</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">25</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br><br><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">08</span><span class="hljs-string">:15:48]#</span><br></code></pre></td></tr></tbody></table></figure><h6 id="删除磁盘方法">删除磁盘方法</h6><p>和很多存储一样，增加磁盘（扩容）都比较方便，但是要删除磁盘会比较麻烦。</p><p>这里以删除owncloud节点的/dev/sdb磁盘为例</p><p>1、查看osd磁盘状态</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>]# ceph  osd  tree<br>ID CLASS WEIGHT  TYPE NAME         STATUS REWEIGHT PRI-AFF<br><span class="hljs-number">-1</span>       <span class="hljs-number">0.02449</span> root <span class="hljs-keyword">default</span><br><span class="hljs-number">-3</span>       <span class="hljs-number">0.00490</span>     host ceph1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.0</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-5</span>       <span class="hljs-number">0.00490</span>     host ceph2<br> <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.1</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-7</span>       <span class="hljs-number">0.00980</span>     host ceph3<br> <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.2</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.3</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-9</span>       <span class="hljs-number">0.00490</span>     host owncloud<br> <span class="hljs-number">4</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.4</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br></code></pre></td></tr></tbody></table></figure><p>2、先标记为out</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">23</span>:<span class="hljs-number">56</span>]# ceph osd <span class="hljs-keyword">out</span> osd<span class="hljs-number">.4</span><br>marked <span class="hljs-keyword">out</span> osd<span class="hljs-number">.4</span>.<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">46</span>]# ceph  osd  tree<br>ID CLASS WEIGHT  TYPE NAME         STATUS REWEIGHT PRI-AFF<br><span class="hljs-number">-1</span>       <span class="hljs-number">0.02449</span> root <span class="hljs-keyword">default</span><br><span class="hljs-number">-3</span>       <span class="hljs-number">0.00490</span>     host ceph1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.0</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-5</span>       <span class="hljs-number">0.00490</span>     host ceph2<br> <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.1</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-7</span>       <span class="hljs-number">0.00980</span>     host ceph3<br> <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.2</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.3</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-9</span>       <span class="hljs-number">0.00490</span>     host owncloud<br> <span class="hljs-number">4</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.4</span>         up        <span class="hljs-number">0</span> <span class="hljs-number">1.00000</span><br> 可以看到权重为<span class="hljs-number">0</span>但是状态还是up<br></code></pre></td></tr></tbody></table></figure><p>3、再rm删除，但是要先去osd.4对应的节点上停止ceph-osd服务，否则删除不了</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">27</span>:<span class="hljs-number">35</span>]# systemctl stop  ceph-<span class="hljs-symbol">osd@</span><span class="hljs-number">4.</span>service<br></code></pre></td></tr></tbody></table></figure><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">28</span>:<span class="hljs-number">09</span>]# ceph osd rm osd<span class="hljs-number">.4</span><br><br>removed osd<span class="hljs-number">.4</span><br></code></pre></td></tr></tbody></table></figure><p>4、查看集群状态</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">08</span><span class="hljs-string">:28:18]#</span><br><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">08</span><span class="hljs-string">:28:18]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_WARN</span> <span class="hljs-string">会有警告，是因为没有在crush算法中删除</span><br>            <span class="hljs-number">1</span> <span class="hljs-string">osds</span> <span class="hljs-string">exist</span> <span class="hljs-string">in</span> <span class="hljs-string">the</span> <span class="hljs-string">crush</span> <span class="hljs-string">map</span> <span class="hljs-string">but</span> <span class="hljs-string">not</span> <span class="hljs-string">in</span> <span class="hljs-string">the</span> <span class="hljs-string">osdmap</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span> <br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">osd: 4 osds:</span> <span class="hljs-number">4</span> <span class="hljs-string">up,</span> <span class="hljs-number">4</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">4.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">16</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">20</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><p>此时再查看，发现osd.4已经没有up了</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">28</span>:<span class="hljs-number">22</span>]# ceph osd  tree<br>ID CLASS WEIGHT  TYPE NAME         STATUS REWEIGHT PRI-AFF<br><span class="hljs-number">-1</span>       <span class="hljs-number">0.02449</span> root <span class="hljs-keyword">default</span><br><span class="hljs-number">-3</span>       <span class="hljs-number">0.00490</span>     host ceph1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.0</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-5</span>       <span class="hljs-number">0.00490</span>     host ceph2<br> <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.1</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-7</span>       <span class="hljs-number">0.00980</span>     host ceph3<br> <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.2</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.3</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-9</span>       <span class="hljs-number">0.00490</span>     host owncloud<br> <span class="hljs-number">4</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.4</span>        DNE        <span class="hljs-number">0</span><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">29</span>:<span class="hljs-number">23</span>]#<br></code></pre></td></tr></tbody></table></figure><p>5、在crush算法中和auth验证中删除</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">32</span>:<span class="hljs-number">29</span>]# ceph osd crush remove osd<span class="hljs-number">.4</span><br>removed item id <span class="hljs-number">4</span> name <span class="hljs-string">'osd.4'</span> <span class="hljs-keyword">from</span> crush map<br>[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">32</span>:<span class="hljs-number">43</span>]# ceph auth del osd<span class="hljs-number">.4</span><br>updated<br></code></pre></td></tr></tbody></table></figure><p>6、还需要在osd.4对应的节点上卸载磁盘</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">33</span>:<span class="hljs-number">04</span>]# df -Th |grep  osd<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M   <span class="hljs-number">52</span>K  <span class="hljs-number">487</span>M   <span class="hljs-number">1</span>% /var/lib/ceph/osd/ceph<span class="hljs-number">-4</span><br><br>[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">33</span>:<span class="hljs-number">30</span>]# umount /var/lib/ceph/osd/ceph<span class="hljs-number">-4</span>/<br>[<span class="hljs-symbol">root@</span>owncloud yum.repos.d <span class="hljs-number">08</span>:<span class="hljs-number">33</span>:<span class="hljs-number">50</span>]# df -Th<br>Filesystem              Type      Size  Used Avail Use% Mounted on<br>/dev/mapper/centos-root xfs        <span class="hljs-number">47</span>G  <span class="hljs-number">1.6</span>G   <span class="hljs-number">46</span>G   <span class="hljs-number">4</span>% /<br>devtmpfs                devtmpfs  <span class="hljs-number">475</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">475</span>M   <span class="hljs-number">0</span>% /dev<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">487</span>M   <span class="hljs-number">0</span>% /dev/shm<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M   <span class="hljs-number">14</span>M  <span class="hljs-number">473</span>M   <span class="hljs-number">3</span>% /run<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">487</span>M   <span class="hljs-number">0</span>% /sys/fs/cgroup<br>/dev/sda1               xfs      <span class="hljs-number">1014</span>M  <span class="hljs-number">133</span>M  <span class="hljs-number">882</span>M  <span class="hljs-number">14</span>% /boot<br>tmpfs                   tmpfs      <span class="hljs-number">98</span>M     <span class="hljs-number">0</span>   <span class="hljs-number">98</span>M   <span class="hljs-number">0</span>% /run/user/<span class="hljs-number">0</span><br></code></pre></td></tr></tbody></table></figure><p>在ceph1节点查看验证</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">08</span>:<span class="hljs-number">29</span>:<span class="hljs-number">23</span>]# ceph osd  tree<br>ID CLASS WEIGHT  TYPE NAME         STATUS REWEIGHT PRI-AFF<br><span class="hljs-number">-1</span>       <span class="hljs-number">0.01959</span> root <span class="hljs-keyword">default</span><br><span class="hljs-number">-3</span>       <span class="hljs-number">0.00490</span>     host ceph1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.0</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-5</span>       <span class="hljs-number">0.00490</span>     host ceph2<br> <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.1</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-7</span>       <span class="hljs-number">0.00980</span>     host ceph3<br> <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.2</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00490</span>         osd<span class="hljs-number">.3</span>         up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-9</span>             <span class="hljs-number">0</span>     host owncloud<br></code></pre></td></tr></tbody></table></figure><p>到这里，就完全删除了。</p><p>如果想要加回来，再次部署在节点上即可</p><p>如下命令</p><figure class="highlight autoit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@ceph1</span> ceph]<span class="hljs-meta"># ceph-deploy disk zap ceph1 /dev/sdb </span><br>[root<span class="hljs-symbol">@ceph1</span> ceph]<span class="hljs-meta"># ceph-deploy osd create --data /dev/sdb ceph1</span><br></code></pre></td></tr></tbody></table></figure><h5 id="小结与说明">小结与说明</h5><p>ceph集群安装要注意：</p><p>1、ceph-deploy命令默认找官方yum源，国内网速非常慢（而且ceph安装时设置了300秒超时，也就是你安装5分钟内不安装完就会断开）</p><p>2、建议使用国内镜像源（我使用的清华源），如果网速还是慢，就做好本地yum源。</p><p>3、ceph集群节点需要安装ceph与ceph-radosgw软件包，客户端节点只需要安装ceph-common软件包</p><p>4、ceph集群对时间同步很敏感，请一定保证没有时间不同的相关警告</p><p>ceph集群操作注意：</p><p>任何操作一定要保证集群健康的情况下操作，并使用ceph -s命令进行确认</p><p>修改配置文件请在部署节点上修改，然后使用</p><p>ceph-deploy --overwriteconf admin ceph1 ceph2 ceph3命令同步到其它节点</p><h5 id="ceph的存储类型">ceph的存储类型</h5><h6 id="三种存储类型介绍">三种存储类型介绍</h6><p><img class="lazyload" data-original="C:%5CUsers%5Cmy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587473493263.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1587473493263"></p><p>无论用那种存储，都可以分为以下三种类型</p><p>文件存储：类似于一个大的目录，多个客户端可以挂载过来</p><p>优点：利于数据共享</p><p>缺点：速度较慢</p><p>块存储：类似于一个block的设备，客户端可以格式化，挂载并使用，和用一个硬盘一样</p><p>优点：和本地硬盘一样直接使用</p><p>缺点：数据不同享</p><p>对象存储：看做一个综合了文件存储和块存储优点的大硬盘，可以挂载也可以通过URL来访问</p><p>优点：速度快，数据共享</p><p>缺点：成本高，不兼容现有的模式</p><p><img class="lazyload" data-original="C:%5CUsers%5Cmy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587473700624.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1587473700624"></p><p>RADOS;ceph的高可靠，高可扩展、高性能、高自动化都是由这一层来提供的，用户数据的存储最终也是通过这一层来进行存储的</p><p>可以说RADOS就是ceph底层的原生态的数据引擎，但是实际应用时却不直接使用它，而是分为以下4种方式来使用：</p><p>LIBRADOS是一个库, 它允许应用程序通过访问该库来与RADOS系统进行交 互，支持多种编程语言。如Python,C,C++等. 简单来说,就是给开发人员使 用的接口。</p><p>CEPH FS通过Linux内核客户端和FUSE来提供文件系统。(文件存储)</p><p>RBD通过Linux内核客户端和QEMU/KVM驱动来提供一个分布式的块设 备。(块存储)</p><p>RADOSGW是一套基于当前流行的RESTFUL协议的网关，并且兼容S3和 Swift。(对象存储)</p><h6 id="存储原理">存储原理</h6><p>要实现数据存取需要建一个pool,创建pool要分配PG。</p><p><img class="lazyload" data-original="C:%5CUsers%5Cmy%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587473929074.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="1587473929074"></p><p>如果客户端对一个pool写了一个文件，那么这个文件是如何分布到多个节点的磁盘上呢？</p><p>答案是通过crush算法</p><h6 id="CRUSH算法">CRUSH算法</h6><p>CRUSH(Controlled Scalable Decentralized Placement of Replicated Data)算法为可控的,可扩展的,分布式的副本数据放置算法的简称。 PG到OSD的映射的过程算法叫做CRUSH 算法。(一个Object需要保存三个 副本，也就是需要保存在三个osd上)。</p><p>CRUSH算法是一个伪随机的过程，他可以从所有的OSD中，随机性选择一 个OSD集合，但是同一个PG每次随机选择的结果是不变的，也就是映射的 OSD集合是固定的。</p><h5 id="小结：">小结：</h5><p>1、客户端直接对pool操作(但文件存储、块存储、对象存储区我们不这么做)</p><p>2、pool里面要分配PG</p><p>3、PG里面可以存放多个对象</p><p>4、对象就是客户端写入的数据分离单位</p><p>5、crush算法将客户端写入的数据映射分布到OSD，从而最终存放到物理磁盘上。</p><h5 id="RADOS原生数据存取">RADOS原生数据存取</h5><h6 id="1、创建pool并测试">1、创建pool并测试</h6><p>创建test_pool 指定pg数为128</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 09:03:17]# ceph osd<span class="hljs-built_in"> pool </span>create test_pool 128<br>pool <span class="hljs-string">'test_pool'</span> created<br></code></pre></td></tr></tbody></table></figure><p>修改pg数量，可以使用修改调整</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ceph osd<span class="hljs-built_in"> pool </span><span class="hljs-builtin-name">set</span> test_pool  pg_num 64<br></code></pre></td></tr></tbody></table></figure><p>查看数量</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>]# ceph osd pool  <span class="hljs-keyword">get</span> test_pool pg_num<br>pg_num: <span class="hljs-number">128</span><br>[root@ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">03</span>:<span class="hljs-number">46</span>]#<br></code></pre></td></tr></tbody></table></figure><p>说明：pg数与osd数量关系</p><p>pg数为2的倍数，一般为5个一下osd,分为128个PG或者一下即可</p><p>可以使用ceph  osd  pool set test_pool pg_num 64 这样的命令来尝试调整。</p><h6 id="2、存储测试">2、存储测试</h6><p>1、我这里把本机的/etc/fstab文件上传到test_pool并取名为netfatab</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">11</span>:<span class="hljs-number">12</span>]# rados put newfatab /etc/fstab  --pool=test_pool<br></code></pre></td></tr></tbody></table></figure><p>2、查看</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">11</span>:<span class="hljs-number">19</span>]# rados -p test_pool ls<br>newfatab<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">11</span>:<span class="hljs-number">47</span>]#<br></code></pre></td></tr></tbody></table></figure><p>3、删除并查看</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">12</span>:<span class="hljs-number">45</span>]# rados rm newfatab --pool=test_pool<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">13</span>:<span class="hljs-number">16</span>]# rados -p test_pool ls<br></code></pre></td></tr></tbody></table></figure><h6 id="3、删除pool">3、删除pool</h6><p>1、在部署节点ceph1上增加参数允许ceph删除pool</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">15</span>:<span class="hljs-number">29</span>]# cat ceph.conf<br>[global]<br>fsid = bb1d01eb<span class="hljs-number">-0</span>d72<span class="hljs-number">-4794</span><span class="hljs-number">-9</span>d7c-cb692d7a8f34<br>mon_initial_members = ceph1<br>mon_host = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.5</span><br>auth_cluster_required = cephx<br>auth_service_required = cephx<br>auth_client_required = cephx<br><br><span class="hljs-keyword">public</span> network = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><br>mon_allow_pool_delete = <span class="hljs-literal">true</span><br>增加最后一条信息<br></code></pre></td></tr></tbody></table></figure><p>2、修改了配置，要同步到其他集群节点</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span>]# ceph-deploy --overwrite-conf admin ceph1 ceph2 ceph3<br></code></pre></td></tr></tbody></table></figure><p>3、重启监控服务</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">17</span>:<span class="hljs-number">42</span>]# systemctl restart  ceph-mon.target<br></code></pre></td></tr></tbody></table></figure><p>4、删除pool名输入两次，后接–yes-i-really-really-mean-it参数就可以删 除了</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 09:17:52]# ceph osd<span class="hljs-built_in"> pool </span>delete test_pool test_pool --yes-i-really-really-mean-it<br>pool <span class="hljs-string">'test_pool'</span> removed<br>[root@ceph1 ceph 09:19:23]#<br></code></pre></td></tr></tbody></table></figure><h5 id="创建ceph文件存储">创建ceph文件存储</h5><p>要运行ceph文件系统，你必须先创建至少一个带mds的ceph存储集群</p><p>（ceph块设备和ceph对象存储都不使用MDS）</p><p>ceph MDS为ceph文件存储类型存放元数据metadata</p><p>1、在ceph1节点部署上同步配置文件，并创建MDS（也可以做多个mds实现HA）</p><figure class="highlight gauss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">ceph-deploy mds  <span class="hljs-keyword">create</span> ceph1 ceph2 ceph3<br></code></pre></td></tr></tbody></table></figure><p>2、一个ceph文件系统需要至少两个RADOS存储池，一个用于数据，一个用于元数据。所以我们创建他们</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 09:24:47]# ceph osd <span class="hljs-built_in"> pool </span>create cephfs_pool 128<br>pool <span class="hljs-string">'cephfs_pool'</span> created<br><br>[root@ceph1 ceph 09:25:06]# ceph osd<span class="hljs-built_in"> pool </span>create cephfs_metadata 64<br>pool <span class="hljs-string">'cephfs_metadata'</span> created<br><br>[root@ceph1 ceph 09:25:27]# ceph osd<span class="hljs-built_in"> pool </span>ls |grep  cephfs<br>cephfs_pool<br>cephfs_metadata<br></code></pre></td></tr></tbody></table></figure><p>3、创建ceph文件系统并确认客户端访问的节点</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">26</span>:<span class="hljs-number">38</span>]# ceph fs new cephfs cephfs_metadata cephfs_pool<br>new fs with metadata pool <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> data pool <span class="hljs-number">2</span><br><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">26</span>:<span class="hljs-number">59</span>]# ceph fs ls<br>name: cephfs, metadata pool: cephfs_metadata, data pools: [cephfs_pool ]<br><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">27</span>:<span class="hljs-number">09</span>]# ceph mds stat<br>cephfs<span class="hljs-number">-1</span>/<span class="hljs-number">1</span>/<span class="hljs-number">1</span> up  {<span class="hljs-number">0</span>=ceph3=up:active}, <span class="hljs-number">2</span> up:standby<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">09</span>:<span class="hljs-number">27</span>:<span class="hljs-number">17</span>]#<br></code></pre></td></tr></tbody></table></figure><p>4、客户端准备key验证文件</p><p>说明：ceph默认启用了cephx认证，所以客户端的挂载必须要认证</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>lsy ~ <span class="hljs-number">09</span>:<span class="hljs-number">52</span>:<span class="hljs-number">52</span>]# mount -t ceph  <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.5</span>:<span class="hljs-number">6789</span>:/ /mnt -o name=admin,secret=AQBQ0J5eLDHnLRAAf850/HEvbZd3DAvWE8czrA==<br>[<span class="hljs-symbol">root@</span>lsy ~ <span class="hljs-number">09</span>:<span class="hljs-number">54</span>:<span class="hljs-number">04</span>]# df -Th<br>Filesystem              Type      Size  Used Avail Use% Mounted on<br>/dev/mapper/centos-root xfs        <span class="hljs-number">47</span>G  <span class="hljs-number">3.6</span>G   <span class="hljs-number">44</span>G   <span class="hljs-number">8</span>% /<br>devtmpfs                devtmpfs  <span class="hljs-number">475</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">475</span>M   <span class="hljs-number">0</span>% /dev<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">487</span>M   <span class="hljs-number">0</span>% /dev/shm<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M   <span class="hljs-number">14</span>M  <span class="hljs-number">473</span>M   <span class="hljs-number">3</span>% /run<br>tmpfs                   tmpfs     <span class="hljs-number">487</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">487</span>M   <span class="hljs-number">0</span>% /sys/fs/cgroup<br>/dev/sda1               xfs      <span class="hljs-number">1014</span>M  <span class="hljs-number">133</span>M  <span class="hljs-number">882</span>M  <span class="hljs-number">14</span>% /boot<br>tmpfs                   tmpfs      <span class="hljs-number">98</span>M     <span class="hljs-number">0</span>   <span class="hljs-number">98</span>M   <span class="hljs-number">0</span>% /run/user/<span class="hljs-number">0</span><br><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.5</span>:<span class="hljs-number">6789</span>:/         ceph      <span class="hljs-number">5.0</span>G     <span class="hljs-number">0</span>  <span class="hljs-number">5.0</span>G   <span class="hljs-number">0</span>% /mnt<br>[<span class="hljs-symbol">root@</span>lsy ~ <span class="hljs-number">09</span>:<span class="hljs-number">54</span>:<span class="hljs-number">13</span>]#<br></code></pre></td></tr></tbody></table></figure><p>这样的方式可以</p><p>但是使用文件密钥的方式我就实现不出来。</p><figure class="highlight n1ql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">[root@lsy ~ 10:<span class="hljs-number">05</span>:<span class="hljs-number">42</span>]# mount -t ceph ceph1:<span class="hljs-number">6789</span>:/   /mnt -o name=admin,secretfile=/root/admin.<span class="hljs-keyword">key</span><br>mount: wrong fs <span class="hljs-built_in">type</span>, bad <span class="hljs-keyword">option</span>, bad superblock <span class="hljs-keyword">on</span> ceph1:<span class="hljs-number">6789</span>:/,<br>       <span class="hljs-literal">missing</span> codepage <span class="hljs-keyword">or</span> helper program, <span class="hljs-keyword">or</span> other error<br><br>   <span class="hljs-keyword">In</span> <span class="hljs-keyword">some</span> cases useful info <span class="hljs-keyword">is</span> found <span class="hljs-keyword">in</span> syslog - try<br>   dmesg | tail <span class="hljs-keyword">or</span> so.<br></code></pre></td></tr></tbody></table></figure><p>几种方式的总结：见博客</p><p><a href="https://blog.csdn.net/weixin_42506599/article/details/105669234" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42506599/article/details/105669234</a></p><h5 id="删除文件存储方法">删除文件存储方法</h5><p>1、在客户端上删除数据，并umount所有挂载</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@lsy</span> <span class="hljs-string">~</span> <span class="hljs-number">10</span><span class="hljs-string">:24:55]#</span> <span class="hljs-string">rm</span> <span class="hljs-string">/mnt/*</span> <span class="hljs-string">-rf</span><br><span class="hljs-string">[root@lsy</span> <span class="hljs-string">~</span> <span class="hljs-number">10</span><span class="hljs-string">:25:04]#</span><br><span class="hljs-string">[root@lsy</span> <span class="hljs-string">~</span> <span class="hljs-number">10</span><span class="hljs-string">:25:05]#</span> <span class="hljs-string">umount</span> <span class="hljs-string">/mnt/</span><br><span class="hljs-string">[root@lsy</span> <span class="hljs-string">~</span> <span class="hljs-number">10</span><span class="hljs-string">:25:09]#</span> <span class="hljs-string">df</span> <span class="hljs-string">-Th</span><br><span class="hljs-string">Filesystem</span>              <span class="hljs-string">Type</span>      <span class="hljs-string">Size</span>  <span class="hljs-string">Used</span> <span class="hljs-string">Avail</span> <span class="hljs-string">Use%</span> <span class="hljs-string">Mounted</span> <span class="hljs-string">on</span><br><span class="hljs-string">/dev/mapper/centos-root</span> <span class="hljs-string">xfs</span>        <span class="hljs-string">47G</span>  <span class="hljs-number">3.</span><span class="hljs-string">6G</span>   <span class="hljs-string">44G</span>   <span class="hljs-number">8</span><span class="hljs-string">%</span> <span class="hljs-string">/</span><br><span class="hljs-string">devtmpfs</span>                <span class="hljs-string">devtmpfs</span>  <span class="hljs-string">475M</span>     <span class="hljs-number">0</span>  <span class="hljs-string">475M</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">/dev</span><br><span class="hljs-string">tmpfs</span>                   <span class="hljs-string">tmpfs</span>     <span class="hljs-string">487M</span>     <span class="hljs-number">0</span>  <span class="hljs-string">487M</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">/dev/shm</span><br><span class="hljs-string">tmpfs</span>                   <span class="hljs-string">tmpfs</span>     <span class="hljs-string">487M</span>   <span class="hljs-string">14M</span>  <span class="hljs-string">473M</span>   <span class="hljs-number">3</span><span class="hljs-string">%</span> <span class="hljs-string">/run</span><br><span class="hljs-string">tmpfs</span>                   <span class="hljs-string">tmpfs</span>     <span class="hljs-string">487M</span>     <span class="hljs-number">0</span>  <span class="hljs-string">487M</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">/sys/fs/cgroup</span><br><span class="hljs-string">/dev/sda1</span>               <span class="hljs-string">xfs</span>      <span class="hljs-string">1014M</span>  <span class="hljs-string">133M</span>  <span class="hljs-string">882M</span>  <span class="hljs-number">14</span><span class="hljs-string">%</span> <span class="hljs-string">/boot</span><br><span class="hljs-string">tmpfs</span>                   <span class="hljs-string">tmpfs</span>      <span class="hljs-string">98M</span>     <span class="hljs-number">0</span>   <span class="hljs-string">98M</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">/run/user/0</span><br><span class="hljs-string">[root@lsy</span> <span class="hljs-string">~</span> <span class="hljs-number">10</span><span class="hljs-string">:25:11]#</span><br></code></pre></td></tr></tbody></table></figure><p>2、停止所有节点的MDS（只有停掉MDS才可以删除文件系统）</p><figure class="highlight autoit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@ceph1</span> ~]<span class="hljs-meta"># systemctl stop ceph-mds.target </span><br><br>[root<span class="hljs-symbol">@ceph2</span> ~]<span class="hljs-meta"># systemctl stop ceph-mds.target </span><br><br>[root<span class="hljs-symbol">@ceph3</span> ~]<span class="hljs-meta"># systemctl stop ceph-mds.target</span><br></code></pre></td></tr></tbody></table></figure><p>3、回到ceph1删除</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 10:26:48]# ceph  fs rm cephfs --yes-i-really-mean-it<br>[root@ceph1 ceph 10:29:25]# ceph osd<span class="hljs-built_in"> pool </span>delete cephfs_metadata cephfs_metadata --yes-i-really-really-mean-it<br>pool <span class="hljs-string">'cephfs_metadata'</span> removed<br>[root@ceph1 ceph 10:30:04]# ecph osd<span class="hljs-built_in"> pool </span>delete cephfs_pool cephfs_pool --yes-i-really-really-mean-it<br>bash: ecph: command <span class="hljs-keyword">not</span> found<br>[root@ceph1 ceph 10:30:43]# ceph osd<span class="hljs-built_in"> pool </span>delete cephfs_pool cephfs_pool --yes-i-really-really-mean-it<br>pool <span class="hljs-string">'cephfs_pool'</span> removed<br></code></pre></td></tr></tbody></table></figure><p>此时查看装态为err</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">10</span><span class="hljs-string">:26:19]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_ERR</span><br>            <span class="hljs-number">1</span> <span class="hljs-string">filesystem</span> <span class="hljs-string">is</span> <span class="hljs-string">degraded</span><br>            <span class="hljs-number">1</span> <span class="hljs-string">filesystem</span> <span class="hljs-string">has</span> <span class="hljs-string">a</span> <span class="hljs-string">failed</span> <span class="hljs-string">mds</span> <span class="hljs-string">daemon</span><br>            <span class="hljs-number">1</span> <span class="hljs-string">filesystem</span> <span class="hljs-string">is</span> <span class="hljs-string">offline</span><br>            <span class="hljs-string">insufficient</span> <span class="hljs-string">standby</span> <span class="hljs-string">MDS</span> <span class="hljs-string">daemons</span> <span class="hljs-string">available</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">mds:</span> <span class="hljs-string">cephfs-0/1/1</span> <span class="hljs-string">up</span> <span class="hljs-string">,</span> <span class="hljs-number">1</span> <span class="hljs-string">failed</span><br>    <span class="hljs-attr">osd: 4 osds:</span> <span class="hljs-number">4</span> <span class="hljs-string">up,</span> <span class="hljs-number">4</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">2</span> <span class="hljs-string">pools,</span> <span class="hljs-number">192</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">22</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">3.1</span> <span class="hljs-string">KiB</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">4.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">16</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">20</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span>     <span class="hljs-number">192</span> <span class="hljs-string">active+clean</span><br></code></pre></td></tr></tbody></table></figure><p>4、再次启动mds服务</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">32</span>:<span class="hljs-number">34</span>]# systemctl start  ceph-mds.target<br></code></pre></td></tr></tbody></table></figure><p>此时查看状态，又回到健康状态</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@ceph1</span> <span class="hljs-string">ceph</span> <span class="hljs-number">10</span><span class="hljs-string">:32:44]#</span> <span class="hljs-string">ceph</span> <span class="hljs-string">-s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">bb1d01eb-0d72-4794-9d7c-cb692d7a8f34</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">3</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph1,ceph2,ceph3</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph1(active),</span> <span class="hljs-attr">standbys:</span> <span class="hljs-string">ceph2,</span> <span class="hljs-string">ceph3</span><br>    <span class="hljs-attr">osd: 4 osds:</span> <span class="hljs-number">4</span> <span class="hljs-string">up,</span> <span class="hljs-number">4</span> <span class="hljs-string">in</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span>  <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">4.0</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">16</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">20</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span><br></code></pre></td></tr></tbody></table></figure><h5 id="创建ceph块存储">创建ceph块存储</h5><h6 id="1、创建块存储并使用">1、创建块存储并使用</h6><p>1、建立存储池并初始化</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 10:35:32]# ceph osd<span class="hljs-built_in"> pool </span>create rbd_pool 8<br>pool <span class="hljs-string">'rbd_pool'</span> created<br>[root@ceph1 ceph 10:35:47]# rbd<span class="hljs-built_in"> pool </span>init rbd_pool<br></code></pre></td></tr></tbody></table></figure><p>2、创建一个存储卷volume1，大小为5000M</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">06</span>]# rbd  create volume1 --pool rbd_pool --size <span class="hljs-number">5000</span><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35</span>]# rbd ls rbd_pool<br>volume1<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">45</span>]# rbd info volume1 -p rbd_pool<br>rbd image <span class="hljs-string">'volume1'</span>:<br>        size <span class="hljs-number">4.9</span> GiB <span class="hljs-keyword">in</span> <span class="hljs-number">1250</span> objects<br>        order <span class="hljs-number">22</span> (<span class="hljs-number">4</span> MiB objects)<br>        id: <span class="hljs-number">5</span>ed46b8b4567<br>        block_name_prefix: rbd_data<span class="hljs-number">.5</span>ed46b8b4567<br>        format: <span class="hljs-number">2</span><br>        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten<br>        op_features:<br>        flags:<br>        create_timestamp: Tue Apr <span class="hljs-number">21</span> <span class="hljs-number">10</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35</span> <span class="hljs-number">2020</span><br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">38</span>:<span class="hljs-number">03</span>]#<br></code></pre></td></tr></tbody></table></figure><p>4、将创建的卷映射为块设备</p><p>因为rbd镜像的一些特性，OS kernel并不支持，所以映射报错</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 10:39:55]# rbd map rbd_pool/volume1<br>rbd: sysfs write failed<br>RBD image feature <span class="hljs-builtin-name">set</span> mismatch. You can <span class="hljs-builtin-name">disable</span> features unsupported by the kernel with <span class="hljs-string">"rbd feature disable rbd_pool/volume1 object-map fast-diff deep-flatten"</span>.<br><span class="hljs-keyword">In</span> some cases useful <span class="hljs-builtin-name">info</span> is found <span class="hljs-keyword">in</span> syslog - try <span class="hljs-string">"dmesg | tail"</span>.<br>rbd: map failed: (6) <span class="hljs-literal">No</span> such device <span class="hljs-keyword">or</span> address<br>[root@ceph1 ceph 10:40:10]#<br></code></pre></td></tr></tbody></table></figure><p>解决方法：distable相关特性</p><p>（四者之间有先后顺序问题）</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">44</span>:<span class="hljs-number">36</span>]#  rbd feature disable rbd_pool/volume1  fast-diff<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">45</span>:<span class="hljs-number">42</span>]#  rbd feature disable rbd_pool/volume1  object-map<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">45</span>:<span class="hljs-number">45</span>]#  rbd feature disable rbd_pool/volume1  exclusive-lock<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">46</span>:<span class="hljs-number">02</span>]#<br>[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">48</span>:<span class="hljs-number">17</span>]#  rbd feature disable rbd_pool/volume1  deep-flatten<br></code></pre></td></tr></tbody></table></figure><p>再次映射</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">10</span>:<span class="hljs-number">48</span>:<span class="hljs-number">49</span>]# rbd map rbd_pool/volume1<br>/dev/rbd0<br></code></pre></td></tr></tbody></table></figure><p>5、查看映射（如果要取消映射，可以使用rbd unmap /dev/rbd0）</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 10:50:17]# rbd showmapped<br>id<span class="hljs-built_in"> pool </span>    image   snap device<br>0  rbd_pool volume1 -    /dev/rbd0<br>[root@ceph1 ceph 10:50:28]#<br></code></pre></td></tr></tbody></table></figure><p>6、格式化挂载</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 10:50:51]# mkfs.xfs /dev/rbd0<br><span class="hljs-attribute">meta-data</span>=/dev/rbd0              <span class="hljs-attribute">isize</span>=512    <span class="hljs-attribute">agcount</span>=8, <span class="hljs-attribute">agsize</span>=160768 blks<br>         =                       <span class="hljs-attribute">sectsz</span>=512   <span class="hljs-attribute">attr</span>=2, <span class="hljs-attribute">projid32bit</span>=1<br>         =                       <span class="hljs-attribute">crc</span>=1        <span class="hljs-attribute">finobt</span>=0, <span class="hljs-attribute">sparse</span>=0<br>data     =                       <span class="hljs-attribute">bsize</span>=4096   <span class="hljs-attribute">blocks</span>=1280000, <span class="hljs-attribute">imaxpct</span>=25<br>         =                       <span class="hljs-attribute">sunit</span>=1024   <span class="hljs-attribute">swidth</span>=1024 blks<br>naming   =version 2              <span class="hljs-attribute">bsize</span>=4096   <span class="hljs-attribute">ascii-ci</span>=0 <span class="hljs-attribute">ftype</span>=1<br>log      =internal log           <span class="hljs-attribute">bsize</span>=4096   <span class="hljs-attribute">blocks</span>=2560, <span class="hljs-attribute">version</span>=2<br>         =                       <span class="hljs-attribute">sectsz</span>=512   <span class="hljs-attribute">sunit</span>=8 blks, <span class="hljs-attribute">lazy-count</span>=1<br>realtime =none                   <span class="hljs-attribute">extsz</span>=4096   <span class="hljs-attribute">blocks</span>=0, <span class="hljs-attribute">rtextents</span>=0<br>[root@ceph1 ceph 10:51:03]# mount /dev/rbd0  /mnt/<br>df[root@ceph1 ceph 10:51:15]# df -Th |tail -1<br>/dev/rbd0               xfs       4.9G   33M  4.9G   1% /mnt<br>[root@ceph1 ceph 10:51:24]#<br></code></pre></td></tr></tbody></table></figure><p>补充：第二个客户端如果也要用此块存储，只需要执行以下几步就可以</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph2 yum.repos.d <span class="hljs-number">10</span>:<span class="hljs-number">52</span>:<span class="hljs-number">45</span>]# rbd  map rbd_pool/volume1<br>/dev/rbd0<br>[<span class="hljs-symbol">root@</span>ceph2 yum.repos.d <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">03</span>]# rbd showmapped<br>id pool     image   snap device<br><span class="hljs-number">0</span>  rbd_pool volume1 -    /dev/rbd0<br>[<span class="hljs-symbol">root@</span>ceph2 yum.repos.d <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">10</span>]# mount /dev/rbd0 /mnt/<br>[<span class="hljs-symbol">root@</span>ceph2 yum.repos.d <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">24</span>]# df -Th |tail <span class="hljs-number">-1</span><br>/dev/rbd0               xfs       <span class="hljs-number">4.9</span>G   <span class="hljs-number">33</span>M  <span class="hljs-number">4.9</span>G   <span class="hljs-number">1</span>% /mnt<br>[<span class="hljs-symbol">root@</span>ceph2 yum.repos.d <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">31</span>]#<br></code></pre></td></tr></tbody></table></figure><p>注意：块存储是不能实现同读和同写的，请不要两个客户端同时挂载进行读写。</p><h6 id="2、删除块存储方法">2、删除块存储方法</h6><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph2 yum.repos.d 10:53:31]# umount /mnt/<br>[root@ceph2 yum.repos.d 10:55:03]# rbd unmap /dev/rbd0<br>[root@ceph2 yum.repos.d 10:55:15]# ceph osd<span class="hljs-built_in"> pool </span>delete rbd_pool rbd_pool --yes-i-really-really-mean-it<br>pool <span class="hljs-string">'rbd_pool'</span> removed<br>[root@ceph2 yum.repos.d 10:55:54]#<br></code></pre></td></tr></tbody></table></figure><h5 id="创建对象存储网关">创建对象存储网关</h5><p>rgw(对象存储网关)：为客户端访问对象存储的接口</p><p>rgw的创建</p><p>1、在ceph集群任意一个节点上创建rgw(我这里为ceph1)</p><p>确保你已经装了这个软件包</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">37</span>]# yum install -y ceph-radosgw<br></code></pre></td></tr></tbody></table></figure><p>创建rgw</p><figure class="highlight angelscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>ceph1 ceph <span class="hljs-number">11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">37</span>]# ceph-deploy rgw create ceph1<br></code></pre></td></tr></tbody></table></figure><p>2、验证7480端口</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@ceph1 ceph 11:11:25]# lsof -i:7480<br>COMMAND    PID<span class="hljs-built_in"> USER </span>  FD  <span class="hljs-built_in"> TYPE </span> DEVICE SIZE/OFF NODE NAME<br>radosgw 121388 ceph   41u  IPv4 1625237      0t0  TCP *:7480 (LISTEN)<br></code></pre></td></tr></tbody></table></figure><p>对象网关创建成功，后面的项目中我们会通过ceph1的对象网关来连接就可以使用了。</p><p>连接的地址为10.0.0.5:7480</p><h5 id="小结与说明：">小结与说明：</h5><p>我们实现了ceph集群，并创建了三中类型存储，那么如何使用这些存储呢？</p><p>在不同的场景与应用中，会需要不同类型的存储类型，并不是说在一个项目里要把三中类型都用到</p><p>在后面的项目中，我们会分别用到这三种不同的类型。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>KVM虚拟化</title>
      <link href="/2020/05/18/kvm/"/>
      <url>/2020/05/18/kvm/</url>
      
        <content type="html"><![CDATA[<h1>1.什么是云计算</h1><p>云计算是一种按量付费的模式<br>云计算底层时通过虚拟化技术实现的</p><h1>2.云计算的服务类型</h1><p>2.1 IAAS 基础设施即服务(infrastructure as an service) 虚拟机 ecs openstack</p><p>PAAS 平台即服务(platform as an service ) php，java docker容器 +k8s</p><p>SAAS 软件即服务(software as an service ) 企业邮箱服务 cdn服务 rds数据库 开发+运维</p><p>![微信截图_20200108190223](D:\Program Files\Typora\图片\微信截图_20200108190223.png)</p><h1>3.为什么要使用云计算</h1><p>小公司：前期投入小   风险小   扩展灵活<br>大公司：闲置服务器资源，出租（超卖–128G的内存可以卖300台1G.因为所有人买了1G的服务器，但是不一定都会使用，所以可以将其闲置的给别人用，也就是双十一的时候，阿里云服务器总是会给你迁移</p><p>补充：<br>公有云：谁都可以租<br>私有云：只有公司内部使用（安全）<br>混合云：有自己的私有云 + 租的公有云</p><h1>4.云计算的基础 – KVM虚拟化</h1><p>宿主机：内存4G+ 纯净的系统CentOS-7</p><p>ps：模板机导入，模板机优化看同目录下视频</p><p>模板机导入报错，点击重试就可以了</p><p>![QQ图片20200108111513](D:\Program Files\Typora\图片\QQ图片20200108111513.png)</p><h2 id="4-1什么是虚拟化">4.1什么是虚拟化</h2><p>通过模拟计算机的硬件，来实现在同一台计算机上同时运行多个不同的操作系统的技术</p><h2 id="4-2虚拟化软件">4.2虚拟化软件</h2><p>qemu软件纯模拟全虚拟化软件，完全利用软件模拟硬件。特别慢，兼容性好<br>xen（半虚拟化软件）一部分硬件，一部分软件  需要用专门修改之后的内核，兼容性差</p><p>KVM  全虚拟机KVM：Kernel-based Virtual Machine。硬件cpu支持，内核中的一个模块。centos6以后，kvm性能较好，兼容较好</p><h2 id="4-3安装kvm虚拟化管理工具">4.3安装kvm虚拟化管理工具</h2><table><thead><tr><th style="text-align:left">主机名</th><th style="text-align:left">ip地址</th><th style="text-align:left">内存</th><th style="text-align:left">虚拟机</th></tr></thead><tbody><tr><td style="text-align:left">kvm01</td><td style="text-align:left">10.0.0.11</td><td style="text-align:left">4G(后期调整到2G)</td><td style="text-align:left">cpu开启vt虚拟化</td></tr><tr><td style="text-align:left">kvm02</td><td style="text-align:left">10.0.0.12</td><td style="text-align:left">2G</td><td style="text-align:left">cpu开启vt虚拟化</td></tr></tbody></table><p>![微信截图_20200108192254](D:\Program Files\Typora\图片\微信截图_20200108192254.png)</p><ul><li>yum install libvirt virt-install qemu-kvm -y<ul><li>libvirt 作用：虚拟机的管理软件 libvirt: kvm,xen,qemu,lxc…</li><li>virt virt-install virt-clone 作用：虚拟机的安装工具和克隆工具</li><li>qemu-kvm qemu-img (qcow2,raw)作用：管理虚拟机的虚拟磁盘</li></ul></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#使用老师的yum源</span><br><span class="hljs-comment">#如果是其他环境可以将 /etc/hosts 文件注释就可以找到阿里云了</span><br>rm -fr /etc/yum.repos.d/local.repo <br><span class="hljs-built_in">echo</span> <span class="hljs-string">'192.168.16.200 mirrors.aliyun.com'</span> &gt;&gt;/etc/hosts<br>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br><br>yum install libvirt virt-install qemu-kvm -y<br>[root@oldboy ~]<span class="hljs-comment"># rpm -qa libvirt</span><br>libvirt-4.5.0-23.el7_7.3.x86_64<br></code></pre></td></tr></tbody></table></figure><h2 id="4-4安装一台kvm虚拟机-磁盘-配置文件">4.4安装一台kvm虚拟机(磁盘+配置文件)</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#启动虚拟化软件</span><br>systemctl start libvirtd.service <br>systemctl <span class="hljs-built_in">enable</span> libvirtd.service<br><br><span class="hljs-comment">#下载并上传虚拟机镜像到/opt目录下</span><br>[root@kvm01 ~]<span class="hljs-comment"># ls /opt</span><br>CentOS-7-x86_64-Minimal-1908.iso<br><br><span class="hljs-comment">#10.0.0.11 宿主机</span><br><span class="hljs-comment">#虚拟机的名字不能够重复，磁盘的名字也不能够重复</span><br><span class="hljs-comment">#建议虚拟机内存不要低于1024M，否则安装系统特别慢！</span><br>virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /opt/centos2.raw,format=raw,size=10 --cdrom /opt/CentOS-7-x86_64-DVD-1708.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole<br><br><span class="hljs-comment">##在执行这一串命令的时候会遇到的坑</span><br><span class="hljs-comment">#第一个错误：opt下没有镜像文件，或者版本不一致，看好版本和目录就性</span><br><span class="hljs-comment">#第二个错误：</span><br>ERROR    Failed to connect socket to <span class="hljs-string">'/var/run/libvirt/libvirt-sock'</span>: No such file or directory<br><span class="hljs-comment">##原因是服务没有启动</span><br>systemctl start libvirtd.service <br>systemctl <span class="hljs-built_in">enable</span> libvirtd.service<br><br>--virt-type kvm    虚拟化的类型(qemu)<br>--os-type=linux    系统类型<br>--os-variant rhel7 系统版本<br>--name centos7     虚拟机的名字 <br>--memory 1024      虚拟机的内存<br>--vcpus 1          虚拟cpu的核数<br>--disk /opt/centos2.raw,format=raw,size=10<br>--cdrom /opt/CentOS-7-x86_64-DVD-1708.iso <br>--network network=default   使用默认NAT的网络<br>--graphics vnc,listen=0.0.0.0 <br>--noautoconsole<br><br><br><span class="hljs-comment">#安装完成后默认是5900端口</span><br>[root@kvm01 ~]<span class="hljs-comment"># netstat -lntup|grep 5900</span><br>tcp        0      0 0.0.0.0:5900            0.0.0.0:*               LISTEN      26230/qemu-kvm<br></code></pre></td></tr></tbody></table></figure><ul><li><p>以上命令执行完成之后，使用vnc连接到系统图形化界面，安装系统</p></li><li><p>vnc：10.0.0.11:5900   (注意vnc的版本，当前目录下有软件)</p></li><li><p>云主机都没有swap分区，因为本身就是虚拟机中再虚拟出来的，swap是从硬盘分离空间就更慢了![微信截图_20200108194015](D:\Program Files\Typora\图片\微信截图_20200108194015.png)</p></li></ul><p>![微信截图_20200108194032](D:\Program Files\Typora\图片\微信截图_20200108194032.png)</p><ul><li>安装完成之后，修改网卡地址为10.0.0.11  重启网卡就可以登录</li></ul><h2 id="4-5-kvm虚拟机的-font-color-red-virsh-font-日常管理和配置">4.5 kvm虚拟机的<font color="red">virsh</font>日常管理和配置</h2><ul><li><p>virsh list    只显示正在运行的虚拟机</p></li><li><p>virsh list --all    显示全部拥有的虚拟机</p></li><li><p>virsh start centos7    启动虚拟机</p></li><li><p>virsh reboot  centos7  重启虚拟机（有系统）</p></li><li><p>virsh  shutdown  centos7  前提是虚拟机centos7已经安装系统</p></li><li><p>virsh destroy centos7   相当于直接把电源（就是在安装系统出错，无法关机的时候可以使用）</p><ul><li>如果你此时安装系统出错，想要重新安装，注意是不能出现同样的名字的，所以先将centos7删除（先拔电源，再删除）</li><li>virsh destroy centos7</li><li>virsh undefine centos7 （只会删除配置文件，不会删除磁盘）<ul><li>坑：如果此处你不关机，直接删除配置文件，就会导致你看的时候虚拟机时运行的，但是当你使用shutdown 关机的时候，只要你关机，你的虚拟机就找不到了（解决：使用一长串命令重新生成配置文件，或者修改已有的配置文件）</li></ul></li></ul></li><li><p>virsh dumpxml web01 &gt;/opt/vm_web01.xml   虚拟机备份</p></li><li><p>从备份中导入配置  virsh define /opt/vm_web01.xml</p></li><li><p><font color="red">编辑配置文件，不要直接编辑</font></p><ul><li>配置文件目录：ls /etc/libvirt/qemu   （以.xml结尾）</li><li>使用命令编辑（语法检测功能）<ul><li>virsh edit web01<ul><li>修改name名称（一般用专业命令修改）</li><li>删除UUID信息（避免冲突，重启后自动生成）</li><li>编辑磁盘名称、类型 （跟opt目录下一致）</li><li>编辑mac地址  （避免冲突，重启后自动生成）</li></ul></li></ul></li></ul></li><li><p>virsh domrename centos7 web01    重命名虚拟机（低版本不支持）</p></li><li><p>virsh suspend centos7    挂起虚拟机</p><ul><li>注意挂起之后，时间也会暂停，所以需要时间同步</li><li>老师优化机模板里使用的配置文件</li></ul></li></ul><hr><ul><li>virsh resume centos7  恢复挂起的虚拟机</li><li>virsh vncdisplay centos7  查询虚拟机端口<ul><li>此处查询的是短端口，也就是使用10.0.0.11:5900 和 10.0.0.11:0 是同样的效果</li></ul></li><li>virsh autostart centos7  实现虚拟机开机自启动，（也就是宿主重启libvirtd.service 服务后，虚拟就就能启动）<ul><li>实际原理，在ls /etc/libvirt/qemu下生成autostart目录，在目录下创建一个软连接</li><li>如果不使用命令，自己创建一个软连接也没问题</li></ul></li></ul><h2 id="4-6-console-控制台登录">4.6 console 控制台登录</h2><ul><li><p>再console模式里面，不要使用vim编辑，会错乱，先cat，复制到外面，编辑好echo追加</p></li><li><p>登录vnc进去，查看网卡ip</p></li><li><p>通过xshell 下的kvm虚拟机 ssh远程连接到虚拟机</p><ul><li>ssh <a href="mailto:root@192.168.122.153">root@192.168.122.153</a></li></ul></li><li><p>执行命令</p><ul><li>grubby --update-kernel=ALL --args=“console=ttyS0,115200n8”</li><li>reboot</li></ul></li><li><p>登录到 console控制台</p><ul><li>virsh console web01（两次回车）</li></ul></li><li><p>退出console控制台  使用ctrl + ]</p></li></ul><h2 id="4-7kvm虚拟机虚拟磁盘格式和快照管理">4.7kvm虚拟机虚拟磁盘格式和快照管理</h2><ul><li>raw：裸格式，占用空间比较大，不支持快照，不方便传输，读写性能较好<ul><li>总50G   占用50G   传输50G</li></ul></li><li>qcow2： copy on write  占用空间小，<strong>支持快照</strong>，性能比raw差一点，方便传输<ul><li>总50G   占用5G   传输5G</li></ul></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#在安装的时候配置</span><br>virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /opt/centos2.raw,format=raw,size=10 --cdrom /opt/CentOS-7-x86_64-DVD-1708.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole<br><br>virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /data/oldboy.qcow2,format=qcow2,size=10 --cdrom /data/CentOS-7.2-x86_64-DVD-1511.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole<br></code></pre></td></tr></tbody></table></figure><h3 id="4-7-1磁盘工具的常用命令">4.7.1磁盘工具的常用命令</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#查看虚拟磁盘信息</span><br>[root@kvm01 ~]<span class="hljs-comment"># qemu-img info /opt/web01.raw</span><br>image: /opt/web01.raw<br>file format: raw<br>virtual size: 10G (10737418240 bytes)<br>disk size: 1.5G<br><br><span class="hljs-comment">#创建一块qcow2格式的虚拟硬盘</span><br>qemu-img create -f qcow2 /opt/test.qcow2 2G<br><br><span class="hljs-comment">#调整磁盘容量</span><br>qemu-img   resize  /opt/test.qcow2 +20G  <span class="hljs-comment">#在原基础上加20G</span><br>qemu-img   resize  /opt/test.qcow2 20G  <span class="hljs-comment">#直接调整为u20G</span><br><br><span class="hljs-comment">#qcow2的不支持缩容</span><br><span class="hljs-comment">#raw的可以缩容，但你知道就可以了，永远不要使用（防止数据丢失）</span><br><br><br><span class="hljs-comment">#磁盘格式转换  raw转qcow2：</span><br><span class="hljs-comment">#转换完成之后，原来的磁盘还在</span><br>qemu-img convert  -f raw  -O qcow2  oldboy.raw   oldboy.qcow2<br><br><span class="hljs-comment">#要使用新的磁盘，需要编辑配置文件</span><br>virsh destroy web01<br><br>virsh edit web01：<br>&lt;disk <span class="hljs-built_in">type</span>=<span class="hljs-string">'file'</span> device=<span class="hljs-string">'disk'</span>&gt;<br>      &lt;driver name=<span class="hljs-string">'qemu'</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">'qcow2'</span>/&gt;<br>      &lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">'/data/centos2.qcow2'</span>/&gt;<br>      &lt;target dev=<span class="hljs-string">'vda'</span> bus=<span class="hljs-string">'virtio'</span>/&gt;<br>      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x06'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;<br>&lt;/disk&gt;<br><br>virsh start web01<br></code></pre></td></tr></tbody></table></figure><h3 id="4-7-2快照管理（qxow2格式）">4.7.2快照管理（qxow2格式）</h3><ul><li><p>创建快照virsh snapshot-create-as centos7 --name install_ok</p></li><li><p>查看快照virsh snapshot-list centos7</p></li><li><p>还原快照virsh snapshot-revert centos7 --snapshotname 1516574134</p><ul><li>还原之后的时间是快照的时间，注意时间同步</li></ul></li><li><p>删除快照virsh snapshot-delete centos7 --snapshotname 1516636570</p></li><li><p><font color="red">只有qcow2支持做快照，并且快照保存在qcow2的磁盘文件中</font></p></li></ul><h2 id="4-8kvm虚拟机克隆">4.8kvm虚拟机克隆</h2><h3 id="4-8-1完整克隆">4.8.1完整克隆</h3><ul><li><p><strong>克隆的时候不会克隆原有的快照</strong></p></li><li><p>自动挡</p></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># -o 旧的虚拟机    -n新的虚拟机</span><br>virt-clone --auto-clone -o web01 -n web02 (完整克隆)<br></code></pre></td></tr></tbody></table></figure><ul><li>手动挡</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#-c  表示的是压缩克隆</span><br>qemu-img convert -f qcow2 -O qcow2 -c web01.qcow2 web03.qcow2<br>virsh dumpxml web01 &gt;web02.xml<br>vim web02.xml<br><span class="hljs-comment">#修改虚拟机的名字</span><br><span class="hljs-comment">#删除虚拟机uuid</span><br><span class="hljs-comment">#删除mac地址</span><br><span class="hljs-comment">#修改磁盘路径</span><br>virsh define web02.xml <br>virsh start web02<br></code></pre></td></tr></tbody></table></figure><h3 id="4-8-2连接克隆">4.8.2连接克隆</h3><ul><li>生成虚拟机磁盘文件   qemu-img create -f qcow2 -b web03.qcow2 web04.qcow2</li><li>生成虚拟机的配置文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">virsh dumpxml web01 &gt;web03.xml<br>vim web03.xml<br><span class="hljs-comment">#修改虚拟机的名字</span><br>&lt;name&gt;web03&lt;/name&gt;<br><span class="hljs-comment">#删除虚拟机uuid</span><br>&lt;uuid&gt;8e505e25-5175-46ab-a9f6-feaa096daaa4&lt;/uuid&gt;<br><span class="hljs-comment">#删除mac地址</span><br>&lt;mac address=<span class="hljs-string">'52:54:00:4e:5b:89'</span>/&gt;<br><span class="hljs-comment">#修改磁盘路径</span><br>&lt;<span class="hljs-built_in">source</span> file=<span class="hljs-string">'/opt/web03.qcow2'</span>/&gt;<br></code></pre></td></tr></tbody></table></figure><ul><li>导入虚拟机并进行启动测试</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">virsh define web03.xml <br>virsh start web03<br></code></pre></td></tr></tbody></table></figure><ul><li>全自动连接克隆脚本</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@kvm01 scripts]<span class="hljs-comment"># cat link_clone.sh </span><br><span class="hljs-meta">#!/bin/bash</span><br>old_vm=<span class="hljs-variable">$1</span><br>new_vm=<span class="hljs-variable">$2</span><br><span class="hljs-comment">#a：生成虚拟机磁盘文件</span><br>old_disk=`virsh dumpxml <span class="hljs-variable">$old_vm</span>|grep <span class="hljs-string">"&lt;source file"</span>|awk -F<span class="hljs-string">"'"</span> <span class="hljs-string">'{print $2}'</span>`<br>disk_tmp=`dirname <span class="hljs-variable">$old_disk</span>`<br>qemu-img create -f qcow2 -b <span class="hljs-variable">$old_disk</span>  <span class="hljs-variable">${disk_tmp}</span>/<span class="hljs-variable">${new_vm}</span>.qcow2<br><span class="hljs-comment">#b：生成虚拟机的配置文件</span><br>virsh dumpxml <span class="hljs-variable">$old_vm</span> &gt;/tmp/<span class="hljs-variable">${new_vm}</span>.xml<br><span class="hljs-comment">#修改虚拟机的名字</span><br>sed -ri <span class="hljs-string">"s#(&lt;name&gt;)(.*)(&lt;/name&gt;)#\1<span class="hljs-variable">${new_vm}</span>\3#g"</span> /tmp/<span class="hljs-variable">${new_vm}</span>.xml<br><span class="hljs-comment">#删除虚拟机uuid</span><br>sed -i <span class="hljs-string">'/&lt;uuid&gt;/d'</span> /tmp/<span class="hljs-variable">${new_vm}</span>.xml<br><span class="hljs-comment">#删除mac地址</span><br>sed -i <span class="hljs-string">'/&lt;mac address/d'</span> /tmp/<span class="hljs-variable">${new_vm}</span>.xml<br><span class="hljs-comment">#修改磁盘路径</span><br>sed -ri <span class="hljs-string">"s#(&lt;source file=')(.*)('/&gt;)#\1<span class="hljs-variable">${disk_tmp}</span>/<span class="hljs-variable">${new_vm}</span>.qcow2\3#g"</span> /tmp/<span class="hljs-variable">${new_vm}</span>.xml<br><span class="hljs-comment">#c：导入虚拟机并进行启动测试</span><br>virsh define /tmp/<span class="hljs-variable">${new_vm}</span>.xml<br>virsh start <span class="hljs-variable">${new_vm}</span><br></code></pre></td></tr></tbody></table></figure><h2 id="4-9kvm虚拟机的桥接网络">4.9kvm虚拟机的桥接网络</h2><p>默认的虚拟机网络是NAT模式 网段192.168.122.0/24</p><ul><li>虚拟机上网原理<ul><li>桥接模式的话，就是创建一个交换机，所有的虚拟机，都会连接到交换机</li><li>虚拟机每有一块网卡，就会有一个vnet</li><li>宿主机通过br0网卡 也会连接到交换机才出去</li><li>eth0网卡在你生成桥接后。就没有网卡地址，此处只是一个连接作用</li><li>不需要内核转发也可以实现</li></ul></li><li>NAT与桥接可以共存<ul><li>在创建虚拟机的时候可以选择使用哪种网络模式</li><li>nat是通过宿主机的virbr网卡上网 192.168.122.1（网关）</li><li>此处想要上网。<strong>需要内核转发</strong>，nat转换成外网地址</li></ul></li></ul><p>![QQ图片20200109121531](D:\Program Files\Typora\图片\QQ图片20200109121531.jpg)</p><h3 id="4-9-1创建桥接网卡">4.9.1创建桥接网卡</h3><p>创建桥接网卡命令 virsh iface-bridge eth0 br0</p><p>取消桥接网卡命令 virsh iface-unbridge br0</p><h3 id="4-9-2新虚拟机使用桥接模式">4.9.2新虚拟机使用桥接模式</h3><ul><li>默认NAT模式</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 1024 --vcpus 1 --disk /opt/web04.qcow2 --boot hd --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole<br></code></pre></td></tr></tbody></table></figure><ul><li>桥接模式</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 1024 --vcpus 1 --disk /data/web04.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole<br></code></pre></td></tr></tbody></table></figure><ul><li>问题：虚拟机获取不到ip地址</li></ul><p>![微信截图_20200109194456](D:\Program Files\Typora\图片\微信截图_20200109194456.png)</p><h3 id="4-9-3将已有虚拟机网络修改为桥接模式">4.9.3将已有虚拟机网络修改为桥接模式</h3><ul><li>关机  virsh destroy centos7</li><li>修改虚拟机配置文件</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">vir edit centos7<br>&lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'bridge'</span>&gt;<br>&lt;<span class="hljs-built_in">source</span> bridge=<span class="hljs-string">'br0'</span>&gt;<br></code></pre></td></tr></tbody></table></figure><ul><li>启动虚拟机，测试虚拟机网络<ul><li>如果上层没有开启dhcp,需要手动配置ip地址</li></ul></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> <span class="hljs-string">'TYPE="Ethernet"</span><br><span class="hljs-string">BOOTPROTO="static"</span><br><span class="hljs-string">NAME="eth0"</span><br><span class="hljs-string">DEVICE="eth0"</span><br><span class="hljs-string">ONBOOT="yes"</span><br><span class="hljs-string">DNS1="180.76.76.76"</span><br><span class="hljs-string">IPADDR="10.0.0.88"</span><br><span class="hljs-string">NETMASK="255.255.255.0"</span><br><span class="hljs-string">GATEWAY="10.0.0.254"'</span> &gt;/etc/sysconfig/network-scripts/ifcfg-eth0<br></code></pre></td></tr></tbody></table></figure><ul><li>重启网卡，本地测试连接<ul><li>systemctl restart network</li></ul></li></ul><h2 id="4-10热添加技术">4.10热添加技术</h2><ul><li>硬盘   网卡  内存  cpu</li></ul><h3 id="4-10-1-kvm热添加硬盘">4.10.1 kvm热添加硬盘</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#临时生效</span><br>virsh attach-disk web01 /data/web01-add.qcow2 vdb --subdriver qcow2<br><span class="hljs-comment">#永久生效</span><br>virsh attach-disk web01 /data/web01-add.qcow2 vdb --subdriver qcow2 --config<br><span class="hljs-comment">#临时剥离硬盘</span><br>virsh detach-disk web01 vdb<br><span class="hljs-comment">#永久剥离硬盘</span><br>virsh detach-disk web01 vdb --config<br><br><br><span class="hljs-comment">#创建硬盘</span><br>[root@kvm01 ~]<span class="hljs-comment"># qemu-img create -f qcow2 /opt/add_web05.qcow2 2G</span><br>Formatting <span class="hljs-string">'/opt/add_web05.qcow2'</span>, fmt=qcow2 size=2147483648 encryption=off cluster_size=65536 lazy_refcounts=off <br>[root@kvm01 ~]<span class="hljs-comment"># virsh attach-disk web05 /opt/add_web05.qcow2 vdb --subdriver qcow2</span><br>Disk attached successfully<br><br><span class="hljs-comment">#进入虚拟机格式化硬盘</span><br>fdisk 查看是否添加成功<br>[root@localhost ~]<span class="hljs-comment"># mkfs.xfs /dev/vdb</span><br>meta-data=/dev/vdb               isize=512    agcount=4, agsize=131072 blks<br>         =                       sectsz=512   attr=2, projid32bit=1<br>         =                       crc=1        finobt=0, sparse=0<br>data     =                       bsize=4096   blocks=524288, imaxpct=25<br>         =                       sunit=0      swidth=0 blks<br>naming   =version 2              bsize=4096   ascii-ci=0 ftype=1<br><span class="hljs-built_in">log</span>      =internal <span class="hljs-built_in">log</span>           bsize=4096   blocks=2560, version=2<br>         =                       sectsz=512   sunit=0 blks, lazy-count=1<br>realtime =none                   extsz=4096   blocks=0, rtextents=0<br>[root@localhost ~]<span class="hljs-comment"># mount /dev/vdb /mnt</span><br>[root@localhost ~]<span class="hljs-comment"># df -h</span><br>Filesystem      Size  Used Avail Use% Mounted on<br>devtmpfs        486M     0  486M   0% /dev<br>tmpfs           496M     0  496M   0% /dev/shm<br>tmpfs           496M  6.8M  489M   2% /run<br>tmpfs           496M     0  496M   0% /sys/fs/cgroup<br>/dev/vda1        10G  1.3G  8.8G  13% /<br>tmpfs           100M     0  100M   0% /run/user/0<br>/dev/vdb        2.0G   33M  2.0G   2% /mnt<br><br><br><span class="hljs-comment">#磁盘扩容</span><br><span class="hljs-comment">#卸载</span><br>[root@localhost ~]<span class="hljs-comment"># umount /mnt</span><br><span class="hljs-comment">#剥离硬盘</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh detach-disk web05 vdb</span><br>Disk detached successfully<br><span class="hljs-comment">#硬盘扩容</span><br>[root@kvm01 ~]<span class="hljs-comment"># qemu-img resize /opt/add_web05.qcow2 12G</span><br>Image resized.<br>[root@kvm01 ~]<span class="hljs-comment"># virsh attach-disk web05 /opt/add_web05.qcow2 vdb --subdriver qcow2</span><br>Disk attached successfully<br><br><br><span class="hljs-comment">#重新挂载，使用xfs_growfs更新扩容盘</span><br><span class="hljs-comment">#看到最后一行blocks发生变化，表示成功</span><br>[root@localhost ~]<span class="hljs-comment"># xfs_growfs /dev/vdb</span><br>xfs_growfs: /dev/vdb is not a mounted XFS filesystem<br>[root@localhost ~]<span class="hljs-comment"># mount /dev/vdb /mnt</span><br>[root@localhost ~]<span class="hljs-comment"># xfs_growfs /dev/vdb</span><br>meta-data=/dev/vdb               isize=512    agcount=4, agsize=131072 blks<br>         =                       sectsz=512   attr=2, projid32bit=1<br>         =                       crc=1        finobt=0 spinodes=0<br>data     =                       bsize=4096   blocks=524288, imaxpct=25<br>         =                       sunit=0      swidth=0 blks<br>naming   =version 2              bsize=4096   ascii-ci=0 ftype=1<br><span class="hljs-built_in">log</span>      =internal               bsize=4096   blocks=2560, version=2<br>         =                       sectsz=512   sunit=0 blks, lazy-count=1<br>realtime =none                   extsz=4096   blocks=0, rtextents=0<br>data blocks changed from 524288 to 3145728<br>[root@localhost ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></tbody></table></figure><h3 id="4-10-2kvm虚拟机在线热添加网卡">4.10.2kvm虚拟机在线热添加网卡</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#直接添加就ok</span><br><span class="hljs-comment">#network  网卡类型</span><br><span class="hljs-comment">#永久添加 --config</span><br>[root@kvm01 ~]<span class="hljs-comment">#  virsh attach-interface web01 network default --config</span><br><br><span class="hljs-comment">#虚拟机查看会有一块ens的网卡</span><br>[root@localhost network-scripts]<span class="hljs-comment"># ip addr</span><br>3: ens9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:55:3a:5d brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.122.107/24 brd 192.168.122.255 scope global noprefixroute dynamic ens9<br>       valid_lft 3597sec preferred_lft 3597sec<br>    inet6 fe80::bafc:c758:2dfa:28c2/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>[root@localhost network-scripts]<span class="hljs-comment"># </span><br><span class="hljs-comment">#此处网卡的名称不是eth，因为使用的网卡类型（公司）不一样，通过配置文件可以看到</span><br>virsh edit web01<br>    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'bridge'</span>&gt;<br>      &lt;mac address=<span class="hljs-string">'52:54:00:93:0a:a8'</span>/&gt;<br>      &lt;<span class="hljs-built_in">source</span> bridge=<span class="hljs-string">'br0'</span>/&gt;<br>      &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">'virtio'</span>/&gt;<br>      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x03'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;<br>    &lt;/interface&gt;<br>    &lt;interface <span class="hljs-built_in">type</span>=<span class="hljs-string">'network'</span>&gt;<br>      &lt;mac address=<span class="hljs-string">'52:54:00:01:6f:e0'</span>/&gt;<br>      &lt;<span class="hljs-built_in">source</span> network=<span class="hljs-string">'default'</span>/&gt;<br>      &lt;model <span class="hljs-built_in">type</span>=<span class="hljs-string">'rtl8139'</span>/&gt;<br>      &lt;address <span class="hljs-built_in">type</span>=<span class="hljs-string">'pci'</span> domain=<span class="hljs-string">'0x0000'</span> bus=<span class="hljs-string">'0x00'</span> slot=<span class="hljs-string">'0x09'</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">'0x0'</span>/&gt;<br>    &lt;/interface&gt;<br><br><span class="hljs-comment">#给虚拟机添加一块eth的网卡（加上model type的类型就ok）</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh attach-interface web01 network default --model virtio</span><br>[root@localhost network-scripts]<span class="hljs-comment"># ip addr</span><br>4: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether 52:54:00:95:62:56 brd ff:ff:ff:ff:ff:ff<br>    inet6 fe80::3a85:5dff:1b9c:5f98/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><br><br><span class="hljs-comment">#卸载网卡</span><br><span class="hljs-comment">#写上网卡类型 network ，但是会有两块同样类型网卡，所以需要指定mac地址</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh detach-interface web01 network</span><br>error: Domain has 2 interfaces. Please specify <span class="hljs-built_in">which</span> one to detach using --mac<br>error: Failed to detach interface<br><br>[root@kvm01 ~]<span class="hljs-comment"># virsh detach-interface web01 network --mac 52:54:00:55:3a:5d</span><br>Interface detached successfully<br></code></pre></td></tr></tbody></table></figure><h3 id="4-10-3kvm虚拟机在线热添加内存">4.10.3kvm虚拟机在线热添加内存</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#当前内存1G，可以减少，无法增加</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh setmem web01 512M</span><br><br>[root@kvm01 ~]<span class="hljs-comment"># virsh setmem web01 2048M</span><br>error: invalid argument: cannot <span class="hljs-built_in">set</span> memory higher than max memory<br><br><br><span class="hljs-comment">#原因：在刚开始的时候，设置了最大内存，现在已经最大了</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh edit web05</span><br>&lt;domain <span class="hljs-built_in">type</span>=<span class="hljs-string">'kvm'</span>&gt;<br>  &lt;name&gt;web05&lt;/name&gt;<br>  &lt;uuid&gt;c2201c1e-f0f0-4862-8d07-ad498d72ead5&lt;/uuid&gt;<br>  &lt;memory unit=<span class="hljs-string">'KiB'</span>&gt;1048576&lt;/memory&gt;<br>  &lt;currentMemory unit=<span class="hljs-string">'KiB'</span>&gt;1048576&lt;/currentMemory&gt;<br><br><br><span class="hljs-comment">#如何调整，关机调整最大内存</span><br><span class="hljs-comment">#不能超过宿主机内存</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh destroy web01</span><br>Domain web01 destroyed<br>[root@kvm01 ~]<span class="hljs-comment"># virsh setmaxmem web01 --size 2048</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh start web01</span><br><br><br><span class="hljs-comment">#创建虚拟机时配置参数</span><br>virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 512,maxmemory=2048 --vcpus 1 --disk /data/web04.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole<br></code></pre></td></tr></tbody></table></figure><h3 id="4-10-4kvm虚拟机在线热添加cpu">4.10.4kvm虚拟机在线热添加cpu</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#配置之前</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh edit web05</span><br>  &lt;vcpu placement=<span class="hljs-string">'static'</span>&gt;1&lt;/vcpu&gt;   <span class="hljs-comment">#只有1核</span><br><br>[root@localhost ~]<span class="hljs-comment"># lscpu|head -5</span><br>Architecture:          x86_64<br>CPU op-mode(s):        32-bit, 64-bit<br>Byte Order:            Little Endian<br>CPU(s):                1   <span class="hljs-comment">#1核</span><br>On-line CPU(s) list:   0<br><br><br><span class="hljs-comment">#关机调整cpu核数，再添加</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh destroy web05</span><br>Domain web05 destroyed<br>[root@kvm01 ~]<span class="hljs-comment"># virsh setvcpus web05  --maximum 4 --config</span><br><br><span class="hljs-comment">#调整完成后</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh edit web05</span><br>  &lt;vcpu placement=<span class="hljs-string">'static'</span> current=<span class="hljs-string">'1'</span>&gt;4&lt;/vcpu&gt;   <span class="hljs-comment">#现在1核，最大4核</span><br>[root@kvm01 ~]<span class="hljs-comment"># virsh start web05</span><br>Domain web05 started<br>[root@kvm01 ~]<span class="hljs-comment"># virsh setvcpus web05 2</span><br>[root@localhost ~]<span class="hljs-comment"># lscpu|head -5</span><br>Architecture:          x86_64<br>CPU op-mode(s):        32-bit, 64-bit<br>Byte Order:            Little Endian<br>CPU(s):                2<br>On-line CPU(s) list:   0,1<br><br><br><span class="hljs-comment">#注意：只能热添加，减少需要关机</span><br><br>[root@kvm01 ~]<span class="hljs-comment"># virsh setvcpus web05 1</span><br>error: unsupported configuration: failed to find appropriate hotpluggable vcpus to reach the desired target vcpu count<br></code></pre></td></tr></tbody></table></figure><h2 id="4-11virt-manager和kvm虚拟机热迁移-共享的网络文件系统">4.11virt-manager和kvm虚拟机热迁移(共享的网络文件系统)</h2><ul><li>注意迁移的概念，就是迁移过去，原来的虚拟机不要了<ul><li>冷迁移：迁移完成 ，确保无误之后，删除源文件</li><li>热迁移：运行状态直接迁移过去（迁移完成之后，原虚拟机删除，新虚拟机会自动运行）</li></ul></li></ul><h3 id="4-11-1冷迁移-kvm虚拟机-配置文件-磁盘文件">4.11.1冷迁移  kvm虚拟机:配置文件,磁盘文件</h3><ul><li><p>准备另外一台宿主机**，开启cpu虚拟化功能**</p></li><li><p>更新yum源，下载需要软件</p><ul><li>yum install libvirt virt-install  qemu-kvm -y</li></ul></li><li><p>启动软件服务</p><ul><li>[root@kvm02 ~]# systemctl start libvirtd.service</li><li>[root@kvm02 ~]# systemctl enable libvirtd.service</li></ul></li><li><p>创建桥接网卡（环境要求一致）</p><ul><li>virsh iface-bridge eth0 br0</li></ul></li><li><p>传送磁盘文件 和 配置文件</p><ul><li>如果是完整虚拟机，传输磁盘文件和配置文件</li><li>如果是连接克隆虚拟机，传输磁盘文件，<strong>和原磁盘文件</strong> 配置文件</li></ul></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@kvm01 ~]<span class="hljs-comment"># cd /opt</span><br>[root@kvm01 opt]<span class="hljs-comment"># scp -rp web05.qcow2 web03.qcow2 root@10.0.0.12:/opt</span><br><br>[root@kvm01 opt]<span class="hljs-comment"># virsh dumpxml web05 &gt;vm_web05.xml</span><br>[root@kvm01 opt]<span class="hljs-comment"># scp -rp vm_web05.xml root@10.0.0.12:/opt</span><br></code></pre></td></tr></tbody></table></figure><ul><li>最后从kvm02上导入，启动虚拟机</li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@kvm02 ~]<span class="hljs-comment"># cd /opt</span><br>[root@kvm02 opt]<span class="hljs-comment"># ll</span><br>total 1506120<br>-rw-r--r-- 1 root root       4189 Jan  9 17:11 vm_web05.xml<br>-rw------- 1 root root 1532821504 Jan  9 10:09 web03.qcow2<br>-rw-r--r-- 1 root root    9437184 Jan  9 16:40 web05.qcow2<br>[root@kvm02 opt]<span class="hljs-comment"># virsh define vm_web05.xml </span><br>Domain web05 defined from vm_web05.xml<br>[root@kvm02 opt]<span class="hljs-comment"># virsh start web05</span><br>Domain web05 started<br><br><span class="hljs-comment">#登录进去，看到桥接网段，则成功</span><br>[root@kvm02 opt]<span class="hljs-comment"># virsh console web05 </span><br>Connected to domain web05<br>Escape character is ^]<br><br>[root@localhost ~]<span class="hljs-comment"># ip addr|grep inet|grep 10.0.0.</span><br>    inet 10.0.0.99/24 brd 10.0.0.255 scope global noprefixroute eth0<br></code></pre></td></tr></tbody></table></figure><h3 id="4-11-2-热迁移kvm虚拟机-配置文件-nfs共享">4.11.2 热迁移kvm虚拟机:配置文件,nfs共享</h3><ul><li><p>原理</p><ul><li>通过nfs实现磁盘文件的共享，然后通过命令实现热迁移</li></ul></li><li><p>环境准备</p></li></ul><table><thead><tr><th style="text-align:left">主机名</th><th style="text-align:left">ip</th><th style="text-align:left">内存</th><th style="text-align:left">网络</th><th style="text-align:left">软件需求</th><th style="text-align:left">虚拟化</th></tr></thead><tbody><tr><td style="text-align:left">kvm01</td><td style="text-align:left">10.0.0.11</td><td style="text-align:left">2G</td><td style="text-align:left">创建br0桥接网卡</td><td style="text-align:left">kvm和nfs</td><td style="text-align:left">开启虚拟化</td></tr><tr><td style="text-align:left">kvm02</td><td style="text-align:left">10.0.0.12</td><td style="text-align:left">2G</td><td style="text-align:left">创建br0桥接网卡</td><td style="text-align:left">kvm和nfs</td><td style="text-align:left">开启虚拟化</td></tr><tr><td style="text-align:left">nfs01</td><td style="text-align:left">10.0.0.31</td><td style="text-align:left">1G</td><td style="text-align:left">无</td><td style="text-align:left">nfs</td><td style="text-align:left">无</td></tr></tbody></table><ul><li>实现nfs共享存储<ul><li>nfs01配置</li><li>kvm01  kvm02配置</li></ul></li></ul><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#三台机器同时安装软件</span><br>yum  install nfs-utils rpcbind  -y<br><br><span class="hljs-comment">#nfs01操作</span><br>[root@nfs01 ~]<span class="hljs-comment"># vim /etc/exports</span><br>/data 10.0.0.0/24(rw,async,no_root_squash,no_all_squash)<br>[root@nfs01 ~]<span class="hljs-comment"># systemctl restart rpcbind</span><br>[root@nfs01 ~]<span class="hljs-comment"># systemctl enable rpcbind</span><br>[root@nfs01 ~]<span class="hljs-comment"># systemctl restart nfs</span><br>[root@nfs01 ~]<span class="hljs-comment"># systemctl enable nfs</span><br>[root@nfs01 ~]<span class="hljs-comment"># mkdir /data</span><br><br><br><span class="hljs-comment">#kvm01操作</span><br>[root@kvm01 vm.bak]<span class="hljs-comment"># #rm -fr /opt/*</span><br>[root@kvm01 vm.bak]<span class="hljs-comment"># #rm -rf /etc/libvirt/qemu/*.xml</span><br><span class="hljs-comment">#注意这个目录里面的network 不能删除</span><br>[root@kvm01 vm.bak]<span class="hljs-comment"># ls /etc/libvirt/qemu/</span><br>networks  web05.xml<br><span class="hljs-comment">#[root@kvm01 ~]# mount -t nfs 10.0.0.31:/data /opt</span><br><br><br><span class="hljs-comment">#kvm02操作</span><br>[root@kvm02 ~]<span class="hljs-comment"># #mv /opt/* /oldboy/</span><br>[root@kvm02 ~]<span class="hljs-comment"># #mount -t nfs 10.0.0.31:/data /opt</span><br>[root@kvm02 ~]<span class="hljs-comment"># #mv /oldboy/* /opt/</span><br><br><br><br><span class="hljs-comment">#最后执行命令，将kvm02上的虚拟机迁移到kvm01</span><br><span class="hljs-comment">#临时迁移</span><br>virsh migrate --live --verbose web02 qemu+ssh://10.0.0.11/system --unsafe<br><span class="hljs-comment">#永久迁移</span><br>virsh migrate --live --verbose web02 qemu+ssh://10.0.0.100/system --unsafe --persistent --undefinesource<br><br><span class="hljs-comment">#在执行迁移的过程中会有报错，配置域名解析</span><br>[root@kvm01 ~]<span class="hljs-comment"># cat /etc/hosts</span><br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.16.200 mirrors.aliyun.com<br>10.0.0.11 kvm01<br>10.0.0.12 kvm02<br></code></pre></td></tr></tbody></table></figure><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>文章模板</title>
      <link href="/2020/05/02/hello-world/"/>
      <url>/2020/05/02/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="这里是刘世亚的又一个博客">这里是刘世亚的又一个博客</h2><h2 id="Quick-Start">Quick Start</h2><h3 id="Create-a-new-post">Create a new post</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">"My New Post"</span><br></code></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server">Run server</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files">Generate static files</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></tbody></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>刘世亚声明文件</title>
      <link href="/2020/05/02/test/"/>
      <url>/2020/05/02/test/</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 刘世亚 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
