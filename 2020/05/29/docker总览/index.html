

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>docker总览 - 刘世亚</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />

  
  <meta name="keywords" content="zhaoo, hexo-theme-zhaoo,"> 
  
  <meta name="description" content="北冥有鱼，其名为鲲，鲲之大，不知其几千里也,1.什么是容器
容器是隔离的环境中运行的一个进程,如果..."> 
  
  <meta name="author" content="刘世亚"> 

  
    <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  
  
    <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  
  
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  
  
    <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_58xq2j9v1id.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css">

  

  <script>
    var CONFIG = window.CONFIG || {}
    CONFIG = {
      fancybox: true,
      pjax: true,
      lazyload: {
        enable: true,
        loadingImage: '/images/theme/loading.gif',
      },
      donate_alipay: 'https://pic.izhaoo.com/alipay.jpg',
      donate_wechat: 'https://pic.izhaoo.com/wechat.jpg',
      gitalk: {
        enable: false,
        clientID: '',
        clientSecret: '',
        id: window.location.pathname,
        repo: '',
        owner: '',
        admin: ''
      },
      motto: {
        api: '',
        default: ''
      },
      galleries: {
        enable: 'true'
      },
      fab: {
        enable: 'true',
        alwaysShow: 'false'
      }
    }
  </script>

  

  
<meta name="generator" content="Hexo 4.2.0"></head>
<body class="lock-screen">
  <div class="loading"></div>
  <nav class="menu">
  <div class="menu-close">
    <i class="iconfont iconplus"></i>
  </div>
  <ul class="menu-content">
    
    
    
    
    <li class="menu-item"><a href="/ "> 首页</a></li>
    
    
    
    
    <li class="menu-item"><a href="/galleries "> 摄影</a></li>
    
    
    
    
    <li class="menu-item"><a href="/archives "> 归档</a></li>
    
    
    
    
    <li class="menu-item"><a href="/tags "> 标签</a></li>
    
    
    
    
    <li class="menu-item"><a href="/categories "> 分类</a></li>
    
    
    
    
    <li class="menu-item"><a href="/about "> 关于</a></li>
    
  </ul>
  <div class="menu-copyright"><p>Copyright© 2019-2020 | <a target="_blank" href="http://www.beian.miit.gov.cn/">京ICP备20015941号</a></p></div>
</nav>
  <main id="main">
  <div class="container" id="container">
    <article class="article">
  <section class="head">
  <img   class="lazyload" data-original="/images/theme/docker.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">docker总览</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>2020-05-29</span
        class="post-info-item">
      
      <span class="post-info-item"><i class="iconfont iconeye"></i><span id="/2020/05/29/docker%E6%80%BB%E8%A7%88/"
          class="leancloud" data-flag-title="docker总览"></span></span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>12242</span>
    </div>
  </div>
</section>
  <section class="main">
    <section class="content">
      <p><strong>1.什么是容器</strong><br>
容器是隔离的环境中运行的一个进程,如果进程结束,容器就会停止,容器的隔离环境,拥有自己的ip地址,系统文件,主机名,进程管理</p>
<p>程序: 代码,软件,命令</p>
<p>进程:正在运行的程序</p>
<p><strong>2:容器和虚拟机的区别</strong><br>
虚拟机: 硬件cpu支持(vt虚拟化),模拟计算硬件,走正常的开机启动</p>
<p>bios开机自检–根据bios启动项–读取硬盘第一个扇区grub,uefi,  centos7, 加载内核,启动系统第一个进程/sbin/init  systemd</p>
<p>容器: 不需要硬件cpu的支持,共用宿主机内核,启动容器的第一个进程</p>
<p>容器优势: 启动快,性能高,损耗少,轻量级</p>
<p>100虚拟机  100个服务     10宿主机</p>
<p>100容器     100个服务      6宿主机</p>
<p><strong>3:docker-ce的安装</strong><br>
主机名  	内存    	ip<br>
docker01	2G	10.0.0.11<br>
docker02	2G	10.0.0.12</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#安装docker-ce</span><br>wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo<br>sed -i <span class="hljs-string">'s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo<br>yum install docker-ce -y<br><br>systemctl <span class="hljs-built_in">enable</span> docker<br>systemctl start docker<br><br><span class="hljs-comment">#验证</span><br>[root@docker01 yum.repos.d]<span class="hljs-comment"># docker version </span><br>Client: Docker Engine - Community<br> Version:           19.03.5<br> API version:       1.40<br> Go version:        go1.12.12<br> Git commit:        633a0ea<br> Built:             Wed Nov 13 07:25:41 2019<br> OS/Arch:           linux/amd64<br> Experimental:      <span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>4:docker主要内容</strong><br>
docker是一个cs架构, docker主要:镜像  容器   仓库  网络  存储   监控</p>
<p>docker是一个软件的打包技术.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run -d  -p 80:80  nginx:latest <br>run 创建并启动一个容器<br>-d  放后台启动<br>-p  端口映射<br>nginx:latest docker镜像名称<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5:docker镜像常用命令</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker search  搜索镜像, 优先选官方,stars数量多<br>docker pull    拉取镜像(下载镜像)，注意版本<br>docker push    推送镜像(上传镜像)<br>docker load    导入镜像<br>   例子: docker load  -i  docker_nginx.tar.gz<br>docker save    导出镜像<br>   例子:docker save centos:7 -o docker_centos7.tar.gz<br>docker image  ls   查看镜像列表<br>docker rmi      删除镜像<br>docker tag      给镜像打标签<br></code></pre></td></tr></tbody></table></figure>
<p><strong>6:docker容器的常用命令</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker  run 创建并启动容器<br>     例子:docker run  -d -it -p 80:80  nginx:latest<br>docker create  创建容器 --name<br>docker start   启动容器<br>docker  stop   停止容器<br>docker  restart 重启容器<br>docker  <span class="hljs-built_in">kill</span>   强制停止容器<br>docker  ps     查看容器列表  -a 查看所有容器<br>docker  rm     删除容器<br>    批量删除所有容器 docker rm -f `docker ps -a -q`<br>docker  <span class="hljs-built_in">exec</span>   进入正在运行的容器(分配一个新终端)<br>       例子: docker <span class="hljs-built_in">exec</span>  -it  容器id/容器名字   /bin/bash(/bin/sh)<br>docker attach  进入正在运行的容器(使用相同的终端),偷偷离开的快捷键ctrl +p,ctrl +q<br></code></pre></td></tr></tbody></table></figure>
<p>容器想要放在后台一直运行的化,那么容器的初始命令,必须夯住(前台运行),否则容器就会退出.</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">前台运行<br>nginx -g <span class="hljs-string">'daemon off;'</span><br>/usr/sbin/php-fpm --nodaemonize<br></code></pre></td></tr></tbody></table></figure>
<p><strong>7:docker端口映射</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run<br>-p  宿主机端口:容器端口<br>-p  宿主机ip1:宿主机端口:容器端口 (多个容器同时使用80端口)<br>-p  宿主机ip1::容器端口   随机端口映射<br>-p  宿主机ip1::容器端口/udp   使用udp协议做随机端口映射<br>-p 80:80  -p 3306:3306<br>-p 1111-1119:1111-1119  端口范围映射<br><br>-P 自动随机端口映射<br></code></pre></td></tr></tbody></table></figure>
<p><strong>8:docker数据卷</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run<br>-v  宿主机绝对目录:容器目录<br>-v  容器目录        <span class="hljs-comment">#创建一个随机卷,来持久化容器的目录下的数据</span><br>-v  卷名:容器目录    <span class="hljs-comment">#创建一个固定名字的卷,来持久化容器的目录下的数据</span><br>--volumes-from  跟某一个容器挂载所有相同的卷<br></code></pre></td></tr></tbody></table></figure>
<p><strong>9:手动制作docker镜像</strong><br>
制作一个基于centos6系统的nginx镜像(单服务)</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">1:启动一个纯净的centos:6.9容器,安装nginx<br>curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>yum install nginx -y<br>2:把安装好服务的容器,提交为镜像<br>docker container commit eb109f194821 centos6.9_nginx:v1<br><br>3:测试镜像的功能<br>docker run -d  -p 82:80 centos6.9_nginx:v1 nginx -g <span class="hljs-string">'daemon off;'</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>制作一个基于centos6系统的kod网盘的镜像(多服务)</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1:启动一个centos6.9_nginx:v1,再安装php<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'192.168.12.201  mirrors.aliyun.com'</span> &gt;&gt;/etc/hosts<br>yum install php-fpm php-gd php-mbstring -y<br>vi /etc/php-fpm.d/www.conf<br>service php-fpm start<br><span class="hljs-built_in">cd</span> /etc/nginx/conf.d/<br>vi default.conf <br>mkdir /html<br><span class="hljs-built_in">cd</span> /html<br>curl -o kodexplorer4.40.zip http://192.168.12.201/191216/kodexplorer4.40.zip<br>yum install unzip -y<br>unzip kodexplorer4.40.zip <br>chown -R nginx:nginx .<br><br>vi /init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><br>service php-fpm start<br>nginx -g <span class="hljs-string">'daemon off;'</span><br><br>2:把安装好服务的容器,提交为镜像<br>docker commit 47208e3e3796 kod:v2<br>3:测试镜像的功能<br>docker run -d -p 83:80 kod:v2 /bin/bash /init.sh<br></code></pre></td></tr></tbody></table></figure>
<p>制作一个基于centos7系统的nginx+sshd双服务镜像</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>yum install nginx -y<br>yum install openssh-server -y<br>yum install initscripts -y<br>/usr/sbin/sshd-keygen<br><span class="hljs-built_in">echo</span> <span class="hljs-string">'123456'</span>|passwd --stdin root<br>/usr/sbin/sshd -D<br>vi /init.sh<br></code></pre></td></tr></tbody></table></figure>
<p><strong>10:自动制作docker镜像</strong><br>
镜像： 中药</p>
<p>dockerfile： 配方</p>
<p>dockerfile常用指令</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM  基础镜像<br>RUN   制作镜像过程中需要的执行命令(安装服务)<br>CMD   容器启动的时候执行的初始命令，容易被替换(启动服务)<br>ENTRYPOINT  容器启动的时候执行的初始命令，不能被替换，如果同时使用CMD和ENTRYPOINT，cmd命令将作为ENTRYPOINT命令的参数<br>ADD   把dockerfile当前目录下的文件拷贝到容器中（自动解压tar包）<br>COPY  把dockerfile当前目录下的文件拷贝到容器中（不解压tar包）<br>WORKDIR 指定容器的默认工作目录<br>EXPOSE  镜像要暴露的端口<br>VOLUME  持久化卷<br>ENV     环境变量(ssh的密码,数据库的密码)<br>LABEL       镜像的属性标签<br>MAINTAINER  管理者标识<br></code></pre></td></tr></tbody></table></figure>
<p>根据dockerfile自动构建镜像的思路</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">a:手动制作docker镜像，记录历史命令<br>b：根据历史命令编写dockerfile文件<br>c：docker build构建docker镜像<br>d：测试镜像的功能<br></code></pre></td></tr></tbody></table></figure>
<p>dockerfile单服务例子1：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:6.9<br>RUN <span class="hljs-built_in">echo</span> <span class="hljs-string">'192.168.19.200  mirrors.aliyun.com'</span> &gt;&gt;/etc/hosts<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo<br>RUN yum install nginx -y<br>CMD [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>]<br></code></pre></td></tr></tbody></table></figure>
<p>dockerfile多服务例子2：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos6.9_nginx:v1<br>RUN yum install php-fpm php-gd php-mbstring -y<br>ADD www.conf /etc/php-fpm.d/www.conf<br>ADD default.conf /etc/nginx/conf.d/default.conf <br>RUN mkdir /html<br>WORKDIR /html<br>RUN curl -o kodexplorer4.40.zip http://192.168.19.200/191127/kodexplorer4.40.zip<br>RUN yum install unzip -y<br>RUN unzip kodexplorer4.40.zip <br>RUN chown -R nginx:nginx .<br>ADD init.sh   /init.sh<br><br>CMD [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br><br>vi /init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><br>service php-fpm start<br>nginx -g <span class="hljs-string">'daemon off;'</span><br></code></pre></td></tr></tbody></table></figure>
<p>dockerfile使用环境变量的例子：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">FROM centos:7<br>RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<br>RUN curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>RUN yum install nginx openssh-server initscripts -y<br>RUN /usr/sbin/sshd-keygen<br>ADD init.sh  /init.sh<br>ENTRYPOINT [<span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/init.sh"</span>]<br><br>vi  init.sh<br><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-variable">$SSH_PWD</span> ];<span class="hljs-keyword">then</span><br>    SSH_PWD=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SSH_PWD</span>|passwd --stdin root<br>nginx<br>/usr/sbin/sshd -D<br></code></pre></td></tr></tbody></table></figure>
<p><strong>11:docker镜像的分层(复用,节省空间)</strong></p>
<p><strong>12:dockerfile的优化</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">a: 使用体积小的linux镜像alpine<br>b：尽可能的清理无用的缓存文件（尽可能把多个RUN合并）<br>c：修改dockerfile的时候，尽可能把修改的内容放在最后<br>d：使用.dockerignore忽略构建docker镜像时，不需要的文件<br></code></pre></td></tr></tbody></table></figure>
<p><strong>13:容器间的互联</strong><br>
docker run  --link 正在运行容器的名字（单方向）</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"> docker run --name mysql-server -it \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -d mysql:5.7 \   <br>      --character-set-server=utf8 --collation-server=utf8_bin<br>     <br>docker run --name zabbix-java-gateway -t \<br>      -d zabbix/zabbix-java-gateway:latest<br>    <br>docker run --name zabbix-server-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      -e ZBX_JAVAGATEWAY=<span class="hljs-string">"zabbix-java-gateway"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-java-gateway:zabbix-java-gateway \<br>      -p 10051:10051 \<br>      -d zabbix/zabbix-server-mysql:latest<br>      <br>docker run --name zabbix-web-nginx-mysql -t \<br>      -e DB_SERVER_HOST=<span class="hljs-string">"mysql-server"</span> \<br>      -e MYSQL_DATABASE=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_USER=<span class="hljs-string">"zabbix"</span> \<br>      -e MYSQL_PASSWORD=<span class="hljs-string">"zabbix_pwd"</span> \<br>      -e MYSQL_ROOT_PASSWORD=<span class="hljs-string">"root_pwd"</span> \<br>      --link mysql-server:mysql \<br>      --link zabbix-server-mysql:zabbix-server \<br>      -p 80:80 \<br>      -d zabbix/zabbix-web-nginx-mysql:latest<br></code></pre></td></tr></tbody></table></figure>
<p><strong>14:单机版的容器编排</strong><br>
yum install  docker-compose   -y(需要epel源)</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">version: <span class="hljs-string">'3'</span><br><br>services:<br>   mysql-server:<br>     image: mysql:5.7<br>     restart: always<br>     environment:<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>     <span class="hljs-built_in">command</span>: --character-set-server=utf8 --collation-server=utf8_bin<br>     <br>   zabbix-java-gateway:<br>     image: zabbix/zabbix-java-gateway:latest<br>     restart: always<br>     <br>   zabbix-server:<br>     depends_on:<br>       - mysql-server<br>     image: zabbix/zabbix-server-mysql:latest<br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br>       ZBX_JAVAGATEWAY: zabbix-java-gateway<br>     ports:<br>       - <span class="hljs-string">"10051:10051"</span><br>       <br>   zabbix-web-nginx-mysql:<br>     depends_on:<br>       - zabbix-server<br>     image: zabbix/zabbix-web-nginx-mysql:latest<br>     ports:<br>       - <span class="hljs-string">"80:80"</span><br>     restart: always<br>     environment:<br>       DB_SERVER_HOST: mysql-server<br>       MYSQL_DATABASE: zabbix<br>       MYSQL_USER: zabbix<br>       MYSQL_PASSWORD: zabbix_pwd<br>       MYSQL_ROOT_PASSWORD: root_pwd<br></code></pre></td></tr></tbody></table></figure>
<p>docker-compose  up  -d    启动服务</p>
<p>docker-compose  down   停止服务</p>
<p><strong>15:私有仓库docker-registry</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#启动私有仓库</span><br>docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry<br><br><span class="hljs-comment">#镜像地址</span><br>nginx:1.15        官方仓库的官方镜像<br>nginx/nginx:1.15  官方仓库的用户镜像<br><br>daocloud.io/nginx/nginx:1.15  私有仓库的镜像<br><br><span class="hljs-comment">#上传镜像</span><br>docker tag alpine:3.9 10.0.0.11:5000/alpine:3.9<br>docker image push 10.0.0.11:5000/alpine:3.9<br><span class="hljs-comment">#第一次上传镜像会报错</span><br>vim /etc/docker/daemon.json<br>{<br>  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.docker-cn.com"</span>],<br>  <span class="hljs-string">"insecure-registries"</span>: [<span class="hljs-string">"10.0.0.11:5000"</span>]<br>}<br><br>systemctl  restart docker<br><br>docker image push 10.0.0.11:5000/alpine:3.9<br><br><br><span class="hljs-comment">#下载镜像</span><br>docker image pull 10.0.0.11:5000/alpine:3.9<br></code></pre></td></tr></tbody></table></figure>
<p><strong>16: 企业级私有仓库harbor(docker-compose)</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载安装器</span><br>https://github.com/goharbor/harbor/releases/download/v1.10.0/harbor-offline-installer-v1.10.0.tgz<br><span class="hljs-comment">#解压</span><br>[root@docker01 opt]<span class="hljs-comment"># tar xf harbor-offline-installer-v1.8.0.tgz </span><br><span class="hljs-comment">#修改配置文件</span><br><span class="hljs-built_in">cd</span>  harbor<br>vim harbor.yml<br>hostname: 10.0.0.12<br>harbor_admin_password: 123456<br><span class="hljs-comment">#执行安装脚本</span><br> ./install.sh<br><br>为harbor配置https证书<br><br><span class="hljs-comment">#修改harbor.yml</span><br><span class="hljs-comment">#配置域名</span><br>hostname: blog.oldqiang.com<br><br><span class="hljs-comment">#配置证书</span><br>https:<br>  port: 443<br>  certificate: /opt/certs/nginx/1_blog.oldqiang.com_bundle.crt<br>  private_key: /opt/certs/nginx/2_blog.oldqiang.com.key<br><br><span class="hljs-comment">#重新执行安装脚本</span><br>./install.sh<br></code></pre></td></tr></tbody></table></figure>
<p><strong>17:docker基础网络</strong><br>
四种基础网络类型</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">bridge  默认类型 NAT模式<br>host    host类型，使用宿主机网络，网络性能最高<br>container 容器类型。使用其他容器共用网络，k8s中使用<br>none    没有网络，上不了外网<br></code></pre></td></tr></tbody></table></figure>
<p>创建自定义网络</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker network create -d bridge --subnet 172.18.0.0/16 --gateway 172.18.0.1 oldqiang<br></code></pre></td></tr></tbody></table></figure>
<p><strong>18:跨宿主机容器间的通讯之macvlan</strong><br>
macvlan类似与虚拟机的桥接网络</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建网络</span><br>docker network create -d macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1<br><br><span class="hljs-comment">#启动容器</span><br>docker run -it --network macvlan_1 --ip 10.0.0.105 alpine:3.9<br></code></pre></td></tr></tbody></table></figure>
<p><strong>19:跨宿主机容器间的通讯之overlay</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker03上： consul存储ip地址的分配<br>docker run -d -p 8500:8500 -h consul --name consul progrium/consul -server -bootstrap<br><br>docker01、02上：<br>vim  /etc/docker/daemon.json<br>{<br>  <span class="hljs-string">"cluster-store"</span>: <span class="hljs-string">"consul://10.0.0.13:8500"</span>,<br>  <span class="hljs-string">"cluster-advertise"</span>: <span class="hljs-string">"10.0.0.11:2376"</span><br>}<br><br>systemctl restart docker<br><br>2）创建overlay网络<br>docker network create -d overlay --subnet 172.26.0.0/16 --gateway 172.26.0.1  ol1<br><br>3）启动容器测试<br>docker run -it --network ol1 --name oldboy01  alpine:3.9  /bin/sh<br>每个容器有两块网卡,eth0实现容器间的通讯,eth1实现容器访问外网<br></code></pre></td></tr></tbody></table></figure>
<p><strong>20:docker容器的监控</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#客户端节点</span><br><span class="hljs-comment">#启动node-exporter</span><br>docker run -d   -p 9100:9100   -v <span class="hljs-string">"/:/host:ro,rslave"</span>   --name=node_exporter   quay.io/prometheus/node-exporter   --path.rootfs /host<br><br><span class="hljs-comment">#启动cadvisor</span><br>docker run --volume=/:/rootfs:ro  --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro  --publish=8080:8080 --detach=<span class="hljs-literal">true</span> --name=cadvisor google/cadvisor:latest<br><br><span class="hljs-comment">#prometheus节点</span><br>安装prometheus和grafana<br> tar xf prometheus-2.12.0.linux-amd64.tar.gz <br><br> <span class="hljs-built_in">cd</span> prometheus-2.12.0.linux-amd64/<br><br>vim prometheus.yml <br>scrape_configs:<br>  - job_name: <span class="hljs-string">'prometheus'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'localhost:9090'</span>]<br>  - job_name: <span class="hljs-string">'cadvisor'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'10.0.0.11:8080'</span>,<span class="hljs-string">'10.0.0.12:8080'</span>]<br>  - job_name: <span class="hljs-string">'node_exporter'</span><br>    static_configs:<br>    - targets: [<span class="hljs-string">'10.0.0.11:9100'</span>,<span class="hljs-string">'10.0.0.12:9100'</span>]<br><br>./prometheus --config.file=<span class="hljs-string">"prometheus.yml"</span> <br><br><span class="hljs-comment">#安装grafana</span><br>yum localinstall grafana-6.3.3-1.x86_64.rpm -y<br>systemctl start grafana-server.service <br>systemctl <span class="hljs-built_in">enable</span> grafana-server.service<br><span class="hljs-comment">#访问grafana  http://IP:3000，默认账号admin:admin</span><br>新建数据源--导入dashboard模板<br></code></pre></td></tr></tbody></table></figure><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
    </section>
    <section class="extra">
      
        <section class="donate">
  <div class="qrcode">
    <img   class="lazyload" data-original="https://pic.izhaoo.com/alipay.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
      
      
      
<nav class="nav">
  
  
    <a href="/2020/05/29/%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94/">容器互联<i class="iconfont iconright"></i></a>
  
</nav>

    </section>
    
  </section>
</article>
  </div>
</main>
  <footer class="footer">
  <div class="footer-social">
    
    
    
    
    
    <a href="tencent://message/?Menu=yes&uin=2573514647 " target="_blank" onMouseOver="this.style.color= '#12B7F5'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  iconQQ "></i>
    </a>
    
    
    
    
    
    <a href="https://github.com/LiuShiYa-github/LiuShiYa-github.github.io " target="_blank" onMouseOver="this.style.color= '#24292E'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  icongithub-fill "></i>
    </a>
    
  </div>
  <div class="footer-copyright"><p>Copyright© 2019-2020 | <a target="_blank" href="http://www.beian.miit.gov.cn/">京ICP备20015941号</a></p></div>
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  <div class="fab fab-menu">
    <i class="iconfont iconmenu"></i>
  </div>
  
</body>


<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>






<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>






<script src="https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>






<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>






<script src="https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js"></script>




<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.1.0/dist/av-min.js"></script>
<script>
  AV.init({
    appId: '',
    appKey: '',
    serverURLs: '',
  });

  function showCount(Counter) {
    $(".leancloud").each(function (e) {
      (function (e) {
        var url = $(".leancloud").eq(e).attr('id').trim();
        var query = new AV.Query("Counter");
        query.equalTo("words", url);
        query.count().then(function (number) {
          $(".leancloud").eq(e).text(number ? number : '--');
        }, function (error) {});
      })(e)
    })
  }

  function addCount(Counter) {
    var url = $(".leancloud").length === 1 ? $(".leancloud").attr('id').trim() : 'https://LiuShiYa-github.github.io';
    var Counter = AV.Object.extend("Counter");
    var query = new Counter;
    query.save({
      words: url
    }).then(function (object) {})
  }
  
  $(function () {
    var Counter = AV.Object.extend("Counter");
    addCount(Counter);
    showCount(Counter);
  });
</script>



<script src="/js/script.js"></script>



<script>
  (function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>











</html>